{% extends "base.html" %}

{% block title %}Relatório de Saldos - Sistema de Gestão Financeira{% endblock %}

{% block page_title %}Relatório de Saldos{% endblock %}

{% block content %}
<style>
    /* Fix: Permitir que o conteúdo do relatório de saldos tenha altura natural e seja scrollável */
    .conteudo .container-fluid {
        display: block !important;
        min-height: unset !important;
    }

    .conteudo-row {
        display: block !important;
        min-height: unset !important;
        flex: unset !important;
    }

    .w-100-important {
        width: 100% !important;
        min-width: 100% !important;
    }

    .table-fixed {
        table-layout: fixed;
        width: 100% !important;
    }
</style>
<!-- Filtros de Período -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-filter me-2"></i>Filtro de Data de Referência
                </h5>
            </div>
            <div class="card-body">
                <form method="GET" action="{{ url_for('relatorio_saldos') }}" class="row g-3"
                    id="form-relatorio-saldos">
                    <div class="col-md-6">
                        <label for="data_referencia" class="form-label">Data de Referência</label>
                        <input type="text" class="form-control" id="data_referencia" name="data_referencia"
                            value="{{ data_referencia }}" placeholder="dd/mm/aaaa">
                        <small class="text-muted">Os saldos serão calculados considerando todos os lançamentos até esta
                            data</small>
                    </div>
                    <div class="col-md-6 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary me-2" data-no-intercept>
                            <i class="fas fa-search me-1"></i>Filtrar
                        </button>
                        <a href="{{ url_for('relatorio_saldos') }}" class="btn btn-secondary" data-no-intercept>
                            <i class="fas fa-times me-1"></i>Limpar
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Mensagem quando não houver dados E não houver filtros aplicados -->
{% if total_entradas == 0 and total_saidas == 0 and total_entradas_pendentes == 0 and total_saidas_pendentes == 0 and
not data_referencia %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="alert alert-info">
            <h5><i class="fas fa-info-circle me-2"></i>Nenhum dado encontrado!</h5>
            <p class="mb-3">Para visualizar o relatório de saldos, você precisa ter:</p>
            <div class="row">
                <div class="col-md-4">
                    <ul class="mb-3">
                        <li><strong>Lançamentos financeiros</strong> cadastrados</li>
                        <li><strong>Plano de Contas</strong> configurado</li>
                        <li><strong>Contas Caixa</strong> ativas</li>
                    </ul>
                </div>
                <div class="col-md-8">
                    <div class="d-flex gap-2 flex-wrap">
                        <a href="{{ url_for('novo_lancamento') }}" class="btn btn-primary btn-sm">
                            <i class="fas fa-plus me-1"></i> Criar Lançamento
                        </a>
                        <a href="{{ url_for('plano_contas') }}" class="btn btn-success btn-sm">
                            <i class="fas fa-sitemap me-1"></i> Plano de Contas
                        </a>
                        <a href="{{ url_for('nova_conta_caixa') }}" class="btn btn-info btn-sm">
                            <i class="fas fa-university me-1"></i> Nova Conta Caixa
                        </a>
                        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary btn-sm">
                            <i class="fas fa-home me-1"></i> Ir para Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Mensagem quando filtro aplicado mas sem dados -->
{% if total_entradas == 0 and total_saidas == 0 and total_entradas_pendentes == 0 and total_saidas_pendentes == 0 and
data_referencia %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="alert alert-warning">
            <h5><i class="fas fa-info-circle me-2"></i>Nenhuma transação encontrada no período selecionado</h5>
            <p class="mb-0">O relatório abaixo mostra valores zerados. Tente ajustar o filtro de período ou <a
                    href="{{ url_for('relatorio_saldos') }}" class="alert-link">limpar os filtros</a>.</p>
        </div>
    </div>
</div>
{% endif %}

<!-- PAINEL PRINCIPAL DE SALDOS -->
<div class="row mb-4">
    <!-- Saldos Realizados -->
    <div class="col-md-4 mb-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-success text-white">
                <h6 class="mb-0"><i class="fas fa-check-circle me-2"></i>Saldo Realizado</h6>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between mb-2">
                    <span>Entradas Realizadas:</span>
                    <span class="text-success fw-bold">R$ {{ "%.2f"|format(total_entradas) }}</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span>Saídas Realizadas:</span>
                    <span class="text-danger fw-bold">R$ {{ "%.2f"|format(total_saidas) }}</span>
                </div>
                <hr>
                <div class="d-flex justify-content-between">
                    <span class="fw-bold">Saldo Líquido:</span>
                    <span class="fw-bold fs-5 {{ 'text-success' if saldo_geral >= 0 else 'text-danger' }}">
                        R$ {{ "%.2f"|format(saldo_geral) }}
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Saldos Vencidos -->
    <div class="col-md-4 mb-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-danger text-white">
                <h6 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Saldo Vencido</h6>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between mb-2">
                    <span>Entradas Vencidas (a receber):</span>
                    <span class="text-danger fw-bold">R$ {{ "%.2f"|format(total_entradas_vencidas) }}</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span>Saídas Vencidas (a pagar):</span>
                    <span class="text-danger fw-bold">R$ {{ "%.2f"|format(total_saidas_vencidas) }}</span>
                </div>
                <hr>
                <div class="d-flex justify-content-between">
                    <span class="fw-bold">Saldo Vencido Líquido:</span>
                    <span class="fw-bold fs-5 {{ 'text-success' if saldo_vencido >= 0 else 'text-danger' }}">
                        R$ {{ "%.2f"|format(saldo_vencido) }}
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Saldo Projetado -->
    <div class="col-md-4 mb-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header" style="background: linear-gradient(135deg, #1976d2, #1565c0); color: white;">
                <h6 class="mb-0"><i class="fas fa-chart-line me-2"></i>Saldo Projetado</h6>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between mb-2">
                    <span>Total a Receber:</span>
                    <span class="text-primary fw-bold">R$ {{ "%.2f"|format(total_entradas_pendentes) }}</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span>Total a Pagar:</span>
                    <span class="text-warning fw-bold">R$ {{ "%.2f"|format(total_saidas_pendentes) }}</span>
                </div>
                <hr>
                <div class="d-flex justify-content-between">
                    <span class="fw-bold">Saldo Projetado:</span>
                    <span class="fw-bold fs-5 {{ 'text-success' if saldo_projetado >= 0 else 'text-danger' }}">
                        R$ {{ "%.2f"|format(saldo_projetado) }}
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- CARDS DE DETALHAMENTO ENTRADAS vs SAÍDAS -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-dark text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-columns me-2"></i>Demonstrativo Detalhado - Entradas vs Saídas
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="w-100">
                    <table class="table table-hover mb-0 table-fixed">
                        <thead class="table-dark">
                            <tr>
                                <th class="text-center" style="width:25%">Status</th>
                                <th class="text-end" style="width:25%">Entradas</th>
                                <th class="text-end" style="width:25%">Saídas</th>
                                <th class="text-end" style="width:25%">Saldo</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="text-center"><span class="badge bg-success">Realizado</span></td>
                                <td class="text-end text-success fw-bold">R$ {{ "%.2f"|format(total_entradas) }}</td>
                                <td class="text-end text-danger fw-bold">R$ {{ "%.2f"|format(total_saidas) }}</td>
                                {% set saldo_realizado = total_entradas - total_saidas %}
                                <td
                                    class="text-end fw-bold {{ 'text-success' if saldo_realizado >= 0 else 'text-danger' }}">
                                    R$ {{ "%.2f"|format(saldo_realizado) }}</td>
                            </tr>
                            <tr>
                                <td class="text-center"><span class="badge bg-warning text-dark">A Vencer</span></td>
                                <td class="text-end text-success">R$ {{ "%.2f"|format(total_entradas_a_vencer) }}</td>
                                <td class="text-end text-danger">R$ {{ "%.2f"|format(total_saidas_a_vencer) }}</td>
                                {% set saldo_a_vencer = total_entradas_a_vencer - total_saidas_a_vencer %}
                                <td
                                    class="text-end fw-bold {{ 'text-success' if saldo_a_vencer >= 0 else 'text-danger' }}">
                                    R$ {{ "%.2f"|format(saldo_a_vencer) }}</td>
                            </tr>
                            <tr class="table-danger">
                                <td class="text-center"><span class="badge bg-danger">Vencido</span></td>
                                <td class="text-end text-success">R$ {{ "%.2f"|format(total_entradas_vencidas) }}</td>
                                <td class="text-end text-danger">R$ {{ "%.2f"|format(total_saidas_vencidas) }}</td>
                                <td
                                    class="text-end fw-bold {{ 'text-success' if saldo_vencido >= 0 else 'text-danger' }}">
                                    R$ {{ "%.2f"|format(saldo_vencido) }}</td>
                            </tr>
                            <tr>
                                <td class="text-center"><span class="badge bg-info">Agendado</span></td>
                                <td class="text-end text-success">R$ {{ "%.2f"|format(total_entradas_agendadas) }}</td>
                                <td class="text-end text-danger">R$ {{ "%.2f"|format(total_saidas_agendadas) }}</td>
                                {% set saldo_agendado = total_entradas_agendadas - total_saidas_agendadas %}
                                <td
                                    class="text-end fw-bold {{ 'text-success' if saldo_agendado >= 0 else 'text-danger' }}">
                                    R$ {{ "%.2f"|format(saldo_agendado) }}</td>
                            </tr>
                        </tbody>
                        <tfoot class="table-dark">
                            <tr>
                                <td class="text-center fw-bold">TOTAL GERAL</td>
                                <td class="text-end fw-bold text-success">R$ {{ "%.2f"|format(total_entradas +
                                    total_entradas_pendentes) }}</td>
                                <td class="text-end fw-bold text-danger">R$ {{ "%.2f"|format(total_saidas +
                                    total_saidas_pendentes) }}</td>
                                <td
                                    class="text-end fw-bold {{ 'text-success' if saldo_projetado >= 0 else 'text-danger' }}">
                                    R$ {{ "%.2f"|format(saldo_projetado) }}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- SALDOS POR CONTA DO PLANO DE CONTAS -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card border-0 shadow-sm overflow-hidden">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center py-3">
                <h5 class="card-title mb-0">
                    <i class="fas fa-sitemap me-2"></i>Saldos por Conta do Plano de Contas
                </h5>
                <span class="badge bg-light text-primary px-3 py-2">Por Período Filtrado</span>
            </div>
            <div class="card-body p-0">
                {% if categorias_receitas or categorias_despesas %}
                <div class="row g-0">
                    <!-- Receitas -->
                    <div class="col-md-6 border-end">
                        <div class="p-3 bg-light border-bottom">
                            <h6 class="mb-0 text-success"><i class="fas fa-arrow-up me-2"></i>Contas de Receita</h6>
                        </div>
                        <div class="w-100">
                            <table class="table table-sm table-hover align-middle mb-0 table-fixed">
                                <thead class="bg-light text-muted text-uppercase" style="font-size: 0.75rem;">
                                    <tr>
                                        <th style="width:30%">Conta</th>
                                        <th class="text-end" style="width:17%">Realizado</th>
                                        <th class="text-end" style="width:17%">A Vencer</th>
                                        <th class="text-end" style="width:17%">Vencido</th>
                                        <th class="text-end" style="width:19%">Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% if categorias_receitas %}
                                    {% for nome, valores in categorias_receitas.items() %}
                                    <tr>
                                        <td class="small">{{ nome }}</td>
                                        <td class="text-end text-success small">R$ {{ "%.2f"|format(valores.realizado)
                                            }}</td>
                                        <td class="text-end text-warning small">R$ {{ "%.2f"|format(valores.a_vencer) }}
                                        </td>
                                        <td class="text-end text-danger small">R$ {{ "%.2f"|format(valores.vencido) }}
                                        </td>
                                        {% set total_conta = valores.realizado + valores.a_vencer + valores.vencido +
                                        valores.agendado %}
                                        <td class="text-end fw-bold text-success small">R$ {{ "%.2f"|format(total_conta)
                                            }}</td>
                                    </tr>
                                    {% endfor %}
                                    {% else %}
                                    <tr>
                                        <td colspan="5" class="text-center text-muted py-3">
                                            <i class="fas fa-inbox me-2"></i>Nenhuma conta de receita encontrada
                                        </td>
                                    </tr>
                                    {% endif %}
                                </tbody>
                                <tfoot class="table-light fw-bold">
                                    <tr>
                                        <td>TOTAL RECEITAS</td>
                                        <td class="text-end text-success">R$ {{ "%.2f"|format(total_receitas_realizadas)
                                            }}</td>
                                        <td class="text-end text-warning">R$ {{ "%.2f"|format(total_receitas_a_vencer)
                                            }}</td>
                                        <td class="text-end text-danger">R$ {{ "%.2f"|format(total_receitas_vencidas) }}
                                        </td>
                                        <td class="text-end text-success">R$ {{ "%.2f"|format(total_receitas_realizadas
                                            + total_receitas_a_vencer + total_receitas_vencidas +
                                            total_receitas_agendadas) }}</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>

                    <!-- Despesas -->
                    <div class="col-md-6">
                        <div class="p-3 bg-light border-bottom">
                            <h6 class="mb-0 text-danger"><i class="fas fa-arrow-down me-2"></i>Contas de Despesa</h6>
                        </div>
                        <div class="w-100">
                            <table class="table table-sm table-hover align-middle mb-0 table-fixed">
                                <thead class="bg-light text-muted text-uppercase" style="font-size: 0.75rem;">
                                    <tr>
                                        <th style="width:30%">Conta</th>
                                        <th class="text-end" style="width:17%">Realizado</th>
                                        <th class="text-end" style="width:17%">A Vencer</th>
                                        <th class="text-end" style="width:17%">Vencido</th>
                                        <th class="text-end" style="width:19%">Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% if categorias_despesas %}
                                    {% for nome, valores in categorias_despesas.items() %}
                                    <tr>
                                        <td class="small">{{ nome }}</td>
                                        <td class="text-end text-success small">R$ {{ "%.2f"|format(valores.realizado)
                                            }}</td>
                                        <td class="text-end text-warning small">R$ {{ "%.2f"|format(valores.a_vencer) }}
                                        </td>
                                        <td class="text-end text-danger small">R$ {{ "%.2f"|format(valores.vencido) }}
                                        </td>
                                        {% set total_conta = valores.realizado + valores.a_vencer + valores.vencido +
                                        valores.agendado %}
                                        <td class="text-end fw-bold text-danger small">R$ {{ "%.2f"|format(total_conta)
                                            }}</td>
                                    </tr>
                                    {% endfor %}
                                    {% else %}
                                    <tr>
                                        <td colspan="5" class="text-center text-muted py-3">
                                            <i class="fas fa-inbox me-2"></i>Nenhuma conta de despesa encontrada
                                        </td>
                                    </tr>
                                    {% endif %}
                                </tbody>
                                <tfoot class="table-light fw-bold">
                                    <tr>
                                        <td>TOTAL DESPESAS</td>
                                        <td class="text-end text-success">R$ {{ "%.2f"|format(total_despesas_realizadas)
                                            }}</td>
                                        <td class="text-end text-warning">R$ {{ "%.2f"|format(total_despesas_a_vencer)
                                            }}</td>
                                        <td class="text-end text-danger">R$ {{ "%.2f"|format(total_despesas_vencidas) }}
                                        </td>
                                        <td class="text-end text-danger">R$ {{ "%.2f"|format(total_despesas_realizadas +
                                            total_despesas_a_vencer + total_despesas_vencidas +
                                            total_despesas_agendadas) }}</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="text-center text-muted py-5">
                    <i class="fas fa-inbox fa-3x mb-3"></i>
                    <p>Nenhuma transação encontrada no período selecionado</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- SALDOS DAS CONTAS CAIXA DETALHADOS -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card border-0 shadow-sm overflow-hidden">
            <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center py-3">
                <h5 class="card-title mb-0">
                    <i class="fas fa-university me-2"></i>Saldos das Contas Caixa - Detalhamento
                </h5>
                <span class="badge bg-primary px-3 py-2">Total Consolidado: R$ {{ "%.2f"|format(saldo_total_caixa)
                    }}</span>
            </div>
            <div class="card-body p-0">
                {% if contas_caixa_detalhadas %}
                <div class="w-100">
                    <table class="table table-hover align-middle mb-0 table-fixed">
                        <thead class="bg-light text-muted text-uppercase small">
                            <tr>
                                <th class="ps-4">Conta / Banco</th>
                                <th>Tipo</th>
                                <th class="text-end">Saldo Realizado</th>
                                <th class="text-end">Pendentes (Entradas)</th>
                                <th class="text-end">Pendentes (Saídas)</th>
                                <th class="text-end pe-4">Saldo Projetado</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in contas_caixa_detalhadas %}
                            <tr>
                                <td class="ps-4">
                                    <div class="d-flex align-items-center">
                                        <div class="rounded-circle bg-light p-2 me-3 text-primary">
                                            <i class="fas fa-wallet"></i>
                                        </div>
                                        <div>
                                            <div class="fw-bold text-dark">{{ item.conta.nome }}</div>
                                            <div class="small text-muted text-truncate" style="max-width: 150px;">{{
                                                item.conta.banco or 'Banco não informado' }}</div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    {% if item.conta.tipo == 'conta_corrente' %}
                                    <span
                                        class="badge rounded-pill bg-soft-primary text-primary border border-primary">CC</span>
                                    {% elif item.conta.tipo == 'poupanca' %}
                                    <span
                                        class="badge rounded-pill bg-soft-success text-success border border-success">PO</span>
                                    {% elif item.conta.tipo == 'caixa_fisico' %}
                                    <span
                                        class="badge rounded-pill bg-soft-warning text-warning border border-warning">DI</span>
                                    {% else %}
                                    <span
                                        class="badge rounded-pill bg-soft-secondary text-secondary border border-secondary">OT</span>
                                    {% endif %}
                                </td>
                                <td
                                    class="text-end fw-bold {{ 'text-success' if item.saldo_atual >= 0 else 'text-danger' }}">
                                    R$ {{ "%.2f"|format(item.saldo_atual) }}
                                </td>
                                <td class="text-end">
                                    <span class="text-success small"><i class="fas fa-arrow-up me-1"></i>R$ {{
                                        "%.2f"|format(item.rec_a_vencer + item.rec_vencido + item.rec_agendado)
                                        }}</span>
                                </td>
                                <td class="text-end">
                                    <span class="text-danger small"><i class="fas fa-arrow-down me-1"></i>R$ {{
                                        "%.2f"|format(item.desp_a_vencer + item.desp_vencido + item.desp_agendado)
                                        }}</span>
                                </td>
                                <td class="text-end pe-4">
                                    <div
                                        class="fw-bold {{ 'text-success' if item.saldo_projetado >= 0 else 'text-danger' }} fs-6">
                                        R$ {{ "%.2f"|format(item.saldo_projetado) }}
                                    </div>
                                    <div class="small text-muted" style="font-size: 0.75rem;">Projeção final</div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-university fa-3x text-muted mb-3 opacity-25"></i>
                    <h6 class="text-muted">Nenhuma conta caixa ativa no período</h6>
                    <a href="{{ url_for('nova_conta_caixa') }}" class="btn btn-sm btn-outline-primary mt-2">
                        <i class="fas fa-plus me-1"></i>Adicionar Conta
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- RELATÓRIO CONSOLIDADO POR CATEGORIA -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card border-0 shadow-sm overflow-hidden">
            <div class="card-header bg-dark text-white py-3">
                <h5 class="card-title mb-0">
                    <i class="fas fa-tags me-2"></i>Saldos Detalhados por Categoria (Plano de Contas)
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="w-100">
                    <table class="table table-hover align-middle mb-0 table-fixed">
                        <thead class="bg-light text-muted text-uppercase small">
                            <tr>
                                <th class="ps-4">Categoria / Código</th>
                                <th class="text-end">Realizado</th>
                                <th class="text-end">A Vencer</th>
                                <th class="text-end">Vencido</th>
                                <th class="text-end pe-4">Saldo Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% set todas_categorias = [] %}
                            {% for categoria in categorias_entradas.keys() %}
                            {% if categoria not in todas_categorias %}
                            {% set _ = todas_categorias.append(categoria) %}
                            {% endif %}
                            {% endfor %}
                            {% for categoria in categorias_saidas.keys() %}
                            {% if categoria not in todas_categorias %}
                            {% set _ = todas_categorias.append(categoria) %}
                            {% endif %}
                            {% endfor %}

                            {% for categoria in todas_categorias|sort %}
                            {% set r = categorias_entradas.get(categoria, {'realizado': 0, 'a_vencer': 0, 'vencido': 0,
                            'agendado': 0}) %}
                            {% set d = categorias_saidas.get(categoria, {'realizado': 0, 'a_vencer': 0, 'vencido': 0,
                            'agendado': 0}) %}
                            {% set total_rec = r.realizado + r.a_vencer + r.vencido + r.agendado %}
                            {% set total_desp = d.realizado + d.a_vencer + d.vencido + d.agendado %}
                            {% set saldo_cat = total_rec - total_desp %}

                            {% if total_rec > 0 or total_desp > 0 %}
                            <tr>
                                <td class="ps-4">
                                    <span class="fw-bold">{{ categoria }}</span>
                                </td>
                                <td class="text-end">
                                    <div class="text-success small">Rec: R$ {{ "%.2f"|format(r.realizado) }}</div>
                                    <div class="text-danger small">Desp: R$ {{ "%.2f"|format(d.realizado) }}</div>
                                </td>
                                <td class="text-end">
                                    <div class="text-success small">Rec: R$ {{ "%.2f"|format(r.a_vencer) }}</div>
                                    <div class="text-danger small">Desp: R$ {{ "%.2f"|format(d.a_vencer) }}</div>
                                </td>
                                <td class="text-end">
                                    <div class="text-success small">Rec: R$ {{ "%.2f"|format(r.vencido) }}</div>
                                    <div class="text-danger small">Desp: R$ {{ "%.2f"|format(d.vencido) }}</div>
                                </td>
                                <td class="text-end pe-4">
                                    <span class="fw-bold {{ 'text-success' if saldo_cat >= 0 else 'text-danger' }}">
                                        R$ {{ "%.2f"|format(saldo_cat) }}
                                    </span>
                                </td>
                            </tr>
                            {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ENTRADAS E SAÍDAS POR CATEGORIA LADO A LADO -->
<div class="row mb-4">
    <!-- Entradas por Categoria -->
    <div class="col-md-6 mb-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-success text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-pie me-2"></i>Entradas por Categoria
                </h5>
            </div>
            <div class="card-body p-0">
                {% if categorias_entradas %}
                <div class="w-100">
                    <table class="table table-striped mb-0 table-fixed">
                        <thead>
                            <tr>
                                <th>Categoria</th>
                                <th class="text-end">Realizado</th>
                                <th class="text-end">A Vencer</th>
                                <th class="text-end">Vencido</th>
                                <th class="text-end">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for categoria, dados in categorias_entradas.items() %}
                            {% set total_cat = dados.realizado + dados.a_vencer + dados.vencido + dados.agendado %}
                            <tr>
                                <td>{{ categoria }}</td>
                                <td class="text-end text-success">R$ {{ "%.2f"|format(dados.realizado) }}</td>
                                <td class="text-end text-warning">R$ {{ "%.2f"|format(dados.a_vencer) }}</td>
                                <td class="text-end text-danger">R$ {{ "%.2f"|format(dados.vencido) }}</td>
                                <td class="text-end text-success fw-bold">R$ {{ "%.2f"|format(total_cat) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <h6 class="text-muted">Nenhuma entrada registrada</h6>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Saídas por Categoria -->
    <div class="col-md-6 mb-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-danger text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-pie me-2"></i>Saídas por Categoria
                </h5>
            </div>
            <div class="card-body p-0">
                {% if categorias_saidas %}
                <div class="w-100">
                    <table class="table table-striped mb-0 table-fixed">
                        <thead>
                            <tr>
                                <th>Categoria</th>
                                <th class="text-end">Realizado</th>
                                <th class="text-end">A Vencer</th>
                                <th class="text-end">Vencido</th>
                                <th class="text-end">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for categoria, dados in categorias_saidas.items() %}
                            {% set total_cat = dados.realizado + dados.a_vencer + dados.vencido + dados.agendado %}
                            <tr>
                                <td>{{ categoria }}</td>
                                <td class="text-end text-danger">R$ {{ "%.2f"|format(dados.realizado) }}</td>
                                <td class="text-end text-warning">R$ {{ "%.2f"|format(dados.a_vencer) }}</td>
                                <td class="text-end text-danger">R$ {{ "%.2f"|format(dados.vencido) }}</td>
                                <td class="text-end text-danger fw-bold">R$ {{ "%.2f"|format(total_cat) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <h6 class="text-muted">Nenhuma saida registrada</h6>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- BARRA COMPARATIVA -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-dark text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-bar me-2"></i>Comparativo Entradas vs Saídas
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-success">Entradas (Realizadas)</h6>
                        <div class="progress mb-3" style="height: 25px;">
                            <div class="progress-bar bg-success"
                                style="width: {{ '%.1f'|format((total_entradas / (total_entradas + total_saidas)) * 100) if (total_entradas + total_saidas) > 0 else 0 }}%;">
                                {{ "%.1f"|format((total_entradas / (total_entradas + total_saidas)) * 100 if
                                (total_entradas + total_saidas) > 0 else 0) }}%
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-danger">Saídas (Realizadas)</h6>
                        <div class="progress mb-3" style="height: 25px;">
                            <div class="progress-bar bg-danger"
                                style="width: {{ '%.1f'|format((total_saidas / (total_entradas + total_saidas)) * 100) if (total_entradas + total_saidas) > 0 else 0 }}%;">
                                {{ "%.1f"|format((total_saidas / (total_entradas + total_saidas)) * 100 if
                                (total_entradas + total_saidas) > 0 else 0) }}%
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Botões de Ação -->
<div class="row">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
            <div>
                <a href="{{ url_for('relatorios') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Voltar aos Relatórios
                </a>
            </div>
            <div class="d-flex flex-wrap gap-2">
                <button onclick="window.print()" class="btn btn-primary">
                    <i class="fas fa-print me-2"></i>Imprimir
                </button>
                <a href="{{ url_for('exportar_relatorio_saldos', formato='excel') }}{% if data_inicio %}?data_inicio={{ data_inicio }}&data_fim={{ data_fim }}{% endif %}"
                    class="btn btn-success">
                    <i class="fas fa-file-excel me-2"></i>Exportar Excel
                </a>
                <a href="{{ url_for('exportar_relatorio_saldos', formato='pdf') }}{% if data_inicio %}?data_inicio={{ data_inicio }}&data_fim={{ data_fim }}{% endif %}"
                    class="btn btn-danger">
                    <i class="fas fa-file-pdf me-2"></i>Exportar PDF
                </a>
                <a href="{{ url_for('dashboard') }}" class="btn btn-info">
                    <i class="fas fa-home me-2"></i>Dashboard
                </a>
            </div>
        </div>
    </div>
</div>

<style>
    @media print {

        .btn,
        .navbar,
        .sidebar {
            display: none !important;
        }

        .card {
            border: 1px solid #000 !important;
            break-inside: avoid;
        }
    }

    input[type="text"][pattern] {
        font-family: monospace;
        letter-spacing: 1px;
    }

    .table-responsive {
        max-height: 600px;
        overflow-y: auto;
    }

    .table-responsive::-webkit-scrollbar {
        width: 10px;
        background: #f8f9fa;
    }

    .table-responsive::-webkit-scrollbar-thumb {
        background: #6c757d;
        border-radius: 5px;
    }

    .table-responsive {
        scrollbar-width: thin;
        scrollbar-color: #6c757d #f8f9fa;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const dataReferencia = document.getElementById('data_referencia');

        function aplicarMascaraData(input) {
            if (!input) return;
            input.addEventListener('input', function (e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length >= 2) {
                    value = value.substring(0, 2) + '/' + value.substring(2);
                }
                if (value.length >= 5) {
                    value = value.substring(0, 5) + '/' + value.substring(5, 9);
                }
                e.target.value = value;
            });
        }

        aplicarMascaraData(dataReferencia);
    });
</script>
{% endblock %}