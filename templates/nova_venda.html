{% extends "base.html" %}

{% block title %}Nova Venda - Sistema de Gest√£o Financeira{% endblock %}

{% block page_title %}Nova Venda{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Registrar Nova Venda</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('nova_venda') }}">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="cliente_id" class="form-label">Cliente *</label>
                                <div class="autocomplete-container">
                                    <input type="text" class="form-control" id="cliente_search" name="cliente_search"
                                        placeholder="Digite o nome do cliente..." autocomplete="off" required>
                                    <input type="hidden" id="cliente_id" name="cliente_id" required>
                                    <div class="autocomplete-suggestions" id="cliente_suggestions"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="data_prevista" class="form-label">Data Prevista *</label>
                                <input type="text" class="form-control" id="data_prevista" name="data_prevista"
                                    placeholder="__/__/____" pattern="\d{2}/\d{2}/\d{4}" title="Formato: DD/MM/AAAA"
                                    required>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="data_realizada" class="form-label">Data de Realiza√ß√£o (opcional)</label>
                                <input type="text" class="form-control" id="data_realizada" name="data_realizada"
                                    placeholder="__/__/____" pattern="\d{2}/\d{2}/\d{4}" title="Formato: DD/MM/AAAA">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="nota_fiscal" class="form-label">Nota Fiscal (Opcional)</label>
                                <input type="text" class="form-control" id="nota_fiscal" name="nota_fiscal"
                                    placeholder="N√∫mero da NF">
                                <small class="form-text text-muted">N√∫mero da nota fiscal relacionada</small>
                            </div>
                        </div>
                    </div>

                    <div class="card carrinho-card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0">Carrinho</h6>
                        </div>
                        <div class="card-body">
                            <table class="carrinho-table" id="tabela-itens-venda">
                                <thead>
                                    <tr>
                                        <th>Tipo</th>
                                        <th>Produto ou servi√ßo</th>
                                        <th>Pre√ßo unit√°rio</th>
                                        <th>Quantidade</th>
                                        <th>Desconto</th>
                                        <th>Total</th>
                                    </tr>
                                </thead>
                                <tbody id="itens-body-venda">
                                    <tr class="vendas_linhaItem item-row-venda" linha="1" comitem="nao">
                                        <td>
                                            <div class="btn-group">
                                                <button type="button"
                                                    class="vendas_btnSelTipo btn btn-sm btn-outline-secondary dropdown-toggle"
                                                    data-bs-toggle="dropdown" aria-expanded="false" linha="1"
                                                    valor="produto">
                                                    <i class="fa fa-cubes"></i> Produto
                                                </button>
                                                <ul class="dropdown-menu">
                                                    <li><a class="dropdown-item vendas_selTipo" href="#" linha="1"
                                                            value="produto"><i class="fa fa-cubes"></i> Produto</a></li>
                                                    <li><a class="dropdown-item vendas_selTipo" href="#" linha="1"
                                                            value="servico"><i class="fa fa-wrench"></i> Servi√ßo</a>
                                                    </li>
                                                    <li><a class="dropdown-item vendas_selTipo" href="#" linha="1"
                                                            value="frete"><i class="fa fa-truck"></i> Frete</a></li>
                                                    <li><a class="dropdown-item vendas_selTipo" href="#" linha="1"
                                                            value="saida"><i class="fa fa-money"></i> Outras
                                                            saidas</a></li>
                                                </ul>
                                            </div>
                                            <input type="hidden" name="item_tipo[]" value="produto">
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-start gap-2">
                                                <div class="autocomplete-container flex-grow-1">
                                                    <input type="text" class="form-control form-control-sm item-nome"
                                                        value="" autocomplete="off" name="item_nome[]"
                                                        placeholder="Digite o nome do produto">
                                                    <div class="autocomplete-suggestions item-suggestions"
                                                        style="display:none;"></div>
                                                </div>
                                                <button type="button"
                                                    class="btn btn-outline-secondary btn-sm input-clear-btn btn-clear-nome"
                                                    title="Limpar campo" data-bs-toggle="tooltip">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                            <small class="text-muted d-block mt-1">Observa√ß√µes adicionais
                                                (opcional)</small>
                                            <input type="text" class="form-control form-control-sm mt-1"
                                                name="item_obs[]" placeholder="">
                                        </td>
                                        <td class="text-end">
                                            <input type="number" step="0.01" min="0"
                                                class="form-control form-control-sm text-end" name="item_preco[]"
                                                value="0.00" inputmode="decimal">
                                        </td>
                                        <td class="text-center">
                                            <input type="number" min="1"
                                                class="form-control form-control-sm text-center" name="item_qtd[]"
                                                value="1">
                                        </td>
                                        <td class="text-end">
                                            <input type="number" step="0.01" min="0"
                                                class="form-control form-control-sm text-end" name="item_desconto[]"
                                                value="0.00">
                                        </td>
                                        <td class="text-end">
                                            <input type="text"
                                                class="form-control form-control-sm text-end vendas_totalLinha"
                                                value="0,00" readonly
                                                style="background-color: #f8f9fa; padding-right: 2rem;">
                                            <input type="hidden" name="item_total[]" value="0.00">
                                            <button type="button" class="carrinho-remove-btn vendas_linkRemItem"
                                                title="Remover item do carrinho" data-bs-toggle="tooltip"
                                                style="display:none;">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="3"></td>
                                        <td class="text-end"><strong>Itens:</strong></td>
                                        <td class="text-center"><strong id="itens-contagem-venda">1</strong></td>
                                        <td class="text-end">
                                            <input type="text" class="form-control form-control-sm text-end"
                                                id="carrinho_total_venda" value="0,00" readonly
                                                style="background-color: #f8f9fa; font-weight: 600;">
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                            <div style="padding: 1rem;">
                                <button type="button" id="btn-adicionar-item-venda" class="btn-adicionar-item"
                                    title="Adicionar novo produto/servi√ßo ao carrinho" data-bs-toggle="tooltip">
                                    <i class="fas fa-plus me-1"></i> Adicionar item
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Campos para pagamento -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="tipo_pagamento" class="form-label">Tipo de Pagamento *</label>
                                <select class="form-select" id="tipo_pagamento" name="tipo_pagamento" required>
                                    <option value="a_vista">√Ä Vista</option>
                                    <option value="parcelado">Parcelado</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="numero_parcelas" class="form-label">N√∫mero de Parcelas *</label>
                                <input type="number" min="1" max="24" class="form-control" id="numero_parcelas"
                                    name="numero_parcelas" value="1" required>
                            </div>
                        </div>
                    </div>

                    <!-- Configura√ß√£o de vencimentos das parcelas -->
                    <div id="config_parcelas" style="display: none;">
                        <div class="card border-primary">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>Configura√ß√£o de Vencimentos das
                                    Parcelas</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="primeira_parcela" class="form-label">Data da Primeira
                                                Parcela</label>
                                            <input type="text" class="form-control" id="primeira_parcela"
                                                name="primeira_parcela" placeholder="__/__/____"
                                                pattern="\d{2}/\d{2}/\d{4}" title="Formato: DD/MM/AAAA">
                                            <small class="form-text text-muted">Data de vencimento da primeira
                                                parcela</small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="intervalo_parcelas" class="form-label">Periodicidade das
                                                Parcelas</label>
                                            <select class="form-select" id="intervalo_parcelas"
                                                name="intervalo_parcelas">
                                                <option value="mensal" selected>Mensal (30 dias)</option>
                                                <option value="quinzenal">Quinzenal (15 dias)</option>
                                                <option value="semestral">Semestral (180 dias)</option>
                                                <option value="anual">Anual (365 dias)</option>
                                                <option value="personalizado">Personalizado</option>
                                            </select>
                                            <small class="form-text text-muted">Baseado em 365 dias no ano</small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Campo para intervalo personalizado -->
                                <div id="campo_intervalo_personalizado" style="display: none;" class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="intervalo_dias" class="form-label">Intervalo em Dias</label>
                                            <input type="number" class="form-control" id="intervalo_dias"
                                                name="intervalo_dias" min="1" max="365" value="30" placeholder="Ex: 30">
                                            <small class="form-text text-muted">Digite o n√∫mero de dias entre as
                                                parcelas (1 a 365)</small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Tabela de parcelas com vencimentos -->
                                <div id="tabela_parcelas" class="mt-3">
                                    <h6 class="mb-2">Detalhamento das Parcelas:</h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm table-bordered">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Parcela</th>
                                                    <th>Vencimento</th>
                                                    <th>Valor</th>
                                                </tr>
                                            </thead>
                                            <tbody id="parcelas_body">
                                                <!-- Preenchido via JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Campo totalizador autom√°tico -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Total da Opera√ß√£o</label>
                                <input type="text" class="form-control" id="total_operacao" readonly
                                    style="background-color: #f8f9fa; font-weight: bold; color: #495057;">
                                <small class="form-text text-muted">Calculado automaticamente: (Quantidade √ó Valor) -
                                    Desconto</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Valor por Parcela</label>
                                <input type="text" class="form-control" id="valor_parcela" readonly
                                    style="background-color: #f8f9fa; color: #6c757d;">
                                <small class="form-text text-muted">Valor dividido pelo n√∫mero de parcelas</small>
                            </div>
                        </div>
                    </div>

                    <!-- Campo para sele√ß√£o de conta caixa -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="conta_caixa_id" class="form-label">Conta Caixa (opcional)</label>
                                <select class="form-select" id="conta_caixa_id" name="conta_caixa_id">
                                    <option value="">Selecione uma conta caixa (opcional)</option>
                                    {% for conta in contas_caixa %}
                                    <option value="{{ conta.id }}">{{ conta.nome }} - {{ conta.tipo|title }}</option>
                                    {% endfor %}
                                </select>
                                <small class="form-text text-muted">Selecione a conta caixa onde o lan√ßamento ser√°
                                    registrado. Se n√£o selecionar, o lan√ßamento ser√° criado sem conta
                                    espec√≠fica.</small>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="observacoes" class="form-label">Observa√ß√µes</label>
                        <textarea class="form-control" id="observacoes" name="observacoes" rows="3"></textarea>
                    </div>

                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('vendas') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Voltar
                        </a>
                        <button type="submit" class="btn btn-primary" id="btn-salvar-venda">
                            <i class="fas fa-save"></i> Salvar Venda
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    .autocomplete-container {
        position: relative;
    }

    .autocomplete-suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ced4da;
        border-top: none;
        border-radius: 0 0 0.375rem 0.375rem;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
    }

    .autocomplete-suggestion {
        padding: 8px 12px;
        cursor: pointer;
        border-bottom: 1px solid #f8f9fa;
    }

    .autocomplete-suggestion:hover {
        background-color: #f8f9fa;
    }

    .autocomplete-suggestion:last-child {
        border-bottom: none;
    }

    .autocomplete-suggestion.selected {
        background-color: #007bff;
        color: white;
    }

    .autocomplete-suggestion.create-new {
        background-color: #e3f2fd;
        border-left: 3px solid #2196f3;
        font-style: italic;
    }

    .autocomplete-suggestion.create-new:hover {
        background-color: #bbdefb;
    }

    .autocomplete-suggestion.create-new.selected {
        background-color: #2196f3;
        color: white;
    }

    .modal-backdrop {
        z-index: 1040;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        console.log('P√°gina carregada - iniciando JavaScript');

        // Configurar data prevista com valor padr√£o do dia atual
        const dataPrevistaInput = document.getElementById('data_prevista');
        if (dataPrevistaInput && !dataPrevistaInput.value) {
            const hoje = new Date();
            const dia = String(hoje.getDate()).padStart(2, '0');
            const mes = String(hoje.getMonth() + 1).padStart(2, '0');
            const ano = hoje.getFullYear();
            dataPrevistaInput.value = `${dia}/${mes}/${ano}`;
        }

        // Autocomplete para clientes
        const clienteSearchInput = document.getElementById('cliente_search');
        const clienteIdInput = document.getElementById('cliente_id');
        const clienteSuggestions = document.getElementById('cliente_suggestions');

        let searchTimeout;
        let selectedIndex = -1;

        // Fun√ß√£o para buscar clientes
        function buscarClientes(query) {
            if (query.length < 2) {
                clienteSuggestions.style.display = 'none';
                return;
            }

            fetch(`/api/clientes/buscar?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    mostrarSugestoes(data.clientes || [], query);
                })
                .catch(error => {
                    console.error('Erro ao buscar clientes:', error);
                    // Mesmo com erro, mostrar op√ß√£o de criar se h√° texto
                    mostrarSugestoes([], query);
                });
        }

        // Fun√ß√£o para mostrar sugest√µes
        function mostrarSugestoes(clientes, query) {
            clienteSuggestions.innerHTML = '';

            // Adicionar clientes encontrados
            clientes.forEach((cliente, index) => {
                const div = document.createElement('div');
                div.className = 'autocomplete-suggestion';
                div.innerHTML = `
                <strong>${cliente.nome}</strong>
                ${cliente.email ? `<br><small class="text-muted">${cliente.email}</small>` : ''}
                ${cliente.telefone ? `<br><small class="text-muted">${cliente.telefone}</small>` : ''}
            `;

                div.addEventListener('click', () => {
                    selecionarCliente(cliente);
                });

                clienteSuggestions.appendChild(div);
            });

            // Se n√£o encontrou clientes ou encontrou poucos, mostrar op√ß√£o de criar
            if (clientes.length === 0 || clientes.length < 5) {
                const createDiv = document.createElement('div');
                createDiv.className = 'autocomplete-suggestion create-new';
                createDiv.innerHTML = `
                <i class="fas fa-plus me-2"></i>
                <strong>Criar novo cliente: "${query}"</strong>
                <br><small class="text-muted">Clique para criar um novo cliente</small>
            `;

                createDiv.addEventListener('click', () => {
                    criarNovoCliente(query);
                });

                clienteSuggestions.appendChild(createDiv);
            }

            clienteSuggestions.style.display = 'block';
            selectedIndex = -1;
        }

        // Fun√ß√£o para selecionar cliente
        function selecionarCliente(cliente) {
            clienteSearchInput.value = cliente.nome;
            clienteIdInput.value = cliente.id;
            clienteSuggestions.style.display = 'none';
            clienteSearchInput.classList.remove('is-invalid');
        }

        // Event listeners para autocomplete
        clienteSearchInput.addEventListener('input', function () {
            const query = this.value.trim();

            // Limpar sele√ß√£o se o usu√°rio apagar o texto
            if (query === '') {
                clienteIdInput.value = '';
                clienteSuggestions.style.display = 'none';
                return;
            }

            // Debounce da busca
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                buscarClientes(query);
            }, 300);
        });

        // Event listener para teclado
        clienteSearchInput.addEventListener('keydown', function (e) {
            const suggestions = clienteSuggestions.querySelectorAll('.autocomplete-suggestion');

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedIndex = Math.min(selectedIndex + 1, suggestions.length - 1);
                atualizarSelecao(suggestions);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedIndex = Math.max(selectedIndex - 1, -1);
                atualizarSelecao(suggestions);
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (selectedIndex >= 0 && suggestions[selectedIndex]) {
                    suggestions[selectedIndex].click();
                }
            } else if (e.key === 'Escape') {
                clienteSuggestions.style.display = 'none';
                selectedIndex = -1;
            }
        });

        // Fun√ß√£o para atualizar sele√ß√£o visual
        function atualizarSelecao(suggestions) {
            suggestions.forEach((suggestion, index) => {
                suggestion.classList.toggle('selected', index === selectedIndex);
            });
        }

        // Fun√ß√£o para criar novo cliente
        function criarNovoCliente(nome) {
            // Mostrar loading na sugest√£o
            const createDiv = clienteSuggestions.querySelector('.create-new');
            if (createDiv) {
                createDiv.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Criando cliente...';
                createDiv.style.pointerEvents = 'none';
            }

            fetch('/api/clientes/criar', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    nome: nome,
                    email: '',
                    telefone: '',
                    cpf_cnpj: '',
                    endereco: ''
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        selecionarCliente(data.cliente);
                        // Mostrar feedback visual de sucesso
                        clienteSearchInput.style.borderColor = '#28a745';
                        setTimeout(() => {
                            clienteSearchInput.style.borderColor = '';
                        }, 2000);
                    } else {
                        alert('Erro ao criar cliente: ' + data.error);
                        clienteSuggestions.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Erro ao criar cliente:', error);
                    alert('Erro ao criar cliente. Tente novamente.');
                    clienteSuggestions.style.display = 'none';
                });
        }

        // Ocultar sugest√µes ao clicar fora
        document.addEventListener('click', function (e) {
            if (!e.target.closest('.autocomplete-container')) {
                clienteSuggestions.style.display = 'none';
            }
        });

        // Carrinho
        var itensBody = document.getElementById('itens-body-venda');
        var btnAddItem = document.getElementById('btn-adicionar-item-venda');
        var totalCarrinhoDiv = document.getElementById('carrinho_total_venda');
        var itensContagem = document.getElementById('itens-contagem-venda');
        var tipoPagamentoSelect = document.getElementById('tipo_pagamento');
        var numeroParcelasInput = document.getElementById('numero_parcelas');
        var descontoInput = document.getElementById('desconto');
        var configParcelasDiv = document.getElementById('config_parcelas');
        var primeiraParcelaInput = document.getElementById('primeira_parcela');
        var intervaloParcelasSelect = document.getElementById('intervalo_parcelas');
        var parcelasBody = document.getElementById('parcelas_body');
        var form = document.querySelector('form');

        console.log('Elementos encontrados:', { form: !!form });

        // Fun√ß√£o para calcular valores
        function calcularValores() {
            // Soma do carrinho (total por linha j√° considera desconto): soma(item_preco*item_qtd - item_desconto)
            var soma = 0;
            if (itensBody) {
                itensBody.querySelectorAll('.vendas_linhaItem').forEach(function (row) {
                    var p = parseFloat((row.querySelector('input[name="item_preco[]"]')?.value || '0').replace(',', '.'));
                    var q = parseFloat((row.querySelector('input[name="item_qtd[]"]')?.value || '0').replace(',', '.'));
                    var d = parseFloat((row.querySelector('input[name="item_desconto[]"]')?.value || '0').replace(',', '.'));
                    var t = Math.max((p || 0) * (q || 0) - (d || 0), 0);
                    var totalHidden = row.querySelector('input[name="item_total[]"]');
                    var totalDiv = row.querySelector('.vendas_totalLinha') || row.querySelector('input[name="item_total[]"]').previousElementSibling;
                    if (totalHidden) totalHidden.value = t.toFixed(2);
                    if (totalDiv && totalDiv.tagName === 'INPUT') {
                        totalDiv.value = t.toFixed(2).replace('.', ',');
                    } else if (totalDiv) {
                        totalDiv.textContent = 'R$ ' + t.toFixed(2).replace('.', ',');
                    }
                    soma += t;
                });
            }
            if (totalCarrinhoDiv) totalCarrinhoDiv.value = soma.toFixed(2).replace('.', ',');
            var numeroParcelas = parseInt(numeroParcelasInput ? numeroParcelasInput.value : 1);
            var totalOperacaoInput = document.getElementById('total_operacao');
            var valorParcelaInput = document.getElementById('valor_parcela');
            if (totalOperacaoInput) {
                totalOperacaoInput.value = soma.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            }
            if (valorParcelaInput) {
                var valorParcela = numeroParcelas > 0 ? soma / numeroParcelas : soma;
                valorParcelaInput.value = valorParcela.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            }
            gerarTabelaParcelas();
        }

        // Fun√ß√£o para gerar tabela de parcelas
        function gerarTabelaParcelas() {
            if (!parcelasBody) return;

            const numeroParcelas = parseInt(numeroParcelasInput.value) || 1;
            const primeiraParcela = primeiraParcelaInput.value;
            const intervalo = intervaloParcelasSelect.value;

            if (!primeiraParcela || numeroParcelas <= 1) {
                parcelasBody.innerHTML = '';
                return;
            }

            // Usa o total calculado no carrinho (total_operacao)
            const totalOperacaoInput = document.getElementById('total_operacao');
            const totalOperacao = totalOperacaoInput && totalOperacaoInput.value
                ? parseFloat(totalOperacaoInput.value.replace(/\./g, '').replace(',', '.'))
                : 0;
            const valorParcela = numeroParcelas > 0 ? (totalOperacao / numeroParcelas) : totalOperacao;
            let html = '';

            for (let i = 1; i <= numeroParcelas; i++) {
                const dataVencimento = calcularDataVencimento(primeiraParcela, i, intervalo);
                html += `
                <tr>
                    <td>${i}¬™</td>
                    <td>${formatarData(dataVencimento)}</td>
                    <td>R$ ${valorParcela.toFixed(2)}</td>
                </tr>
            `;
            }

            parcelasBody.innerHTML = html;
        }

        // Fun√ß√£o para calcular data de vencimento
        function calcularDataVencimento(dataBase, numeroParcela, intervalo) {
            // Converter data do formato brasileiro (dd/mm/aaaa) para objeto Date
            let data;
            if (typeof dataBase === 'string') {
                const partes = dataBase.split('/');
                if (partes.length === 3) {
                    // Formato brasileiro: dd/mm/aaaa -> mm/dd/aaaa para o JavaScript
                    data = new Date(partes[2], partes[1] - 1, partes[0]);
                } else {
                    data = new Date(dataBase);
                }
            } else {
                data = new Date(dataBase);
            }

            // Se √© a primeira parcela, retornar a data base sem modifica√ß√£o
            if (numeroParcela === 1) {
                return data;
            }

            switch (intervalo) {
                case 'quinzenal':
                    data.setDate(data.getDate() + (15 * (numeroParcela - 1)));
                    break;
                case 'mensal':
                    // Usar c√°lculo baseado em 365 dias por ano (30.42 dias por m√™s)
                    const diasPorMes = 365 / 12;
                    data.setDate(data.getDate() + (diasPorMes * (numeroParcela - 1)));
                    break;
                case 'semestral':
                    data.setDate(data.getDate() + (182 * (numeroParcela - 1))); // 365/2
                    break;
                case 'anual':
                    data.setDate(data.getDate() + (365 * (numeroParcela - 1)));
                    break;
                case 'personalizado':
                    const intervaloDias = parseInt(document.getElementById('intervalo_dias').value) || 30;
                    data.setDate(data.getDate() + (intervaloDias * (numeroParcela - 1)));
                    break;
                default:
                    // Usar c√°lculo baseado em 365 dias por ano (30.42 dias por m√™s)
                    const diasPorMesDefault = 365 / 12;
                    data.setDate(data.getDate() + (diasPorMesDefault * (numeroParcela - 1)));
                    break;
            }

            return data;
        }

        // Fun√ß√£o para formatar data
        function formatarData(data) {
            return data.toLocaleDateString('pt-BR');
        }

        // Fun√ß√£o para mostrar/ocultar configura√ß√£o de parcelas
        function toggleConfigParcelas() {
            const isParcelado = tipoPagamentoSelect.value === 'parcelado';
            const numeroParcelas = parseInt(numeroParcelasInput.value) || 1;

            if (isParcelado && numeroParcelas > 1) {
                configParcelasDiv.style.display = 'block';
                if (!primeiraParcelaInput.value) {
                    // Definir data padr√£o como data atual
                    const hoje = new Date();
                    const dia = String(hoje.getDate()).padStart(2, '0');
                    const mes = String(hoje.getMonth() + 1).padStart(2, '0');
                    const ano = hoje.getFullYear();
                    primeiraParcelaInput.value = `${dia}/${mes}/${ano}`;
                }
                gerarTabelaParcelas();
            } else {
                configParcelasDiv.style.display = 'none';
            }
        }

        // Event listeners para recalcular valores
        // Os valores do carrinho s√£o recalculados a partir das linhas
        if (numeroParcelasInput) {
            console.log('‚úÖ N√∫mero parcelas input encontrado:', numeroParcelasInput);
            numeroParcelasInput.addEventListener('input', function () {
                calcularValores();
                toggleConfigParcelas();
            });
        } else {
            console.error('‚ùå N√∫mero parcelas input n√£o encontrado!');
        }

        // Carrinho - adicionar/remover e listeners
        function toggleRemoveButtons() {
            var rows = itensBody.querySelectorAll('.vendas_linhaItem');
            rows.forEach(function (r) {
                var btn = r.querySelector('.vendas_linkRemItem');
                if (btn) btn.style.display = rows.length > 1 ? '' : 'none';
            });
            if (itensContagem) itensContagem.textContent = String(rows.length);
        }

        // Fun√ß√£o para validar estoque
        function validarEstoque(row) {
            var qtdEl = row.querySelector('input[name="item_qtd[]"]');
            if (!qtdEl) return;

            var estoque = parseFloat(row.dataset.estoque);
            var quantidade = parseFloat(qtdEl.value) || 0;
            var qtdCell = qtdEl.closest('td');
            var errorMsg = qtdCell ? qtdCell.querySelector('.estoque-error-message') : null;

            console.log('Validando estoque:', { estoque, quantidade, row: row });

            if (!isNaN(estoque) && quantidade > estoque) {
                qtdEl.classList.add('estoque-invalido');
                if (!errorMsg && qtdCell) {
                    errorMsg = document.createElement('small');
                    errorMsg.className = 'estoque-error-message';
                    qtdCell.appendChild(errorMsg);
                }
                if (errorMsg) {
                    errorMsg.textContent = `Estoque dispon√≠vel: ${estoque}`;
                }
                console.log('‚ùå Estoque inv√°lido! Quantidade:', quantidade, 'Estoque:', estoque);
            } else {
                limparValidacaoEstoque(row);
            }
        }

        // Fun√ß√£o para limpar valida√ß√£o de estoque
        function limparValidacaoEstoque(row) {
            var qtdEl = row.querySelector('input[name="item_qtd[]"]');
            var qtdCell = qtdEl ? qtdEl.closest('td') : null;
            if (qtdEl) qtdEl.classList.remove('estoque-invalido');
            if (qtdCell) {
                var errorMsg = qtdCell.querySelector('.estoque-error-message');
                if (errorMsg) errorMsg.remove();
            }
        }

        function bindRow(row) {
            row.querySelectorAll('input, textarea, select').forEach(function (inp) {
                inp.addEventListener('input', function () {
                    calcularValores();
                    // Validar estoque se for campo de quantidade
                    if (inp.name === 'item_qtd[]') {
                        if (row.dataset.estoque) {
                            validarEstoque(row);
                        }
                    }
                });
            });

            // Tamb√©m validar ao mudar (change event) para garantir
            var qtdInput = row.querySelector('input[name="item_qtd[]"]');
            if (qtdInput) {
                qtdInput.addEventListener('change', function () {
                    if (row.dataset.estoque) {
                        validarEstoque(row);
                    }
                });
            }
            var btn = row.querySelector('.vendas_linkRemItem');
            if (btn) btn.addEventListener('click', function () { row.remove(); toggleRemoveButtons(); calcularValores(); });

            // Autocomplete produto quando tipo=produto; texto livre quando servi√ßo
            var tipoSelect = row.querySelector('select[name="item_tipo[]"]');
            var hiddenTipo = row.querySelector('input[name="item_tipo[]"]');
            var nomeInput = row.querySelector('.item-nome');
            var sugestDiv = row.querySelector('.item-suggestions');

            // Configurar bot√£o de limpar campo nome
            var btnClear = row.querySelector('.btn-clear-nome');
            if (btnClear && nomeInput) {
                btnClear.addEventListener('click', function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    nomeInput.value = '';
                    if (sugestDiv) {
                        sugestDiv.style.display = 'none';
                        sugestDiv.innerHTML = '';
                    }
                    calcularValores();
                });
            }
            function buscarProdutos(query) {
                if (!query || query.length < 2) { if (sugestDiv) { sugestDiv.style.display = 'none'; sugestDiv.innerHTML = ''; } return; }
                if (sugestDiv) {
                    sugestDiv.innerHTML = `<div class="autocomplete-loading"><div class="sugg-icon"><i class="fas fa-box"></i></div><div class="skel" style="max-width:180px"></div></div>`;
                    sugestDiv.style.display = 'block';
                }
                fetch(`/api/produtos/sugestoes?q=${encodeURIComponent(query)}`)
                    .then(r => r.json())
                    .then(data => {
                        const itens = data.produtos || [];
                        if (!sugestDiv) return;
                        sugestDiv.innerHTML = '';
                        itens.forEach(item => {
                            var d = document.createElement('div');
                            d.className = 'autocomplete-suggestion';
                            d.innerHTML = `<div class=\"sugg-left\"><span class=\"sugg-icon\"><i class=\"fas fa-box\"></i></span><span class=\"sugg-title\"><strong>${item.nome}</strong></span></div><div class=\"sugg-meta\">${item.estoque !== undefined ? `<span class=\"badge-pill\">Estoque: ${item.estoque}</span>` : ''}</div>`;
                            d.addEventListener('click', () => {
                                nomeInput.value = item.nome; sugestDiv.style.display = 'none';
                                var precoEl = row.querySelector('input[name="item_preco[]"]');
                                var qtdEl = row.querySelector('input[name="item_qtd[]"]');
                                if (precoEl && item.preco_venda) { precoEl.value = item.preco_venda; }
                                // Armazenar estoque do produto
                                if (item.estoque !== undefined) {
                                    row.dataset.estoque = item.estoque;
                                    validarEstoque(row);
                                } else {
                                    delete row.dataset.estoque;
                                    limparValidacaoEstoque(row);
                                }
                                calcularValores();
                            });
                            sugestDiv.appendChild(d);
                        });
                        // op√ß√£o criar produto (s√≥ mostra, n√£o cria ainda - ser√° criado ao salvar)
                        if (query && (itens.length === 0 || itens.length < 5)) {
                            var createDiv = document.createElement('div');
                            createDiv.className = 'autocomplete-suggestion create-new';
                            createDiv.innerHTML = `<i class=\"fas fa-plus me-2\"></i><strong>Criar produto: \"${query}\"</strong><br><small class=\"text-muted\">Ser√° criado ao salvar o registro</small>`;
                            createDiv.addEventListener('click', function () {
                                nomeInput.value = query;
                                sugestDiv.style.display = 'none';
                                // N√£o cria o produto ainda, apenas preenche o nome
                                // O produto ser√° criado no backend quando o registro for salvo
                                calcularValores();
                            });
                            sugestDiv.appendChild(createDiv);
                        }
                        sugestDiv.style.display = 'block';
                    }).catch(() => { if (sugestDiv) { sugestDiv.style.display = 'none'; } });
            }
            function toggleAutocomplete() {
                if (!nomeInput) return;
                var tipoAtual = '';
                if (tipoSelect) {
                    tipoAtual = tipoSelect.value;
                } else if (hiddenTipo) {
                    tipoAtual = hiddenTipo.value;
                }

                if (tipoAtual === 'produto' || tipoAtual === 'mercadoria') {
                    nomeInput.setAttribute('placeholder', 'Digite o nome do produto');
                    if (nomeInput.dataset.autocompleteBound !== 'true') {
                        nomeInput.addEventListener('input', onNomeInput);
                        nomeInput.dataset.autocompleteBound = 'true';
                    }
                } else {
                    nomeInput.setAttribute('placeholder', 'Descreva o servi√ßo');
                    if (sugestDiv) { sugestDiv.style.display = 'none'; sugestDiv.innerHTML = ''; }
                    nomeInput.removeEventListener('input', onNomeInput);
                    nomeInput.dataset.autocompleteBound = 'false';
                }
            }

            // Eventos para dropdown customizado do tipo (vendas)
            var btnTipo = row.querySelector('.vendas_btnSelTipo');
            if (btnTipo && hiddenTipo) {
                row.querySelectorAll('.vendas_selTipo').forEach(function (a) {
                    a.addEventListener('click', function (ev) {
                        ev.preventDefault();
                        ev.stopPropagation();
                        var v = this.getAttribute('value');
                        if (hiddenTipo) hiddenTipo.value = v;
                        if (btnTipo) {
                            var icon = 'fa-cubes';
                            var label = 'Produto';
                            if (v === 'servico') { icon = 'fa-wrench'; label = 'Servi√ßo'; }
                            else if (v === 'frete') { icon = 'fa-truck'; label = 'Frete'; }
                            else if (v === 'saida') { icon = 'fa-money'; label = 'Outras saidas'; }
                            btnTipo.innerHTML = `<i class="fa ${icon}"></i> ${label}`;
                            btnTipo.setAttribute('valor', v);
                        }
                        // Fechar dropdown do Bootstrap
                        if (window.bootstrap && bootstrap.Dropdown) {
                            var dropdown = bootstrap.Dropdown.getInstance(btnTipo);
                            if (dropdown) dropdown.hide();
                        }
                        toggleAutocomplete();
                    });
                });
            }

            // Evento para select padr√£o (compras/lan√ßamentos)
            if (tipoSelect) {
                tipoSelect.addEventListener('change', function () {
                    if (hiddenTipo) hiddenTipo.value = this.value;
                    toggleAutocomplete();
                });
            }

            function onNomeInput() {
                var tipoAtual = '';
                if (tipoSelect) {
                    tipoAtual = tipoSelect.value;
                } else if (hiddenTipo) {
                    tipoAtual = hiddenTipo.value;
                }
                if (tipoAtual === 'produto' || tipoAtual === 'mercadoria') {
                    buscarProdutos(nomeInput.value.trim());
                }
            }

            toggleAutocomplete();

            // Fechar sugest√µes ao clicar fora
            document.addEventListener('click', function (e) {
                if (sugestDiv && !e.target.closest('.autocomplete-container')) {
                    sugestDiv.style.display = 'none';
                }
            });
        }

        // Fun√ß√£o para adicionar novo item
        function adicionarItemVenda() {
            console.log('üöÄ Fun√ß√£o adicionarItemVenda() chamada');
            var bodyDiv = document.getElementById('itens-body-venda');
            if (!bodyDiv) {
                console.error('‚ùå itens-body-venda n√£o encontrado!');
                return;
            }
            console.log('‚úÖ itens-body-venda encontrado, criando nova linha...');

            var idx = bodyDiv.querySelectorAll('.vendas_linhaItem').length + 1;
            var tr = document.createElement('tr');
            tr.className = 'vendas_linhaItem item-row-venda';
            tr.setAttribute('linha', String(idx));
            tr.setAttribute('comitem', 'nao');
            tr.innerHTML = `
            <td>
                <div class="btn-group">
                    <button type="button" class="vendas_btnSelTipo btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" linha="${idx}" valor="produto">
                        <i class="fa fa-cubes"></i> Produto
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item vendas_selTipo" href="#" linha="${idx}" value="produto"><i class="fa fa-cubes"></i> Produto</a></li>
                        <li><a class="dropdown-item vendas_selTipo" href="#" linha="${idx}" value="servico"><i class="fa fa-wrench"></i> Servi√ßo</a></li>
                        <li><a class="dropdown-item vendas_selTipo" href="#" linha="${idx}" value="frete"><i class="fa fa-truck"></i> Frete</a></li>
                        <li><a class="dropdown-item vendas_selTipo" href="#" linha="${idx}" value="saida"><i class="fa fa-money"></i> Outras saidas</a></li>
                    </ul>
                </div>
                <input type="hidden" name="item_tipo[]" value="produto">
            </td>
            <td>
                <div class="d-flex align-items-start gap-2">
                    <div class="autocomplete-container flex-grow-1">
                        <input type="text" class="form-control form-control-sm item-nome" value="" autocomplete="off" name="item_nome[]" placeholder="Digite o nome do produto">
                        <div class="autocomplete-suggestions item-suggestions" style="display:none;"></div>
                    </div>
                    <button type="button" class="btn btn-outline-secondary btn-sm input-clear-btn btn-clear-nome" title="Limpar campo" data-bs-toggle="tooltip">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <small class="text-muted d-block mt-1">Observa√ß√µes adicionais (opcional)</small>
                <input type="text" class="form-control form-control-sm mt-1" name="item_obs[]" placeholder="">
            </td>
            <td class="text-end">
                <input type="number" step="0.01" min="0" class="form-control form-control-sm text-end" name="item_preco[]" value="0.00" inputmode="decimal">
            </td>
            <td class="text-center">
                <input type="number" min="1" class="form-control form-control-sm text-center" name="item_qtd[]" value="1">
            </td>
            <td class="text-end">
                <input type="number" step="0.01" min="0" class="form-control form-control-sm text-end" name="item_desconto[]" value="0.00">
            </td>
            <td class="text-end">
                <input type="text" class="form-control form-control-sm text-end vendas_totalLinha" value="0,00" readonly style="background-color: #f8f9fa; padding-right: 2rem;">
                <input type="hidden" name="item_total[]" value="0.00">
                <button type="button" class="carrinho-remove-btn vendas_linkRemItem" title="Remover item do carrinho" data-bs-toggle="tooltip">
                    <i class="fas fa-trash"></i>
                </button>
            </td>`;
            bodyDiv.appendChild(tr);
            bindRow(tr);

            // Inicializar dropdown do Bootstrap
            if (window.bootstrap && bootstrap.Dropdown) {
                var btnTipo = tr.querySelector('.vendas_btnSelTipo');
                if (btnTipo) {
                    try {
                        // Verificar se j√° foi inicializado
                        var existingDropdown = bootstrap.Dropdown.getInstance(btnTipo);
                        if (!existingDropdown) {
                            new bootstrap.Dropdown(btnTipo, {
                                boundary: 'viewport',
                                popperConfig: {
                                    modifiers: [
                                        {
                                            name: 'preventOverflow',
                                            options: {
                                                boundary: 'viewport'
                                            }
                                        }
                                    ]
                                }
                            });
                        }
                    } catch (e) {
                        console.warn('Erro ao inicializar dropdown:', e);
                    }
                }
            }

            // Inicializar tooltips
            if (window.bootstrap && bootstrap.Tooltip) {
                var tooltips = tr.querySelectorAll('[data-bs-toggle="tooltip"]');
                tooltips.forEach(function (el) {
                    try {
                        new bootstrap.Tooltip(el);
                    } catch (e) {
                        console.warn('Erro ao inicializar tooltip:', e);
                    }
                });
            }

            // Atualizar bot√µes de remover e c√°lculos
            toggleRemoveButtons();
            calcularValores();

            console.log('‚úÖ Item adicionado ao carrinho. Total de itens:', bodyDiv.querySelectorAll('.vendas_linhaItem').length);
        }

        // Event listener para o bot√£o Adicionar Item - usar apenas delega√ß√£o de eventos
        console.log('üîç Configurando listener para bot√£o Adicionar Item...');

        // Usar delega√ß√£o de eventos no documento para garantir que funcione (√öNICO LISTENER)
        document.addEventListener('click', function (e) {
            if (e.target && (e.target.id === 'btn-adicionar-item-venda' || e.target.closest('#btn-adicionar-item-venda'))) {
                e.preventDefault();
                e.stopPropagation();
                console.log('‚ûï Bot√£o Adicionar Item clicado!');
                adicionarItemVenda();
            }
        });
        // bind inicial
        var firstRow = itensBody ? (itensBody.querySelector('.vendas_linhaItem') || itensBody.querySelector('.item-row-venda')) : null;
        if (firstRow) {
            bindRow(firstRow);
            // Inicializar dropdown do Bootstrap se existir
            if (window.bootstrap && bootstrap.Dropdown) {
                var btnTipo = firstRow.querySelector('.vendas_btnSelTipo');
                if (btnTipo) {
                    try {
                        // Verificar se j√° foi inicializado
                        var existingDropdown = bootstrap.Dropdown.getInstance(btnTipo);
                        if (!existingDropdown) {
                            new bootstrap.Dropdown(btnTipo, {
                                boundary: 'viewport',
                                popperConfig: {
                                    modifiers: [
                                        {
                                            name: 'preventOverflow',
                                            options: {
                                                boundary: 'viewport'
                                            }
                                        }
                                    ]
                                }
                            });
                        }
                    } catch (e) {
                        console.error('Erro ao inicializar dropdown:', e);
                    }
                }
            }
        }
        toggleRemoveButtons();

        // Mostrar/ocultar campos de parcelas baseado no tipo de pagamento
        if (tipoPagamentoSelect) {
            console.log('‚úÖ Tipo pagamento select encontrado:', tipoPagamentoSelect);

            tipoPagamentoSelect.addEventListener('change', function () {
                var isParcelado = this.value === 'parcelado';
                console.log('üîÑ Tipo de pagamento alterado para:', this.value, 'isParcelado:', isParcelado);

                if (numeroParcelasInput) {
                    numeroParcelasInput.disabled = !isParcelado;
                    if (!isParcelado) {
                        numeroParcelasInput.value = '1';
                    }
                    console.log('üìä N√∫mero de parcelas:', isParcelado ? 'habilitado' : 'desabilitado', 'valor:', numeroParcelasInput.value);
                }
                calcularValores();
                toggleConfigParcelas();
            });
        } else {
            console.error('‚ùå Tipo pagamento select n√£o encontrado!');
        }

        // Mostrar/ocultar campos baseado no tipo de venda
        // Tipo de venda agora √© determinado pelos itens do carrinho, n√£o precisa mais deste campo

        // Remover c√≥digo antigo que dependia de tipoVendaSelect
        /*
        if (tipoVendaSelect) {
            console.log('‚úÖ Tipo venda select encontrado:', tipoVendaSelect);
            
            tipoVendaSelect.addEventListener('change', function() {
                var isProduto = this.value === 'produto';
                console.log('üîÑ Tipo de venda alterado para:', this.value, 'isProduto:', isProduto);
                
                // Atualiza placeholders das linhas existentes
                if (itensBody) {
                    itensBody.querySelectorAll('.vendas_linhaItem').forEach(function(row){
                        var nomeInput = row.querySelector('.item-nome');
                        if (nomeInput) {
                            nomeInput.placeholder = isProduto ? 'Digite o nome do produto' : 'Descreva o servi√ßo';
                        }
                    });
                }
            });
            
            // Executar uma vez para configurar estado inicial
            tipoVendaSelect.dispatchEvent(new Event('change'));
        } else {
            console.error('‚ùå Tipo venda select n√£o encontrado!');
        }
        */

        // Event listeners para configura√ß√£o de parcelas
        if (intervaloParcelasSelect) {
            console.log('‚úÖ Intervalo parcelas select encontrado:', intervaloParcelasSelect);

            intervaloParcelasSelect.addEventListener('change', function () {
                const campoPersonalizado = document.getElementById('campo_intervalo_personalizado');
                const isPersonalizado = this.value === 'personalizado';

                if (campoPersonalizado) {
                    campoPersonalizado.style.display = isPersonalizado ? 'block' : 'none';
                }

                // Recalcular parcelas quando mudar o intervalo
                gerarTabelaParcelas();
            });
        }

        if (primeiraParcelaInput) {
            console.log('‚úÖ Primeira parcela input encontrado:', primeiraParcelaInput);

            primeiraParcelaInput.addEventListener('input', function () {
                gerarTabelaParcelas();
            });
        }

        // Event listener para intervalo personalizado
        const intervaloDiasInput = document.getElementById('intervalo_dias');
        if (intervaloDiasInput) {
            console.log('‚úÖ Intervalo dias input encontrado:', intervaloDiasInput);

            intervaloDiasInput.addEventListener('input', function () {
                // Validar valor entre 1 e 365
                const valor = parseInt(this.value);
                if (valor < 1) {
                    this.value = 1;
                } else if (valor > 365) {
                    this.value = 365;
                }

                // Recalcular parcelas
                gerarTabelaParcelas();
            });
        }

        // (Opcional) valida√ß√£o de estoque por item poder√° ser aplicada aqui no futuro

        // Adicionar listener para o bot√£o de salvar
        var btnSalvar = document.getElementById('btn-salvar-venda');
        if (btnSalvar) {
            console.log('‚úÖ Bot√£o salvar encontrado:', btnSalvar);

            btnSalvar.addEventListener('click', function (e) {
                e.preventDefault(); // Prevenir comportamento padr√£o
                console.log('üîò Bot√£o Salvar Venda clicado!');

                // Verificar se o formul√°rio √© v√°lido
                if (form && form.checkValidity()) {
                    console.log('‚úÖ Formul√°rio v√°lido, enviando...');

                    // Desabilitar o bot√£o para evitar m√∫ltiplos cliques
                    btnSalvar.disabled = true;
                    btnSalvar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';

                    // Enviar o formul√°rio
                    form.submit();
                } else {
                    console.log('‚ùå Formul√°rio inv√°lido');

                    // Mostrar valida√ß√£o nativa do HTML5
                    form.reportValidity();

                    // Reabilitar o bot√£o
                    btnSalvar.disabled = false;
                    btnSalvar.innerHTML = '<i class="fas fa-save"></i> Salvar Venda';
                }
            });
        } else {
            console.error('‚ùå Bot√£o salvar n√£o encontrado!');
        }

        // Adicionar listener para o formul√°rio
        if (form) {
            console.log('‚úÖ Formul√°rio encontrado:', form);

            form.addEventListener('submit', function (e) {
                console.log('üìù Formul√°rio sendo enviado...');

                // Validar campos obrigat√≥rios
                var camposObrigatorios = form.querySelectorAll('[required]');
                var valido = true;

                console.log('üîç Validando campos obrigat√≥rios...');
                camposObrigatorios.forEach(function (campo) {
                    if (!campo.value || campo.value.trim() === '') {
                        valido = false;
                        campo.classList.add('is-invalid');
                        console.log('‚ùå Campo inv√°lido:', campo.name, campo.value);
                    } else {
                        campo.classList.remove('is-invalid');
                        console.log('‚úÖ Campo v√°lido:', campo.name, campo.value);
                    }
                });

                if (!valido) {
                    e.preventDefault();
                    console.log('‚ùå Formul√°rio inv√°lido, impedindo envio');

                    // Reabilitar o bot√£o se houver erro
                    if (btnSalvar) {
                        btnSalvar.disabled = false;
                        btnSalvar.innerHTML = '<i class="fas fa-save"></i> Salvar Venda';
                    }

                    alert('Por favor, preencha todos os campos obrigat√≥rios.');
                    return false;
                }

                console.log('‚úÖ Formul√°rio v√°lido, enviando...');
            });
        } else {
            console.error('‚ùå Formul√°rio n√£o encontrado!');
        }

        // Event listeners para configura√ß√£o de parcelas
        if (primeiraParcelaInput) {
            primeiraParcelaInput.addEventListener('change', gerarTabelaParcelas);
        }

        if (intervaloParcelasSelect) {
            intervaloParcelasSelect.addEventListener('change', gerarTabelaParcelas);
        }

        // Inicializar
        console.log('üöÄ Inicializando sistema...');
        calcularValores();
        toggleConfigParcelas();
        console.log('‚úÖ JavaScript inicializado com sucesso');

        // Verificar se todos os elementos est√£o funcionando
        console.log('üîç Verifica√ß√£o final dos elementos:');
        console.log('- Formul√°rio:', !!form);
        console.log('- Bot√£o salvar:', !!btnSalvar);
        console.log('- Carrinho itens:', !!itensBody);
        console.log('- Tipo pagamento:', !!tipoPagamentoSelect);
        console.log('- N√∫mero parcelas:', !!numeroParcelasInput);

        // Inicializar estado do campo de parcelas baseado no tipo de pagamento
        if (tipoPagamentoSelect && numeroParcelasInput) {
            const isParcelado = tipoPagamentoSelect.value === 'parcelado';
            numeroParcelasInput.disabled = !isParcelado;
            if (!isParcelado) {
                numeroParcelasInput.value = '1';
            }
        }

        // Inicializar tooltips globais
        if (window.bootstrap && bootstrap.Tooltip) {
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.forEach(function (tooltipTriggerEl) { new bootstrap.Tooltip(tooltipTriggerEl); });
        }

        // Inicializar dropdowns do Bootstrap
        if (window.bootstrap && bootstrap.Dropdown) {
            var dropdownTriggerList = [].slice.call(document.querySelectorAll('.vendas_btnSelTipo[data-bs-toggle="dropdown"]'));
            dropdownTriggerList.forEach(function (dropdownTriggerEl) {
                try {
                    // Verificar se j√° foi inicializado
                    var existingDropdown = bootstrap.Dropdown.getInstance(dropdownTriggerEl);
                    if (!existingDropdown) {
                        new bootstrap.Dropdown(dropdownTriggerEl, {
                            boundary: 'viewport',
                            popperConfig: {
                                modifiers: [
                                    {
                                        name: 'preventOverflow',
                                        options: {
                                            boundary: 'viewport'
                                        }
                                    }
                                ]
                            }
                        });
                    }
                } catch (e) {
                    console.error('Erro ao inicializar dropdown:', e);
                }
            });
        }
    });
</script>
{% endblock %}