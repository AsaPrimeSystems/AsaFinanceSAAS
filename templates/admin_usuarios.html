{% extends "base.html" %}

{% block title %}Gerenciar Pessoas e Contas - Sistema de Gestão Financeira{% endblock %}

{% block page_title %}Gerenciar Pessoas e Contas{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin-usuarios.css') }}">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Estatísticas -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-white stats-card" style="background-color: #0d6efd !important;">
                <div class="card-body p-4">
                    <h6 class="card-title mb-3" style="font-size: 0.875rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;"><i class="fas fa-building me-2"></i>Empresas</h6>
                    <h2 class="mb-0" style="font-size: 2.5rem; font-weight: 700;">{{ stats.empresas }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white stats-card" style="background-color: #198754 !important;">
                <div class="card-body p-4">
                    <h6 class="card-title mb-3" style="font-size: 0.875rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;"><i class="fas fa-user me-2"></i>Pessoas Físicas</h6>
                    <h2 class="mb-0" style="font-size: 2.5rem; font-weight: 700;">{{ stats.pessoas_fisicas }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white stats-card" style="background-color: #0dcaf0 !important;">
                <div class="card-body p-4">
                    <h6 class="card-title mb-3" style="font-size: 0.875rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;"><i class="fas fa-calculator me-2"></i>Contadores/BPO</h6>
                    <h2 class="mb-0" style="font-size: 2.5rem; font-weight: 700;">{{ stats.contadores }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white stats-card" style="background-color: #ffc107 !important; color: #000 !important;">
                <div class="card-body p-4">
                    <h6 class="card-title mb-3" style="font-size: 0.875rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: #000 !important;"><i class="fas fa-users me-2"></i>Total</h6>
                    <h2 class="mb-0" style="font-size: 2.5rem; font-weight: 700; color: #000 !important;">{{ stats.total }}</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Lista de Pessoas/Contas com Usuários -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0" style="color: #000000 !important;">
                <i class="fas fa-list me-2"></i>Pessoas e Contas Cadastradas
            </h5>
            <a href="/admin/vouchers" class="btn btn-primary">
                <i class="fas fa-ticket-alt me-2"></i>Gerenciar Vouchers
            </a>
        </div>
        <div class="card-body">
            <!-- Campo de pesquisa -->
            <div class="mb-4">
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" id="searchInput" class="form-control" placeholder="Pesquisar por nome, razão social, CPF/CNPJ, email...">
                </div>
            </div>
            <div class="row g-3">
                {% for item in empresas_com_usuarios %}
                {% set empresa = item.empresa %}
                {% set usuarios = item.usuarios %}
                <div class="col-12">
                    <div class="account-card" onclick="abrirDetalhesConta({{ empresa.id }})" style="cursor: pointer;">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="flex-grow-1">
                                <div class="mb-2">
                                    <strong style="font-size: 1.1rem; color: #212529;">{{ empresa.razao_social }}</strong>
                                    {% if empresa.nome_fantasia and empresa.nome_fantasia != empresa.razao_social %}
                                    <small class="text-muted ms-2">({{ empresa.nome_fantasia }})</small>
                                    {% endif %}
                                </div>
                                <div class="d-flex align-items-center gap-2 flex-wrap">
                                    {% if empresa.tipo_conta == 'empresa' %}
                                    <span class="badge bg-primary"><i class="fas fa-building me-1"></i>Empresa</span>
                                    {% elif empresa.tipo_conta == 'pessoa_fisica' %}
                                    <span class="badge bg-success"><i class="fas fa-user me-1"></i>Pessoa Física</span>
                                    {% elif empresa.tipo_conta == 'contador_bpo' %}
                                    <span class="badge bg-info"><i class="fas fa-calculator me-1"></i>Contador/BPO</span>
                                    {% endif %}
                                    {% if empresa.ativo %}
                                    <span class="badge bg-success">Ativo</span>
                                    {% else %}
                                    <span class="badge bg-danger">Inativo</span>
                                    {% endif %}
                                    {% if empresa.dias_assinatura is not none %}
                                        {% if empresa.dias_assinatura > 90 %}
                                        <span class="badge bg-success">{{ empresa.dias_assinatura }} dias</span>
                                        {% elif empresa.dias_assinatura >= 30 %}
                                        <span class="badge bg-warning text-dark">{{ empresa.dias_assinatura }} dias</span>
                                        {% elif empresa.dias_assinatura >= 7 %}
                                        <span class="badge text-white" style="background-color: #fd7e14;">{{ empresa.dias_assinatura }} dias</span>
                                        {% elif empresa.dias_assinatura > 0 %}
                                        <span class="badge bg-danger">{{ empresa.dias_assinatura }} dias</span>
                                        {% else %}
                                        <span class="badge bg-dark">Expirado</span>
                                        {% endif %}
                                    {% endif %}
                                    <span class="badge bg-secondary"><i class="fas fa-users me-1"></i>{{ usuarios|length }} usuário(s)</span>
                                </div>
                            </div>
                            <div class="ms-3">
                                <i class="fas fa-chevron-right text-muted"></i>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Modal para Detalhes da Conta e Usuários -->
<div class="modal fade" id="modalDetalhesConta" tabindex="-1" aria-labelledby="modalDetalhesContaLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalDetalhesContaLabel">
                    <i class="fas fa-building me-2"></i><span id="modalContaNome"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modalDetalhesContaBody">
                <!-- Conteúdo será preenchido via JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Editar Dias de Assinatura -->
<div class="modal fade" id="modalEditarDias" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-calendar-alt me-2"></i>Editar Dias de Assinatura</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="formEditarDias" method="POST" action="{{ url_for('admin_editar_dias') }}">
                <div class="modal-body">
                    <input type="hidden" id="conta_id_dias" name="conta_id">
                    <div class="mb-3">
                        <label class="form-label">Conta</label>
                        <input type="text" class="form-control" id="conta_nome_dias" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="dias_assinatura" class="form-label">Dias de Assinatura *</label>
                        <input type="number" class="form-control" id="dias_assinatura" name="dias_assinatura" 
                               min="0" max="3650" required>
                        <small class="form-text text-muted">Digite a quantidade de dias de assinatura (0 a 3650)</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Salvar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de Confirmação de Exclusão de Usuário -->
<div class="modal fade" id="modalExcluirUsuario" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-exclamation-triangle me-2"></i>Confirmar Exclusão</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="mensagemExcluirUsuario">Tem certeza que deseja excluir este usuário? Esta ação não pode ser desfeita.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="btnConfirmarExcluirUsuario">Excluir</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmação de Exclusão de Conta -->
<div class="modal fade" id="modalExcluirConta" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-exclamation-triangle me-2"></i>Confirmar Exclusão</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="mensagemExcluirConta">Tem certeza que deseja excluir esta conta? Todos os usuários vinculados também serão excluídos. Esta ação não pode ser desfeita.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="btnConfirmarExcluirConta">Excluir</button>
            </div>
        </div>
    </div>
</div>

<style>
/* Estilização para cards de estatísticas */
.admin-stats-card {
    min-height: 100px;
}

/* Cards de contas clicáveis */
.account-card {
    background-color: #fff;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 1.25rem;
    transition: all 0.3s ease;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.account-card:hover {
    background-color: #f8f9fa;
    border-color: #0d6efd;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    transform: translateY(-2px);
}

.account-card:active {
    transform: translateY(0);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

/* Ajustar posição do modal de detalhes - centralizar verticalmente */
#modalDetalhesConta .modal-dialog {
    margin: auto;
    display: flex;
    align-items: center;
    min-height: calc(100% - 3.5rem);
    padding: 1rem 0;
}

#modalDetalhesConta .modal-content {
    margin: auto;
    max-height: calc(100vh - 3.5rem);
}

@media (min-width: 576px) {
    #modalDetalhesConta .modal-dialog {
        min-height: calc(100% - 3.5rem);
        max-width: 1140px;
    }
    
    #modalDetalhesConta .modal-content {
        max-height: calc(100vh - 3.5rem);
    }
}

/* Tabela de usuários - preencher todo o espaço */
.admin-usuarios-table {
    width: 100% !important;
    table-layout: fixed;
}

.admin-usuarios-table th,
.admin-usuarios-table td {
    word-wrap: break-word;
    overflow-wrap: break-word;
    vertical-align: middle;
    padding: 0.5rem 0.75rem;
}

/* Tabela de usuários */
.table thead th {
    background-color: #f8f9fa;
    border-bottom: 2px solid #dee2e6;
    font-weight: 600;
    color: #495057;
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.table tbody td {
    vertical-align: middle;
    font-size: 0.9rem;
}

.table code {
    font-size: 0.85rem;
    padding: 0.25rem 0.5rem;
    background-color: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 0.25rem;
}


/* Ajustes para melhor organização */
.table-responsive {
    width: 100% !important;
    overflow-x: auto;
}

.table {
    width: 100% !important;
    margin-bottom: 0;
}

/* Separador visual */
hr {
    border-top: 1px solid #dee2e6;
    opacity: 1;
}

/* Estilos para informações da conta */
.account-info-card {
    background-color: #f8f9fa;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
}

.account-info-item {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.account-info-label {
    font-size: 0.875rem;
    font-weight: 600;
    color: #6c757d;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.account-info-value {
    font-size: 1rem;
    font-weight: 500;
    color: #212529;
}

/* Título da seção de usuários */
.users-section-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: #212529;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #dee2e6;
}

/* Container da tabela de usuários */
.users-table-container {
    width: 100%;
    margin-top: 1rem;
}

.users-table {
    width: 100% !important;
    table-layout: fixed;
    margin-bottom: 0;
}

.users-table th {
    background-color: #f8f9fa;
    border-bottom: 2px solid #dee2e6;
    font-weight: 600;
    color: #495057;
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 0.75rem;
    white-space: nowrap;
}

.users-table td {
    vertical-align: middle;
    font-size: 0.9rem;
    padding: 0.75rem;
    word-wrap: break-word;
    overflow-wrap: break-word;
}

/* Estilo para código de usuário */
.user-code {
    display: inline-block;
    background-color: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 0.25rem;
    padding: 0.25rem 0.5rem;
    font-family: 'Courier New', monospace;
    font-size: 0.85rem;
    color: #495057;
}

/* Ajustes responsivos */
@media (max-width: 768px) {
    .account-info-item {
        margin-bottom: 1rem;
    }
    
    .users-table th,
    .users-table td {
        font-size: 0.8rem;
        padding: 0.5rem;
    }
    
    .account-card {
        padding: 1rem;
    }
}

/* Garantir que botões não quebrem o layout */
.modal-body .btn-group {
    flex-wrap: nowrap;
}

.modal-body .btn {
    white-space: nowrap;
}

/* Ajustar largura das colunas da tabela quando expandida */
.users-table th:nth-child(1),
.users-table td:nth-child(1) {
    width: 25%;
}

.users-table th:nth-child(2),
.users-table td:nth-child(2) {
    width: 15%;
}

.users-table th:nth-child(3),
.users-table td:nth-child(3) {
    width: 20%;
}

.users-table th:nth-child(4),
.users-table td:nth-child(4) {
    width: 10%;
}

.users-table th:nth-child(5),
.users-table td:nth-child(5) {
    width: 12%;
}

.users-table th:nth-child(6),
.users-table td:nth-child(6) {
    width: 18%;
}
</style>
{% endblock %}

{% block scripts %}
<script>
// Dados das empresas para o modal
const empresasData = {
    {% for item in empresas_com_usuarios %}
    {% set empresa = item.empresa %}
    {% set usuarios = item.usuarios %}
    {{ empresa.id }}: {
        id: {{ empresa.id }},
        razao_social: {{ empresa.razao_social|tojson }},
        nome_fantasia: {{ (empresa.nome_fantasia or '')|tojson }},
        tipo_conta: {{ empresa.tipo_conta|tojson }},
        ativo: {{ empresa.ativo|lower }},
        dias_assinatura: {{ empresa.dias_assinatura if empresa.dias_assinatura is not none else 'null' }},
        cpf: {{ (empresa.cpf or '')|tojson }},
        cnpj: {{ (empresa.cnpj or '')|tojson }},
        email: {{ (empresa.email or '')|tojson }},
        data_criacao: {{ (empresa.data_criacao.strftime('%d/%m/%Y') if empresa.data_criacao else '')|tojson }},
        usuarios: [
            {% for user in usuarios %}
            {
                id: {{ user.id }},
                nome: {{ user.nome|tojson }},
                usuario: {{ user.usuario|tojson }},
                email: {{ (user.email or '')|tojson }},
                ativo: {{ user.ativo|lower }},
                pausado: {{ user.pausado|lower if user.pausado else 'false' }},
                data_criacao: {{ (user.data_criacao.strftime('%d/%m/%Y') if user.data_criacao else '')|tojson }},
                toggle_url: {{ url_for('toggle_usuario_status', user_id=user.id)|tojson }},
                alterar_senha_url: {{ url_for('alterar_senha_usuario', user_id=user.id)|tojson }}
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ]
    }{% if not loop.last %},{% endif %}
    {% endfor %}
};

function abrirDetalhesConta(contaId) {
    const empresa = empresasData[contaId];
    if (!empresa) {
        showAlert('danger', 'Conta não encontrada');
        return;
    }
    
    // Atualizar título do modal
    document.getElementById('modalContaNome').textContent = empresa.razao_social;
    
    // Construir HTML do modal
    let html = `
        <!-- Botões de Ação da Conta -->
        <div class="mb-4 d-flex gap-2 flex-wrap">
            <button type="button" class="btn btn-sm btn-primary"
                    onclick='editarDias(${empresa.id}, ${empresa.dias_assinatura || 0}, "${empresa.razao_social.replace(/"/g, '&quot;').replace(/'/g, "\\'")}")'>
                <i class="fas fa-calendar-alt me-1"></i> Editar Dias de Assinatura
            </button>
            <button type="button" class="btn btn-sm btn-info"
                    onclick="editarConta(${empresa.id})">
                <i class="fas fa-edit me-1"></i> Editar Dados
            </button>
            ${empresa.ativo ?
                `<button type="button" class="btn btn-sm btn-warning" onclick="toggleStatus(${empresa.id}, false)">
                    <i class="fas fa-pause me-1"></i> Desativar Conta
                </button>` :
                `<button type="button" class="btn btn-sm btn-success" onclick="toggleStatus(${empresa.id}, true)">
                    <i class="fas fa-play me-1"></i> Ativar Conta
                </button>`
            }
            <button type="button" class="btn btn-sm btn-danger"
                    onclick='excluirConta(${empresa.id}, "${empresa.razao_social.replace(/"/g, '&quot;').replace(/'/g, "\\'")}")'>
                <i class="fas fa-trash me-1"></i> Excluir Conta
            </button>
        </div>
        
        <hr class="my-3">
        
        <!-- Informações da Conta -->
        <div class="account-info-card mb-4">
            <div class="row">
                <div class="col-md-4 mb-3 mb-md-0">
                    <div class="account-info-item">
                        <span class="account-info-label"><i class="fas fa-id-card me-1"></i> CPF/CNPJ</span>
                        <span class="account-info-value">${empresa.cpf || empresa.cnpj || '-'}</span>
                    </div>
                </div>
                <div class="col-md-4 mb-3 mb-md-0">
                    <div class="account-info-item">
                        <span class="account-info-label"><i class="fas fa-calendar me-1"></i> Data de Cadastro</span>
                        <span class="account-info-value">${empresa.data_criacao || '-'}</span>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="account-info-item">
                        <span class="account-info-label"><i class="fas fa-envelope me-1"></i> Email</span>
                        <span class="account-info-value">${empresa.email || '-'}</span>
                    </div>
                </div>
            </div>
        </div>
        
        <hr class="my-3">
        
        <!-- Usuários Vinculados -->
        <div class="users-section-title">
            <i class="fas fa-users me-2"></i>Usuários Vinculados (${empresa.usuarios.length})
        </div>
    `;
    
    if (empresa.usuarios.length > 0) {
        html += `
            <div class="users-table-container">
                <div class="table-responsive">
                    <table class="table users-table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Usuário</th>
                                <th>Email</th>
                                <th>Status</th>
                                <th>Data de Criação</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
        `;
        
        empresa.usuarios.forEach(user => {
            const statusBadge = user.pausado ? 
                '<span class="badge bg-warning">Pausado</span>' : 
                (user.ativo ? 
                    '<span class="badge bg-success">Ativo</span>' : 
                    '<span class="badge bg-danger">Inativo</span>');
            
            const toggleButton = user.ativo ?
                `<a href="${user.toggle_url}" class="btn btn-outline-warning" title="Desativar usuário">
                    <i class="fas fa-pause"></i>
                </a>` :
                `<a href="${user.toggle_url}" class="btn btn-outline-success" title="Ativar usuário">
                    <i class="fas fa-play"></i>
                </a>`;
            
            html += `
                <tr>
                    <td>${user.nome}</td>
                    <td><span class="user-code">${user.usuario}</span></td>
                    <td>${user.email || '-'}</td>
                    <td>${statusBadge}</td>
                    <td><small class="text-muted">${user.data_criacao || '-'}</small></td>
                    <td>
                        <div class="btn-group btn-group-sm" role="group">
                            ${toggleButton}
                            <a href="${user.alterar_senha_url}" class="btn btn-outline-primary" title="Alterar senha">
                                <i class="fas fa-key"></i>
                            </a>
                            <button type="button" class="btn btn-outline-danger"
                                    onclick='excluirUsuario(${user.id}, "${user.nome.replace(/"/g, '&quot;').replace(/'/g, "\\'")}")'
                                    title="Excluir usuário">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        });
        
        html += `
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    } else {
        html += `
            <div class="alert alert-info mb-0">
                <i class="fas fa-info-circle me-2"></i>Nenhum usuário vinculado a esta conta.
            </div>
        `;
    }
    
    // Preencher o modal
    document.getElementById('modalDetalhesContaBody').innerHTML = html;
    
    // Abrir o modal
    const modal = new bootstrap.Modal(document.getElementById('modalDetalhesConta'));
    modal.show();
}

function editarDias(contaId, diasAtuais, nomeConta) {
    // Fechar modal de detalhes se estiver aberto
    const modalDetalhes = bootstrap.Modal.getInstance(document.getElementById('modalDetalhesConta'));
    if (modalDetalhes) {
        modalDetalhes.hide();
    }
    
    document.getElementById('conta_id_dias').value = contaId;
    document.getElementById('conta_nome_dias').value = nomeConta;
    document.getElementById('dias_assinatura').value = diasAtuais || 0;
    
    const modal = new bootstrap.Modal(document.getElementById('modalEditarDias'));
    modal.show();
}

function editarConta(contaId) {
    window.location.href = `/admin/editar-conta/${contaId}`;
}

function toggleStatus(contaId, ativo) {
    if (!confirm(`Tem certeza que deseja ${ativo ? 'ativar' : 'desativar'} esta conta?`)) {
        return;
    }
    
    // Fechar modal de detalhes se estiver aberto
    const modalDetalhes = bootstrap.Modal.getInstance(document.getElementById('modalDetalhesConta'));
    if (modalDetalhes) {
        modalDetalhes.hide();
    }
    
    fetch(`/admin/toggle-status/${contaId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ ativo: ativo })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message || 'Status atualizado com sucesso!');
            setTimeout(() => location.reload(), 1500);
        } else {
            showAlert('danger', data.message || 'Erro ao atualizar status');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        showAlert('danger', 'Erro de conexão ao atualizar status');
    });
}

function excluirConta(contaId, nomeConta) {
    // Fechar modal de detalhes se estiver aberto
    const modalDetalhes = bootstrap.Modal.getInstance(document.getElementById('modalDetalhesConta'));
    if (modalDetalhes) {
        modalDetalhes.hide();
    }
    
    const modal = new bootstrap.Modal(document.getElementById('modalExcluirConta'));
    const mensagem = document.getElementById('mensagemExcluirConta');
    const btnConfirmar = document.getElementById('btnConfirmarExcluirConta');
    
    mensagem.textContent = `Tem certeza que deseja excluir a conta "${nomeConta}"? Todos os usuários vinculados também serão excluídos. Esta ação não pode ser desfeita.`;
    
    btnConfirmar.onclick = function() {
        btnConfirmar.disabled = true;
        btnConfirmar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Excluindo...';
        
        fetch(`/admin/excluir-conta/${contaId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('success', 'Conta excluída com sucesso!');
                modal.hide();
                setTimeout(() => location.reload(), 1500);
            } else {
                showAlert('danger', data.message || 'Erro ao excluir conta');
                btnConfirmar.disabled = false;
                btnConfirmar.innerHTML = 'Excluir';
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            showAlert('danger', 'Erro de conexão ao excluir conta');
            btnConfirmar.disabled = false;
            btnConfirmar.innerHTML = 'Excluir';
        });
    };
    
    modal.show();
    
    modal._element.addEventListener('hidden.bs.modal', function() {
        btnConfirmar.disabled = false;
        btnConfirmar.innerHTML = 'Excluir';
    });
}

function excluirUsuario(userId, userName) {
    const modal = new bootstrap.Modal(document.getElementById('modalExcluirUsuario'));
    const mensagem = document.getElementById('mensagemExcluirUsuario');
    const btnConfirmar = document.getElementById('btnConfirmarExcluirUsuario');
    
    mensagem.textContent = `Tem certeza que deseja excluir o usuário "${userName}"? Esta ação não pode ser desfeita.`;
    
    btnConfirmar.onclick = function() {
        btnConfirmar.disabled = true;
        btnConfirmar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Excluindo...';
        
        fetch(`/admin/usuario/${userId}/deletar`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('success', data.message || 'Usuário excluído com sucesso!');
                modal.hide();
                setTimeout(() => location.reload(), 1500);
            } else {
                showAlert('danger', data.message || 'Erro ao excluir usuário');
                btnConfirmar.disabled = false;
                btnConfirmar.innerHTML = 'Excluir';
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            showAlert('danger', 'Erro de conexão ao excluir usuário');
            btnConfirmar.disabled = false;
            btnConfirmar.innerHTML = 'Excluir';
        });
    };
    
    modal.show();
    
    modal._element.addEventListener('hidden.bs.modal', function() {
        btnConfirmar.disabled = false;
        btnConfirmar.innerHTML = 'Excluir';
    });
}

function showAlert(type, message) {
    const existingAlerts = document.querySelectorAll('.alert-dismissible');
    existingAlerts.forEach(alert => alert.remove());

    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    const container = document.querySelector('.container-fluid');
    container.insertBefore(alertDiv, container.firstChild);

    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// Funcionalidade de pesquisa
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const accountCards = document.querySelectorAll('.account-card');

    if (searchInput) {
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase().trim();

            accountCards.forEach(card => {
                const cardText = card.textContent.toLowerCase();
                const parentCol = card.closest('.col-12');

                if (cardText.includes(searchTerm)) {
                    parentCol.style.display = '';
                } else {
                    parentCol.style.display = 'none';
                }
            });
        });
    }
});
</script>
{% endblock %}
