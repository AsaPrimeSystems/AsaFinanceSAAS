{% extends "base.html" %}

{% block title %}Dashboard - Asa Finance{% endblock %}

{% block page_title %}<i class="fas fa-home me-2"></i>Dashboard{% endblock %}

{% block content %}

<!-- Modal OBRIGATÓRIO de Assinatura Expirada -->
{% if assinatura_expirada %}
<div class="modal fade" id="modalAssinaturaExpirada" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
    aria-labelledby="modalAssinaturaExpiradaLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header pf-card-header-danger">
                <h5 class="modal-title" id="modalAssinaturaExpiradaLabel">
                    <i class="fas fa-exclamation-circle me-2"></i>Assinatura Expirada
                </h5>
            </div>
            <div class="modal-body text-center py-5">
                <i class="fas fa-calendar-times fa-4x text-danger mb-4" style="color: #E53935 !important;"></i>
                <h4 class="mb-3" style="color: #1E293B !important;">Sua assinatura expirou!</h4>
                <p class="lead mb-4" style="color: #475569;">Para continuar usando o sistema, escolha um plano de assinatura.</p>
                <a href="/precos" class="pf-btn pf-btn-danger" style="font-size: 1rem; padding: 12px 32px;">
                    <i class="fas fa-shopping-cart"></i>Ver Planos e Assinar
                </a>
            </div>
            <div class="modal-footer bg-light">
                <p class="text-muted mb-0 small">
                    <i class="fas fa-info-circle me-1"></i>
                    Sem um plano ativo, você não poderá acessar o sistema.
                </p>
            </div>
        </div>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var modalElement = document.getElementById('modalAssinaturaExpirada');
        if (modalElement) {
            var modal = new bootstrap.Modal(modalElement);
            modal.show();
        }
    });
</script>
{% endif %}

<!-- Alertas de vínculos pendentes -->
{% if vinculos_pendentes %}
<div class="pf-alert pf-alert-warning mb-3 d-flex align-items-start gap-3">
    <i class="fas fa-exclamation-triangle fa-lg mt-1 flex-shrink-0"></i>
    <div class="flex-grow-1">
        <strong>{{ vinculos_pendentes|length }} solicitação(ões) de vínculo pendente(s)</strong>
        <div class="d-flex gap-2 mt-2 flex-wrap">
            {% for vinculo in vinculos_pendentes[:2] %}
            <div class="d-flex align-items-center gap-2 p-2 rounded" style="background: rgba(0,0,0,0.06); font-size: 0.82rem;">
                <i class="fas fa-building"></i>
                <span>Solicitado em {{ vinculo.data_solicitacao.strftime('%d/%m/%Y') }}</span>
                <form method="POST" action="{{ url_for('autorizar_vinculo', vinculo_id=vinculo.id) }}" style="display:inline;">
                    <button type="submit" class="pf-btn pf-btn-success pf-btn-sm"
                        onclick="return confirm('Autorizar este contador?');">
                        <i class="fas fa-check"></i> Autorizar
                    </button>
                </form>
                <form method="POST" action="{{ url_for('rejeitar_vinculo', vinculo_id=vinculo.id) }}" style="display:inline;">
                    <button type="submit" class="pf-btn pf-btn-danger pf-btn-sm"
                        onclick="return confirm('Rejeitar esta solicitação?');">
                        <i class="fas fa-times"></i>
                    </button>
                </form>
            </div>
            {% endfor %}
            <a href="{{ url_for('vinculos_pendentes') }}" class="pf-btn pf-btn-outline pf-btn-sm align-self-center">
                <i class="fas fa-eye"></i> Ver Todos
            </a>
        </div>
    </div>
</div>
{% endif %}

<!-- Alertas do sistema -->
{% if alertas %}
<div class="row mb-3 g-2">
    {% for alerta in alertas %}
    <div class="col-md-6 col-lg-4">
        <div class="pf-alert pf-alert-{{ alerta.tipo }}">
            <i class="{{ alerta.icone }} flex-shrink-0"></i>
            <div>
                <strong style="font-size:0.82rem;">{{ alerta.titulo }}</strong>
                <div style="font-size:0.78rem; margin-top:2px;">{{ alerta.mensagem }}</div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

<div class="dashboard-content">

    <!-- ======== FILTRO DE PERÍODO ======== -->
    <div class="pf-filter-bar mb-4">
        <i class="fas fa-filter" style="color: var(--pf-gray-400);"></i>
        <form method="GET" action="{{ url_for('dashboard') }}" class="d-flex align-items-center gap-3 flex-wrap w-100">
            <div class="d-flex align-items-center gap-2">
                <label for="filtro" class="mb-0">Período:</label>
                <select name="filtro" id="filtro" class="form-select form-select-sm" style="width:auto; min-width:130px;" onchange="this.form.submit()">
                    <option value="mes" {{ 'selected' if filtro_tipo=='mes' }}>Mês a Mês</option>
                    <option value="ano" {{ 'selected' if filtro_tipo=='ano' }}>Por Ano</option>
                </select>
            </div>
            <div class="d-flex align-items-center gap-2">
                <label for="ano" class="mb-0">Ano:</label>
                <select name="ano" id="ano" class="form-select form-select-sm" style="width:auto; min-width:90px;" onchange="this.form.submit()">
                    {% for ano_opcao in anos_disponiveis %}
                    <option value="{{ ano_opcao }}" {{ 'selected' if ano_opcao==ano }}>{{ ano_opcao }}</option>
                    {% endfor %}
                </select>
            </div>
            <div id="mes_container" class="d-flex align-items-center gap-2" style="display: {{ 'flex' if filtro_tipo == 'mes' else 'none' }} !important;">
                <label for="mes" class="mb-0">Mês:</label>
                <select name="mes" id="mes" class="form-select form-select-sm" style="width:auto; min-width:130px;" onchange="this.form.submit()">
                    {% for mes_num, mes_nome in meses %}
                    <option value="{{ mes_num }}" {{ 'selected' if mes_num==mes }}>{{ mes_nome }}</option>
                    {% endfor %}
                </select>
            </div>
            <button type="submit" class="pf-btn pf-btn-primary pf-btn-sm">
                <i class="fas fa-sync-alt"></i> Atualizar
            </button>
        </form>
    </div>

    <!-- ======== BARRA RESUMO FINANCEIRO - ESTILO PLANIFIN ======== -->
    <div class="pf-section-title mb-3">Resumo do Período</div>

    <div class="pf-summary-row mb-4">
        <div class="pf-summary-item">
            <div class="pf-summary-label"><i class="fas fa-arrow-down text-success me-1"></i>Entradas Realizadas</div>
            <div class="pf-summary-value pf-money pf-money-pos">R$ {{ "%.2f"|format(total_entradas_periodo) }}</div>
            <div class="pf-summary-sub">Lançamentos confirmados</div>
        </div>
        <div class="pf-summary-item">
            <div class="pf-summary-label"><i class="fas fa-arrow-up text-danger me-1"></i>Saídas Realizadas</div>
            <div class="pf-summary-value pf-money pf-money-neg">R$ {{ "%.2f"|format(total_saidas_periodo) }}</div>
            <div class="pf-summary-sub">Lançamentos confirmados</div>
        </div>
        <div class="pf-summary-item">
            <div class="pf-summary-label"><i class="fas fa-balance-scale me-1" style="color: {{ '#2E7D32' if saldo_periodo >= 0 else '#C62828' }};"></i>Saldo Realizado</div>
            <div class="pf-summary-value pf-money {{ 'pf-money-pos' if saldo_periodo >= 0 else 'pf-money-neg' }}">R$ {{ "%.2f"|format(saldo_periodo) }}</div>
            <div class="pf-summary-sub">Entradas - Saídas</div>
        </div>
        <div class="pf-summary-item">
            <div class="pf-summary-label"><i class="fas fa-clock text-warning me-1"></i>A Receber (Pendente)</div>
            <div class="pf-summary-value pf-money" style="color: #0288D1;">R$ {{ "%.2f"|format(total_entrada_mes) }}</div>
            <div class="pf-summary-sub">No período selecionado</div>
        </div>
        <div class="pf-summary-item">
            <div class="pf-summary-label"><i class="fas fa-clock text-warning me-1"></i>A Pagar (Pendente)</div>
            <div class="pf-summary-value pf-money pf-money-neg">R$ {{ "%.2f"|format(total_saida_mes) }}</div>
            <div class="pf-summary-sub">No período selecionado</div>
        </div>
        {% if total_entradas_periodo > 0 %}
        <div class="pf-summary-item">
            {% set margem = ((total_entradas_periodo - total_saidas_periodo) / total_entradas_periodo * 100) %}
            <div class="pf-summary-label"><i class="fas fa-percentage me-1"></i>Margem</div>
            <div class="pf-summary-value pf-money {{ 'pf-money-pos' if margem >= 0 else 'pf-money-neg' }}">{{ "%.1f"|format(margem) }}%</div>
            <div class="pf-summary-sub">Margem de resultado</div>
        </div>
        {% endif %}
    </div>

    <!-- ======== KPI CARDS ======== -->
    <div class="pf-section-title mb-3">Hoje</div>
    <div class="row g-3 mb-4">
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="pf-kpi-card">
                <div class="pf-kpi-header">
                    <div>
                        <div class="pf-kpi-label">A Receber Hoje</div>
                    </div>
                    <div class="pf-kpi-icon success"><i class="fas fa-sign-in-alt"></i></div>
                </div>
                <div class="pf-kpi-value text-success">R$ {{ "%.2f"|format(total_entrada_hoje) }}</div>
                <div class="pf-kpi-footer">
                    <i class="fas fa-clock"></i> Pendentes hoje
                    <a href="{{ url_for('lancamentos') }}" class="ms-auto">Ver »</a>
                </div>
            </div>
        </div>
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="pf-kpi-card">
                <div class="pf-kpi-header">
                    <div>
                        <div class="pf-kpi-label">A Pagar Hoje</div>
                    </div>
                    <div class="pf-kpi-icon danger"><i class="fas fa-sign-out-alt"></i></div>
                </div>
                <div class="pf-kpi-value text-danger">R$ {{ "%.2f"|format(total_saida_hoje) }}</div>
                <div class="pf-kpi-footer">
                    <i class="fas fa-clock"></i> Pendentes hoje
                    <a href="{{ url_for('lancamentos') }}" class="ms-auto">Ver »</a>
                </div>
            </div>
        </div>
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="pf-kpi-card">
                <div class="pf-kpi-header">
                    <div>
                        <div class="pf-kpi-label">A Receber no Mês</div>
                    </div>
                    <div class="pf-kpi-icon info"><i class="fas fa-calendar-plus"></i></div>
                </div>
                <div class="pf-kpi-value text-info">R$ {{ "%.2f"|format(total_entrada_mes) }}</div>
                <div class="pf-kpi-footer">
                    <i class="fas fa-calendar"></i> Período selecionado
                    <a href="{{ url_for('lancamentos') }}" class="ms-auto">Ver »</a>
                </div>
            </div>
        </div>
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="pf-kpi-card">
                <div class="pf-kpi-header">
                    <div>
                        <div class="pf-kpi-label">A Pagar no Mês</div>
                    </div>
                    <div class="pf-kpi-icon warning"><i class="fas fa-calendar-minus"></i></div>
                </div>
                <div class="pf-kpi-value text-warning">R$ {{ "%.2f"|format(total_saida_mes) }}</div>
                <div class="pf-kpi-footer">
                    <i class="fas fa-calendar"></i> Período selecionado
                    <a href="{{ url_for('lancamentos') }}" class="ms-auto">Ver »</a>
                </div>
            </div>
        </div>
    </div>

    <!-- ======== STATUS FINANCEIRO ======== -->
    <div class="pf-section-title mb-3">Status Financeiro</div>
    <div class="row g-3 mb-4">
        <div class="col-6 col-md-4 col-lg-2">
            <div class="pf-kpi-card">
                <div class="pf-kpi-header">
                    <div class="pf-kpi-label" style="font-size:0.7rem;">Realizado</div>
                    <div class="pf-kpi-icon teal" style="width:34px;height:34px;font-size:0.9rem;"><i class="fas fa-check-circle"></i></div>
                </div>
                <div class="pf-kpi-value text-success" style="font-size:1.15rem;">R$ {{ "%.2f"|format(total_realizado) }}</div>
                <div class="pf-kpi-footer"><i class="fas fa-check"></i> Confirmado</div>
            </div>
        </div>
        <div class="col-6 col-md-4 col-lg-2">
            <div class="pf-kpi-card">
                <div class="pf-kpi-header">
                    <div class="pf-kpi-label" style="font-size:0.7rem;">A Vencer</div>
                    <div class="pf-kpi-icon warning" style="width:34px;height:34px;font-size:0.9rem;"><i class="fas fa-hourglass-half"></i></div>
                </div>
                <div class="pf-kpi-value text-warning" style="font-size:1.15rem;">R$ {{ "%.2f"|format(total_a_vencer) }}</div>
                <div class="pf-kpi-footer"><i class="fas fa-clock"></i> Próximos</div>
            </div>
        </div>
        <div class="col-6 col-md-4 col-lg-2">
            <div class="pf-kpi-card">
                <div class="pf-kpi-header">
                    <div class="pf-kpi-label" style="font-size:0.7rem;">Vencido</div>
                    <div class="pf-kpi-icon danger" style="width:34px;height:34px;font-size:0.9rem;"><i class="fas fa-exclamation-triangle"></i></div>
                </div>
                <div class="pf-kpi-value text-danger" style="font-size:1.15rem;">R$ {{ "%.2f"|format(total_vencido) }}</div>
                <div class="pf-kpi-footer"><i class="fas fa-times-circle"></i> Em atraso</div>
            </div>
        </div>
        <div class="col-6 col-md-4 col-lg-2">
            <div class="pf-kpi-card">
                <div class="pf-kpi-header">
                    <div class="pf-kpi-label" style="font-size:0.7rem;">Agendado</div>
                    <div class="pf-kpi-icon info" style="width:34px;height:34px;font-size:0.9rem;"><i class="fas fa-calendar-check"></i></div>
                </div>
                <div class="pf-kpi-value text-info" style="font-size:1.15rem;">R$ {{ "%.2f"|format(total_agendado) }}</div>
                <div class="pf-kpi-footer"><i class="fas fa-calendar-alt"></i> Programado</div>
            </div>
        </div>
        <div class="col-6 col-md-4 col-lg-2">
            <div class="pf-kpi-card">
                <div class="pf-kpi-header">
                    <div class="pf-kpi-label" style="font-size:0.7rem;">Total Entradas</div>
                    <div class="pf-kpi-icon success" style="width:34px;height:34px;font-size:0.9rem;"><i class="fas fa-arrow-down"></i></div>
                </div>
                <div class="pf-kpi-value text-success" style="font-size:1.15rem;">R$ {{ "%.2f"|format(total_entradas_periodo) }}</div>
                <div class="pf-kpi-footer"><i class="fas fa-chart-line"></i> No período</div>
            </div>
        </div>
        <div class="col-6 col-md-4 col-lg-2">
            <div class="pf-kpi-card">
                <div class="pf-kpi-header">
                    <div class="pf-kpi-label" style="font-size:0.7rem;">Total Saídas</div>
                    <div class="pf-kpi-icon danger" style="width:34px;height:34px;font-size:0.9rem;"><i class="fas fa-arrow-up"></i></div>
                </div>
                <div class="pf-kpi-value text-danger" style="font-size:1.15rem;">R$ {{ "%.2f"|format(total_saidas_periodo) }}</div>
                <div class="pf-kpi-footer"><i class="fas fa-chart-line"></i> No período</div>
            </div>
        </div>
    </div>

    <!-- ======== GRÁFICOS ======== -->
    <div class="row g-3 mb-4">
        <!-- Gráfico de Barras: Entradas x Saídas -->
        <div class="col-md-8">
            <div class="pf-card">
                <div class="pf-card-header-primary">
                    <h6 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Entradas x Saídas — Evolução Mensal</h6>
                </div>
                <div class="card-body pf-chart-container" style="padding: 16px 20px;">
                    <div style="position:relative; height:220px;">
                        <canvas id="chartEntradasSaidas"></canvas>
                    </div>
                    <div class="pf-chart-legend">
                        <div class="pf-chart-legend-item">
                            <div class="pf-chart-legend-dot" style="background:#43A047;"></div>Entradas
                        </div>
                        <div class="pf-chart-legend-item">
                            <div class="pf-chart-legend-dot" style="background:#E53935;"></div>Saídas
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gráfico de Rosca: Distribuição -->
        <div class="col-md-4">
            <div class="pf-card">
                <div class="pf-card-header-neutral">
                    <h6 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Distribuição</h6>
                </div>
                <div class="card-body d-flex flex-column align-items-center justify-content-center" style="padding: 16px 20px;">
                    <div style="position:relative; height:220px; width:100%;">
                        <canvas id="chartDistribuicao"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ======== CONTAS A RECEBER / PAGAR ======== -->
    <div class="pf-section-title mb-3">Contas do Período</div>
    <div class="d-flex gap-3 mb-4" style="align-items:flex-start;">
        <!-- Contas a Receber -->
        <div style="flex:1;min-width:0;">
            <div class="pf-card">
                <div class="pf-card-header-success">
                    <h6 class="mb-0"><i class="fas fa-arrow-circle-down me-2"></i>Contas a Receber</h6>
                </div>
                <div class="card-body p-0" style="max-height: 380px; overflow-y: auto;">
                    {% if todas_contas_entrada %}
                    <table class="pf-table">
                        <thead>
                            <tr>
                                <th>Descrição</th>
                                <th>Vencimento</th>
                                <th>Valor</th>
                                <th>Status</th>
                                <th class="text-center">Ação</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for conta in todas_contas_entrada %}
                            <tr>
                                <td>
                                    <span title="{{ conta.descricao }}">
                                        {{ conta.descricao[:28] }}{% if conta.descricao|length > 28 %}…{% endif %}
                                    </span>
                                </td>
                                <td style="white-space:nowrap;">{{ conta.data_prevista.strftime('%d/%m/%Y') }}</td>
                                <td class="pf-money pf-money-pos" style="white-space:nowrap;">R$ {{ "%.2f"|format(conta.valor) }}</td>
                                <td>
                                    {% if conta.realizado %}
                                    <span class="pf-badge pf-badge-success"><i class="fas fa-check"></i> Realizado</span>
                                    {% elif conta.data_prevista < hoje %}
                                    <span class="pf-badge pf-badge-danger"><i class="fas fa-times"></i> Vencido</span>
                                    {% elif conta.data_realizada and conta.data_realizada > hoje %}
                                    <span class="pf-badge pf-badge-info"><i class="fas fa-calendar"></i> Agendado</span>
                                    {% else %}
                                    <span class="pf-badge pf-badge-warning"><i class="fas fa-clock"></i> Pendente</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <button type="button"
                                        class="pf-btn pf-btn-sm {{ 'pf-btn-outline' if conta.realizado else 'pf-btn-success' }}"
                                        onclick="toggleLancamentoStatus({{ conta.id }}, {{ 'false' if conta.realizado else 'true' }})"
                                        title="{{ 'Desfazer' if conta.realizado else 'Confirmar' }}"
                                        style="{{ 'color:#666;' if conta.realizado else '' }}">
                                        <i class="fas fa-{{ 'undo' if conta.realizado else 'check' }}"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <div class="text-center py-5" style="color: var(--pf-gray-400);">
                        <i class="fas fa-inbox fa-2x mb-2 d-block"></i>
                        <span style="font-size:0.85rem;">Nenhuma conta a receber no período</span>
                    </div>
                    {% endif %}
                </div>
                <div class="card-footer bg-transparent" style="border-top:1px solid var(--pf-gray-100); padding: 8px 16px;">
                    <a href="{{ url_for('lancamentos') }}" class="pf-btn pf-btn-outline pf-btn-sm">
                        <i class="fas fa-external-link-alt"></i> Ver todos em Lançamentos
                    </a>
                </div>
            </div>
        </div>

        <!-- Contas a Pagar -->
        <div style="flex:1;min-width:0;">
            <div class="pf-card">
                <div class="pf-card-header-danger">
                    <h6 class="mb-0"><i class="fas fa-arrow-circle-up me-2"></i>Contas a Pagar</h6>
                </div>
                <div class="card-body p-0" style="max-height: 380px; overflow-y: auto;">
                    {% if todas_contas_saida %}
                    <table class="pf-table">
                        <thead>
                            <tr>
                                <th>Descrição</th>
                                <th>Vencimento</th>
                                <th>Valor</th>
                                <th>Status</th>
                                <th class="text-center">Ação</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for conta in todas_contas_saida %}
                            <tr>
                                <td>
                                    <span title="{{ conta.descricao }}">
                                        {{ conta.descricao[:28] }}{% if conta.descricao|length > 28 %}…{% endif %}
                                    </span>
                                </td>
                                <td style="white-space:nowrap;">{{ conta.data_prevista.strftime('%d/%m/%Y') }}</td>
                                <td class="pf-money pf-money-neg" style="white-space:nowrap;">R$ {{ "%.2f"|format(conta.valor) }}</td>
                                <td>
                                    {% if conta.realizado %}
                                    <span class="pf-badge pf-badge-success"><i class="fas fa-check"></i> Realizado</span>
                                    {% elif conta.data_prevista < hoje %}
                                    <span class="pf-badge pf-badge-danger"><i class="fas fa-times"></i> Vencido</span>
                                    {% elif conta.data_realizada and conta.data_realizada > hoje %}
                                    <span class="pf-badge pf-badge-info"><i class="fas fa-calendar"></i> Agendado</span>
                                    {% else %}
                                    <span class="pf-badge pf-badge-warning"><i class="fas fa-clock"></i> Pendente</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <button type="button"
                                        class="pf-btn pf-btn-sm {{ 'pf-btn-outline' if conta.realizado else 'pf-btn-success' }}"
                                        onclick="toggleLancamentoStatus({{ conta.id }}, {{ 'false' if conta.realizado else 'true' }})"
                                        title="{{ 'Desfazer' if conta.realizado else 'Confirmar' }}"
                                        style="{{ 'color:#666;' if conta.realizado else '' }}">
                                        <i class="fas fa-{{ 'undo' if conta.realizado else 'check' }}"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <div class="text-center py-5" style="color: var(--pf-gray-400);">
                        <i class="fas fa-inbox fa-2x mb-2 d-block"></i>
                        <span style="font-size:0.85rem;">Nenhuma conta a pagar no período</span>
                    </div>
                    {% endif %}
                </div>
                <div class="card-footer" style="background-color: #fff; border-top:1px solid var(--pf-gray-100); padding: 12px 16px; position: relative; z-index: 10;">
                    <a href="{{ url_for('lancamentos') }}" class="pf-btn pf-btn-outline pf-btn-sm w-100 justify-content-center">
                        <i class="fas fa-external-link-alt"></i> Ver todos em Lançamentos
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- ======== SALDOS POR CONTA-CAIXA ======== -->
    <div class="pf-section-title mb-3">Saldos por Conta-Caixa</div>
    <div class="pf-card mb-4" style="overflow: hidden;">
        <div class="pf-card-header-primary">
            <h6 class="mb-0"><i class="fas fa-wallet me-2"></i>Saldos Consolidados (Apenas Realizados)</h6>
        </div>
        <div class="card-body p-0">
            {% if contas_caixa_resumo %}
            <table class="pf-table mb-0">
                <thead>
                    <tr>
                        <th style="width: 50%;">Conta / Banco</th>
                        <th style="width: 25%;">Tipo</th>
                        <th style="width: 25%; text-align: right;">Saldo Disponível</th>
                    </tr>
                </thead>
                <tbody>
                    {% for conta in contas_caixa_resumo %}
                    <tr>
                        <td>
                            <div class="d-flex align-items-center gap-2">
                                <div class="pf-kpi-icon info" style="width: 32px; height: 32px; font-size: 0.8rem;">
                                    <i class="fas fa-university"></i>
                                </div>
                                <div>
                                    <div class="fw-bold text-dark">{{ conta.nome }}</div>
                                    <div class="small text-muted" style="font-size: 0.75rem;">{{ conta.banco or 'Não informado' }}</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="pf-badge pf-badge-info" style="font-size: 0.75rem;">{{ conta.tipo|replace('_', ' ')|title }}</span>
                        </td>
                        <td class="text-end">
                            <span class="pf-money fs-6 {{ 'pf-money-pos' if conta.saldo >= 0 else 'pf-money-neg' }}">
                                R$ {{ "%.2f"|format(conta.saldo) }}
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="text-center py-5" style="color: var(--pf-gray-400);">
                <i class="fas fa-wallet fa-2x mb-2 d-block"></i>
                <span style="font-size:0.85rem;">Nenhuma conta-caixa encontrada.</span>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- ======== AÇÕES RÁPIDAS ======== -->
    <div class="pf-section-title mb-3">Ações Rápidas</div>
    <div class="row g-2 mb-4">
        <div class="col-6 col-md-3">
            <a href="{{ url_for('novo_lancamento') }}" class="pf-btn pf-btn-primary w-100 justify-content-center py-2">
                <i class="fas fa-plus-circle"></i> Novo Lançamento
            </a>
        </div>
        <div class="col-6 col-md-3">
            <a href="{{ url_for('novo_cliente') }}" class="pf-btn pf-btn-success w-100 justify-content-center py-2">
                <i class="fas fa-user-plus"></i> Novo Cliente
            </a>
        </div>
        <div class="col-6 col-md-3">
            <a href="{{ url_for('nova_venda') }}" class="pf-btn w-100 justify-content-center py-2"
               style="background: linear-gradient(135deg,#1565C0,#1976D2); color:#fff;">
                <i class="fas fa-shopping-cart"></i> Nova Venda
            </a>
        </div>
        <div class="col-6 col-md-3">
            <a href="{{ url_for('nova_compra') }}" class="pf-btn w-100 justify-content-center py-2"
               style="background: linear-gradient(135deg,#6A1B9A,#7B1FA2); color:#fff;">
                <i class="fas fa-shopping-bag"></i> Nova Compra
            </a>
        </div>
    </div>

</div>
<!-- fim dashboard-content -->

{% block scripts %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
// ---- Gráfico de Barras: Entradas x Saídas por mês ----
(function() {
    const ctx = document.getElementById('chartEntradasSaidas');
    if (!ctx) return;

    // Dados passados pelo backend (ou estimativa)
    const meses = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
    const mesAtual = new Date().getMonth();
    const labels = meses.slice(0, mesAtual + 1);

    // Usa dados reais do período se disponíveis
    const totalEnt = {{ total_entradas_periodo | default(0) }};
    const totalSai = {{ total_saidas_periodo | default(0) }};

    // Distribui proporcionalmente para visualização
    const dataEnt = labels.map((_, i) => i === mesAtual ? totalEnt : 0);
    const dataSai = labels.map((_, i) => i === mesAtual ? totalSai : 0);

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Entradas',
                    data: dataEnt,
                    backgroundColor: 'rgba(67, 160, 71, 0.85)',
                    borderColor: '#2E7D32',
                    borderWidth: 1,
                    borderRadius: 5,
                    borderSkipped: false,
                },
                {
                    label: 'Saídas',
                    data: dataSai,
                    backgroundColor: 'rgba(229, 57, 53, 0.85)',
                    borderColor: '#C62828',
                    borderWidth: 1,
                    borderRadius: 5,
                    borderSkipped: false,
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(ctx) {
                            return ctx.dataset.label + ': R$ ' + ctx.parsed.y.toLocaleString('pt-BR', {minimumFractionDigits:2});
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: { display: false },
                    ticks: { font: { size: 11 }, color: '#94A3B8' }
                },
                y: {
                    grid: { color: '#F1F5F9' },
                    ticks: {
                        font: { size: 11 },
                        color: '#94A3B8',
                        callback: function(v) {
                            if (v >= 1000) return 'R$' + (v/1000).toFixed(0) + 'k';
                            return 'R$' + v;
                        }
                    }
                }
            }
        }
    });
})();

// ---- Gráfico de Rosca: Distribuição ----
(function() {
    const ctx = document.getElementById('chartDistribuicao');
    if (!ctx) return;

    const totalEnt = {{ total_entradas_periodo | default(0) }};
    const totalSai = {{ total_saidas_periodo | default(0) }};
    const pendRec  = {{ total_entrada_mes | default(0) }};
    const pendPag  = {{ total_saida_mes | default(0) }};

    const total = totalEnt + totalSai + pendRec + pendPag;

    if (total === 0) {
        ctx.parentElement.innerHTML = '<div class="text-center py-4" style="color:#94A3B8;font-size:0.85rem;"><i class="fas fa-chart-pie fa-2x mb-2 d-block"></i>Sem dados no período</div>';
        return;
    }

    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Entradas Realizadas', 'Saídas Realizadas', 'A Receber', 'A Pagar'],
            datasets: [{
                data: [totalEnt, totalSai, pendRec, pendPag],
                backgroundColor: ['#43A047', '#E53935', '#0288D1', '#FB8C00'],
                borderWidth: 2,
                borderColor: '#fff',
                hoverOffset: 6,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '65%',
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 10,
                        font: { size: 11 },
                        color: '#64748B',
                        boxWidth: 10,
                        boxHeight: 10,
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(ctx) {
                            const val = ctx.parsed;
                            const pct = total > 0 ? ((val / total) * 100).toFixed(1) : 0;
                            return ctx.label + ': R$ ' + val.toLocaleString('pt-BR', {minimumFractionDigits:2}) + ' (' + pct + '%)';
                        }
                    }
                }
            }
        }
    });
})();

// ---- Toggle status lançamento ----
function toggleLancamentoStatus(lancamentoId, novoStatus) {
    fetch(`/lancamentos/${lancamentoId}/toggle-status`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ realizado: novoStatus })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        } else {
            alert('Erro ao atualizar: ' + (data.message || 'Tente novamente'));
        }
    })
    .catch(() => alert('Erro de conexão'));
}
</script>

<style>
/* Garantir visibilidade do dashboard */
.dashboard-content,
.dashboard-content .row,
.dashboard-content .pf-kpi-card,
.dashboard-content .pf-card {
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
}
.dashboard-content .row {
    display: flex !important;
}
.conteudo-row, .conteudo, .all {
    overflow: visible !important;
    height: auto !important;
    max-height: none !important;
}
body { overflow-y: auto !important; overflow-x: hidden !important; }
</style>

<script src="{{ url_for('static', filename='js/pages/dashboard-init.js') }}"></script>
<script src="{{ url_for('static', filename='js/dashboard/hide-empty-cards.js') }}"></script>
{% endblock %}

{% endblock %}
