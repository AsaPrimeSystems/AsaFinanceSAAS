{% extends "base.html" %}

{% block title %}Nova Compra - Sistema de Gest√£o Financeira{% endblock %}

{% block page_title %}Nova Compra{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Registrar Nova Compra</h5>
            </div>
            <div class="card-body">
                <form method="POST">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="fornecedor_id" class="form-label">Fornecedor</label>
                                <div class="autocomplete-container">
                                    <input type="text" class="form-control" id="fornecedor_search"
                                        name="fornecedor_search" placeholder="Digite o nome do fornecedor..."
                                        autocomplete="off" required>
                                    <input type="hidden" id="fornecedor_id" name="fornecedor_id" required>
                                    <div class="autocomplete-suggestions" id="fornecedor_suggestions"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="data_prevista" class="form-label">Data Prevista</label>
                                <input type="text" class="form-control" id="data_prevista" name="data_prevista"
                                    placeholder="__/__/____" pattern="\d{2}/\d{2}/\d{4}" title="Formato: DD/MM/AAAA"
                                    required>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="data_realizada" class="form-label">Data de Realiza√ß√£o (opcional)</label>
                                <input type="text" class="form-control" id="data_realizada" name="data_realizada"
                                    placeholder="__/__/____" pattern="\d{2}/\d{2}/\d{4}" title="Formato: DD/MM/AAAA">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="nota_fiscal" class="form-label">Nota Fiscal (Opcional)</label>
                                <input type="text" class="form-control" id="nota_fiscal" name="nota_fiscal"
                                    placeholder="N√∫mero da NF">
                                <small class="form-text text-muted">N√∫mero da nota fiscal relacionada</small>
                            </div>
                        </div>
                    </div>

                    <div class="card carrinho-card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0">Carrinho</h6>
                        </div>
                        <div class="card-body">
                            <table class="carrinho-table" id="tabela-itens-compra">
                                <thead>
                                    <tr>
                                        <th>Tipo</th>
                                        <th>Produto ou servi√ßo</th>
                                        <th>Pre√ßo unit√°rio</th>
                                        <th>Quantidade</th>
                                        <th>Desconto</th>
                                        <th>Total</th>
                                    </tr>
                                </thead>
                                <tbody id="itens-body-compra">
                                    <tr class="item-row-compra">
                                        <td>
                                            <select class="form-select form-select-sm" name="item_tipo[]">
                                                <option value="mercadoria" selected>Produto</option>
                                                <option value="servico">Servi√ßo</option>
                                            </select>
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-start gap-2">
                                                <div class="autocomplete-container flex-grow-1">
                                                    <input type="text" class="form-control form-control-sm item-nome"
                                                        name="item_nome[]" placeholder="Digite o nome do produto"
                                                        required>
                                                    <div class="autocomplete-suggestions item-suggestions"
                                                        style="display:none;"></div>
                                                </div>
                                                <button type="button"
                                                    class="btn btn-outline-secondary btn-sm input-clear-btn btn-clear-nome"
                                                    title="Limpar campo" data-bs-toggle="tooltip">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                            <small class="text-muted d-block mt-1">Observa√ß√µes adicionais
                                                (opcional)</small>
                                            <input type="text" class="form-control form-control-sm mt-1"
                                                name="item_obs[]" placeholder="">
                                        </td>
                                        <td class="text-end">
                                            <input type="number" step="0.01" min="0"
                                                class="form-control form-control-sm text-end" name="item_preco[]"
                                                value="0.00" inputmode="decimal" required>
                                        </td>
                                        <td class="text-center">
                                            <input type="number" min="1"
                                                class="form-control form-control-sm text-center" name="item_qtd[]"
                                                value="1" required>
                                        </td>
                                        <td class="text-end">
                                            <input type="number" step="0.01" min="0"
                                                class="form-control form-control-sm text-end" name="item_desconto[]"
                                                value="0.00" inputmode="decimal">
                                        </td>
                                        <td class="text-end">
                                            <input type="text" class="form-control form-control-sm text-end"
                                                name="item_total[]" value="0.00" readonly
                                                style="background-color: #f8f9fa; padding-right: 2rem;">
                                            <button type="button" class="carrinho-remove-btn btn-remover-item-compra"
                                                title="Remover item do carrinho" data-bs-toggle="tooltip"
                                                style="display:none;">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="3"></td>
                                        <td class="text-end"><strong>Itens:</strong></td>
                                        <td class="text-center"><strong id="itens-contagem-compra">1</strong></td>
                                        <td class="text-end">
                                            <input type="text" class="form-control form-control-sm text-end"
                                                id="carrinho_total_compra" value="0,00" readonly
                                                style="background-color: #f8f9fa; font-weight: 600;">
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                            <div style="padding: 1rem;">
                                <button type="button" id="btn-adicionar-item-compra" class="btn-adicionar-item"
                                    title="Adicionar novo produto/servi√ßo ao carrinho" data-bs-toggle="tooltip">
                                    <i class="fas fa-plus me-1"></i> Adicionar item
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Campo para mostrar valor total da opera√ß√£o -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Total da Opera√ß√£o</label>
                                <input type="text" class="form-control" id="total_operacao" readonly
                                    style="background-color: #f8f9fa; font-weight: bold;">
                                <small class="form-text text-muted">Quantidade √ó Valor - Desconto (se aplic√°vel)</small>
                            </div>
                        </div>
                    </div>

                    <!-- Novos campos para pagamento parcelado -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="tipo_pagamento" class="form-label">Tipo de Pagamento</label>
                                <select class="form-select" id="tipo_pagamento" name="tipo_pagamento" required>
                                    <option value="a_vista">√Ä Vista</option>
                                    <option value="parcelado">Parcelado</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="numero_parcelas" class="form-label">N√∫mero de Parcelas</label>
                                <input type="number" min="1" max="24" class="form-control" id="numero_parcelas"
                                    name="numero_parcelas" value="1" required>
                            </div>
                        </div>
                    </div>

                    <!-- Configura√ß√£o de vencimentos das parcelas -->
                    <div id="config_parcelas" style="display: none;">
                        <div class="card border-primary">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>Configura√ß√£o de Vencimentos das
                                    Parcelas</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="primeira_parcela" class="form-label">Data da Primeira
                                                Parcela</label>
                                            <input type="text" class="form-control" id="primeira_parcela"
                                                name="primeira_parcela" placeholder="__/__/____"
                                                pattern="\d{2}/\d{2}/\d{4}" title="Formato: DD/MM/AAAA">
                                            <small class="form-text text-muted">Data de vencimento da primeira
                                                parcela</small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="intervalo_parcelas" class="form-label">Periodicidade das
                                                Parcelas</label>
                                            <select class="form-select" id="intervalo_parcelas"
                                                name="intervalo_parcelas">
                                                <option value="mensal" selected>Mensal (30 dias)</option>
                                                <option value="quinzenal">Quinzenal (15 dias)</option>
                                                <option value="semestral">Semestral (180 dias)</option>
                                                <option value="anual">Anual (365 dias)</option>
                                                <option value="personalizado">Personalizado</option>
                                            </select>
                                            <small class="form-text text-muted">Baseado em 365 dias no ano</small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Campo para intervalo personalizado -->
                                <div id="campo_intervalo_personalizado" style="display: none;" class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="intervalo_dias" class="form-label">Intervalo em Dias</label>
                                            <input type="number" class="form-control" id="intervalo_dias"
                                                name="intervalo_dias" min="1" max="365" value="30" placeholder="Ex: 30">
                                            <small class="form-text text-muted">Digite o n√∫mero de dias entre as
                                                parcelas (1 a 365)</small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Tabela de parcelas com vencimentos -->
                                <div id="tabela_parcelas" class="mt-3">
                                    <h6 class="mb-2">Detalhamento das Parcelas:</h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm table-bordered">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Parcela</th>
                                                    <th>Vencimento</th>
                                                    <th>Valor</th>
                                                </tr>
                                            </thead>
                                            <tbody id="parcelas_body">
                                                <!-- Preenchido via JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Campo para sele√ß√£o de conta caixa -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="conta_caixa_id" class="form-label">Conta Caixa (opcional)</label>
                                <select class="form-select" id="conta_caixa_id" name="conta_caixa_id">
                                    <option value="">Selecione uma conta caixa (opcional)</option>
                                    {% for conta in contas_caixa %}
                                    <option value="{{ conta.id }}">{{ conta.nome }} - {{ conta.tipo|title }}</option>
                                    {% endfor %}
                                </select>
                                <small class="form-text text-muted">Selecione a conta caixa onde o lan√ßamento ser√°
                                    registrado. Se n√£o selecionar, o lan√ßamento ser√° criado sem conta
                                    espec√≠fica.</small>
                            </div>
                        </div>
                    </div>

                    <!-- Campo para mostrar valor da parcela -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Valor da Parcela</label>
                                <input type="text" class="form-control" id="valor_parcela" readonly>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="observacoes" class="form-label">Observa√ß√µes</label>
                        <textarea class="form-control" id="observacoes" name="observacoes" rows="3"></textarea>
                    </div>

                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('compras') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Voltar
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Salvar Compra
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    .autocomplete-container {
        position: relative;
    }

    .autocomplete-suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ced4da;
        border-top: none;
        border-radius: 0 0 0.375rem 0.375rem;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
    }

    .autocomplete-suggestion {
        padding: 8px 12px;
        cursor: pointer;
        border-bottom: 1px solid #f8f9fa;
    }

    .autocomplete-suggestion:hover {
        background-color: #f8f9fa;
    }

    .autocomplete-suggestion:last-child {
        border-bottom: none;
    }

    .autocomplete-suggestion.selected {
        background-color: #007bff;
        color: white;
    }

    .autocomplete-suggestion.create-new {
        background-color: #e3f2fd;
        border-left: 3px solid #2196f3;
        font-style: italic;
    }

    .autocomplete-suggestion.create-new:hover {
        background-color: #bbdefb;
    }

    .autocomplete-suggestion.create-new.selected {
        background-color: #2196f3;
        color: white;
    }

    .modal-backdrop {
        z-index: 1040;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Configurar data prevista com valor padr√£o do dia atual
        const dataPrevistaInput = document.getElementById('data_prevista');
        if (dataPrevistaInput && !dataPrevistaInput.value) {
            const hoje = new Date();
            const dia = String(hoje.getDate()).padStart(2, '0');
            const mes = String(hoje.getMonth() + 1).padStart(2, '0');
            const ano = hoje.getFullYear();
            dataPrevistaInput.value = `${dia}/${mes}/${ano}`;
        }

        // Autocomplete para fornecedores
        const fornecedorSearchInput = document.getElementById('fornecedor_search');
        const fornecedorIdInput = document.getElementById('fornecedor_id');
        const fornecedorSuggestions = document.getElementById('fornecedor_suggestions');

        let searchTimeout;
        let selectedIndex = -1;

        // Fun√ß√£o para buscar fornecedores
        function buscarFornecedores(query) {
            if (query.length < 2) {
                fornecedorSuggestions.style.display = 'none';
                return;
            }

            fetch(`/api/fornecedores/buscar?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    mostrarSugestoes(data.fornecedores || [], query);
                })
                .catch(error => {
                    console.error('Erro ao buscar fornecedores:', error);
                    // Mesmo com erro, mostrar op√ß√£o de criar se h√° texto
                    mostrarSugestoes([], query);
                });
        }

        // Fun√ß√£o para mostrar sugest√µes
        function mostrarSugestoes(fornecedores, query) {
            fornecedorSuggestions.innerHTML = '';

            // Adicionar fornecedores encontrados
            fornecedores.forEach((fornecedor, index) => {
                const div = document.createElement('div');
                div.className = 'autocomplete-suggestion';
                div.innerHTML = `
                <strong>${fornecedor.nome}</strong>
                ${fornecedor.email ? `<br><small class="text-muted">${fornecedor.email}</small>` : ''}
                ${fornecedor.telefone ? `<br><small class="text-muted">${fornecedor.telefone}</small>` : ''}
            `;

                div.addEventListener('click', () => {
                    selecionarFornecedor(fornecedor);
                });

                fornecedorSuggestions.appendChild(div);
            });

            // Se n√£o encontrou fornecedores ou encontrou poucos, mostrar op√ß√£o de criar
            if (fornecedores.length === 0 || fornecedores.length < 5) {
                const createDiv = document.createElement('div');
                createDiv.className = 'autocomplete-suggestion create-new';
                createDiv.innerHTML = `
                <i class="fas fa-plus me-2"></i>
                <strong>Criar novo fornecedor: "${query}"</strong>
                <br><small class="text-muted">Clique para criar um novo fornecedor</small>
            `;

                createDiv.addEventListener('click', () => {
                    criarNovoFornecedor(query);
                });

                fornecedorSuggestions.appendChild(createDiv);
            }

            fornecedorSuggestions.style.display = 'block';
            selectedIndex = -1;
        }

        // Fun√ß√£o para selecionar fornecedor
        function selecionarFornecedor(fornecedor) {
            fornecedorSearchInput.value = fornecedor.nome;
            fornecedorIdInput.value = fornecedor.id;
            fornecedorSuggestions.style.display = 'none';
            fornecedorSearchInput.classList.remove('is-invalid');
        }

        // Event listeners para autocomplete
        fornecedorSearchInput.addEventListener('input', function () {
            const query = this.value.trim();

            // Limpar sele√ß√£o se o usu√°rio apagar o texto
            if (query === '') {
                fornecedorIdInput.value = '';
                fornecedorSuggestions.style.display = 'none';
                return;
            }

            // Debounce da busca
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                buscarFornecedores(query);
            }, 300);
        });

        // Event listener para teclado
        fornecedorSearchInput.addEventListener('keydown', function (e) {
            const suggestions = fornecedorSuggestions.querySelectorAll('.autocomplete-suggestion');

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedIndex = Math.min(selectedIndex + 1, suggestions.length - 1);
                atualizarSelecao(suggestions);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedIndex = Math.max(selectedIndex - 1, -1);
                atualizarSelecao(suggestions);
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (selectedIndex >= 0 && suggestions[selectedIndex]) {
                    suggestions[selectedIndex].click();
                }
            } else if (e.key === 'Escape') {
                fornecedorSuggestions.style.display = 'none';
                selectedIndex = -1;
            }
        });

        // Fun√ß√£o para atualizar sele√ß√£o visual
        function atualizarSelecao(suggestions) {
            suggestions.forEach((suggestion, index) => {
                suggestion.classList.toggle('selected', index === selectedIndex);
            });
        }

        // Fun√ß√£o para criar novo fornecedor
        function criarNovoFornecedor(nome) {
            // Mostrar loading na sugest√£o
            const createDiv = fornecedorSuggestions.querySelector('.create-new');
            if (createDiv) {
                createDiv.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Criando fornecedor...';
                createDiv.style.pointerEvents = 'none';
            }

            fetch('/api/fornecedores/criar', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    nome: nome,
                    email: '',
                    telefone: '',
                    cpf_cnpj: '',
                    endereco: ''
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        selecionarFornecedor(data.fornecedor);
                        // Mostrar feedback visual de sucesso
                        fornecedorSearchInput.style.borderColor = '#28a745';
                        setTimeout(() => {
                            fornecedorSearchInput.style.borderColor = '';
                        }, 2000);
                    } else {
                        alert('Erro ao criar fornecedor: ' + data.error);
                        fornecedorSuggestions.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Erro ao criar fornecedor:', error);
                    alert('Erro ao criar fornecedor. Tente novamente.');
                    fornecedorSuggestions.style.display = 'none';
                });
        }

        // Ocultar sugest√µes ao clicar fora
        document.addEventListener('click', function (e) {
            if (!e.target.closest('.autocomplete-container')) {
                fornecedorSuggestions.style.display = 'none';
            }
        });

        // Carrinho
        const itensBody = document.getElementById('itens-body-compra');
        const btnAdd = document.getElementById('btn-adicionar-item-compra');
        const totalCarrinho = document.getElementById('carrinho_total_compra');
        const itensContagem = document.getElementById('itens-contagem-compra');
        const tipoPagamentoSelect = document.getElementById('tipo_pagamento');
        const numeroParcelasInput = document.getElementById('numero_parcelas');
        const valorParcelaInput = document.getElementById('valor_parcela');
        const configParcelasDiv = document.getElementById('config_parcelas');
        const primeiraParcelaInput = document.getElementById('primeira_parcela');
        const intervaloParcelasSelect = document.getElementById('intervalo_parcelas');
        const parcelasBody = document.getElementById('parcelas_body');

        function calcularDoCarrinho() {
            let soma = 0;
            itensBody.querySelectorAll('.item-row-compra').forEach(row => {
                const p = parseFloat(row.querySelector('input[name="item_preco[]"]').value || '0');
                const q = parseFloat(row.querySelector('input[name="item_qtd[]"]').value || '0');
                const d = parseFloat(row.querySelector('input[name="item_desconto[]"]').value || '0');
                const t = Math.max(p * q - d, 0);
                const totalEl = row.querySelector('input[name="item_total[]"]');
                if (totalEl) totalEl.value = t.toFixed(2);
                soma += t;
            });
            if (totalCarrinho) totalCarrinho.value = soma.toFixed(2).replace('.', ',');
            atualizarTotalOperacao(soma);
            calcularValorParcela(soma);
            gerarTabelaParcelas();
        }

        // Fun√ß√£o auxiliar para fazer parse de valor monet√°rio formatado
        function parseValorMonetario(valorFormatado) {
            if (!valorFormatado) return 0;
            // Remove R$ e espa√ßos
            let valor = valorFormatado.replace(/R\$\s?/g, '').trim();
            // Verifica se tem v√≠rgula (formato brasileiro: 6.000,00)
            if (valor.includes(',')) {
                // Formato brasileiro: remove pontos (separadores de milhar) e substitui v√≠rgula por ponto
                valor = valor.replace(/\./g, '').replace(',', '.');
            } else {
                // Formato americano: ponto √© decimal, n√£o remover
                // Mas pode ter pontos como separadores de milhar, ent√£o precisamos verificar
                // Se tem mais de um ponto, s√£o separadores de milhar
                const partes = valor.split('.');
                if (partes.length > 2) {
                    // Tem separadores de milhar, remover todos os pontos
                    valor = valor.replace(/\./g, '');
                }
                // Se tem apenas um ponto, √© decimal, manter
            }
            return parseFloat(valor) || 0;
        }

        // Fun√ß√£o para atualizar total da opera√ß√£o
        function atualizarTotalOperacao(total) {
            const totalOperacao = total || 0;
            const totalOperacaoInput = document.getElementById('total_operacao');
            if (totalOperacaoInput) {
                // Formatar no padr√£o brasileiro: R$ 6.000,00
                totalOperacaoInput.value = `R$ ${totalOperacao.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.')}`;
            }
        }

        // Fun√ß√£o para calcular valor da parcela
        function calcularValorParcela(total) {
            if (!valorParcelaInput || !numeroParcelasInput) return;

            // Se total n√£o foi passado, pegar do campo total_operacao
            let valor = total;
            if (valor === undefined || valor === null) {
                const totalOperacaoInput = document.getElementById('total_operacao');
                if (totalOperacaoInput && totalOperacaoInput.value) {
                    valor = parseValorMonetario(totalOperacaoInput.value);
                } else {
                    valor = 0;
                }
            }

            const numeroParcelas = parseInt(numeroParcelasInput.value) || 1;
            let valorParcela = 0;
            if (numeroParcelas > 0 && valor > 0) {
                valorParcela = valor / numeroParcelas;
            } else if (valor > 0) {
                valorParcela = valor;
            }
            // Formatar no padr√£o brasileiro: R$ 3.000,00
            valorParcelaInput.value = `R$ ${valorParcela.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.')}`;
        }

        // Fun√ß√£o para gerar tabela de parcelas
        function gerarTabelaParcelas() {
            if (!parcelasBody) return;

            const numeroParcelas = parseInt(numeroParcelasInput.value) || 1;
            const primeiraParcela = primeiraParcelaInput.value;
            const intervalo = intervaloParcelasSelect.value;

            if (!primeiraParcela || numeroParcelas <= 1) {
                parcelasBody.innerHTML = '';
                return;
            }

            // Usa o total calculado no carrinho (total_operacao)
            const totalOperacaoInput = document.getElementById('total_operacao');
            const totalOperacao = totalOperacaoInput && totalOperacaoInput.value
                ? parseValorMonetario(totalOperacaoInput.value)
                : 0;
            const valorParcela = numeroParcelas > 0 ? (totalOperacao / numeroParcelas) : totalOperacao;
            let html = '';

            // Fun√ß√£o auxiliar para formatar valor monet√°rio
            function formatarValorMonetario(valor) {
                return `R$ ${valor.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.')}`;
            }

            for (let i = 1; i <= numeroParcelas; i++) {
                const dataVencimento = calcularDataVencimento(primeiraParcela, i, intervalo);
                html += `
                <tr>
                    <td>${i}¬™</td>
                    <td>${formatarData(dataVencimento)}</td>
                    <td>${formatarValorMonetario(valorParcela)}</td>
                </tr>
            `;
            }

            parcelasBody.innerHTML = html;
        }

        // Fun√ß√£o para calcular data de vencimento
        function calcularDataVencimento(dataBase, numeroParcela, intervalo) {
            // Converter data do formato brasileiro (dd/mm/aaaa) para objeto Date
            let data;
            if (typeof dataBase === 'string') {
                const partes = dataBase.split('/');
                if (partes.length === 3) {
                    // Formato brasileiro: dd/mm/aaaa -> mm/dd/aaaa para o JavaScript
                    data = new Date(partes[2], partes[1] - 1, partes[0]);
                } else {
                    data = new Date(dataBase);
                }
            } else {
                data = new Date(dataBase);
            }

            // Se √© a primeira parcela, retornar a data base sem modifica√ß√£o
            if (numeroParcela === 1) {
                return data;
            }

            switch (intervalo) {
                case 'quinzenal':
                    data.setDate(data.getDate() + (15 * (numeroParcela - 1)));
                    break;
                case 'mensal':
                    // Usar c√°lculo baseado em 365 dias por ano (30.42 dias por m√™s)
                    const diasPorMes = 365 / 12;
                    data.setDate(data.getDate() + (diasPorMes * (numeroParcela - 1)));
                    break;
                case 'semestral':
                    data.setDate(data.getDate() + (182 * (numeroParcela - 1))); // 365/2
                    break;
                case 'anual':
                    data.setDate(data.getDate() + (365 * (numeroParcela - 1)));
                    break;
                case 'personalizado':
                    const intervaloDias = parseInt(document.getElementById('intervalo_dias').value) || 30;
                    data.setDate(data.getDate() + (intervaloDias * (numeroParcela - 1)));
                    break;
                default:
                    // Usar c√°lculo baseado em 365 dias por ano (30.42 dias por m√™s)
                    const diasPorMesDefault = 365 / 12;
                    data.setDate(data.getDate() + (diasPorMesDefault * (numeroParcela - 1)));
                    break;
            }

            return data;
        }

        // Fun√ß√£o para formatar data
        function formatarData(data) {
            return data.toLocaleDateString('pt-BR');
        }

        // Fun√ß√£o para mostrar/ocultar configura√ß√£o de parcelas
        function toggleConfigParcelas() {
            const isParcelado = tipoPagamentoSelect.value === 'parcelado';
            const numeroParcelas = parseInt(numeroParcelasInput.value) || 1;

            if (isParcelado && numeroParcelas > 1) {
                configParcelasDiv.style.display = 'block';
                if (!primeiraParcelaInput.value) {
                    // Definir data padr√£o como data atual
                    const hoje = new Date();
                    const dia = String(hoje.getDate()).padStart(2, '0');
                    const mes = String(hoje.getMonth() + 1).padStart(2, '0');
                    const ano = hoje.getFullYear();
                    primeiraParcelaInput.value = `${dia}/${mes}/${ano}`;
                }
                gerarTabelaParcelas();
            } else {
                configParcelasDiv.style.display = 'none';
            }
        }

        // Event listeners para recalcular valores
        // Carrinho listeners
        // Fun√ß√£o para validar estoque (desabilitada para compras - compras aumentam estoque, n√£o diminuem)
        function validarEstoque(row) {
            // N√£o validar estoque em compras
            return;
        }

        // Fun√ß√£o para limpar valida√ß√£o de estoque
        function limparValidacaoEstoque(row) {
            // Limpar qualquer mensagem de erro que possa existir
            const qtdEl = row.querySelector('input[name="item_qtd[]"]');
            const qtdCell = qtdEl ? qtdEl.closest('td') : null;
            if (qtdEl) qtdEl.classList.remove('estoque-invalido');
            if (qtdCell) {
                const errorMsg = qtdCell.querySelector('.estoque-error-message');
                if (errorMsg) errorMsg.remove();
            }
        }

        function bindRow(row) {
            row.querySelectorAll('input').forEach(inp => {
                // Adicionar m√∫ltiplos eventos para garantir rec√°lculo
                inp.addEventListener('input', function () {
                    calcularDoCarrinho();
                    // N√£o validar estoque em compras (compras aumentam estoque, n√£o diminuem)
                });
                // Adicionar evento change para campos que afetam c√°lculo
                if (inp.name === 'item_preco[]' || inp.name === 'item_qtd[]' || inp.name === 'item_desconto[]') {
                    inp.addEventListener('change', calcularDoCarrinho);
                    inp.addEventListener('blur', calcularDoCarrinho);
                }
            });

            // N√£o validar estoque em compras (compras aumentam estoque, n√£o diminuem)
            const btn = row.querySelector('.btn-remover-item-compra');
            btn.addEventListener('click', () => { row.remove(); toggleRemoveButtons(); calcularDoCarrinho(); });
            // Autocomplete quando tipo=mercadoria; texto livre quando servi√ßo
            const tipoSelect = row.querySelector('select[name="item_tipo[]"]');
            const nomeInput = row.querySelector('.item-nome') || row.querySelector('input[name="item_nome[]"]');
            let sugestDiv = row.querySelector('.item-suggestions');
            if (!sugestDiv && nomeInput && nomeInput.parentElement && nomeInput.parentElement.classList.contains('autocomplete-container')) {
                sugestDiv = document.createElement('div');
                sugestDiv.className = 'autocomplete-suggestions item-suggestions';
                sugestDiv.style.display = 'none';
                nomeInput.parentElement.appendChild(sugestDiv);
            }
            function buscarProdutos(query) {
                if (!query || query.length < 2) { if (sugestDiv) { sugestDiv.style.display = 'none'; sugestDiv.innerHTML = ''; } return; }
                if (sugestDiv) {
                    sugestDiv.innerHTML = `<div class="autocomplete-loading"><div class="sugg-icon"><i class="fas fa-box"></i></div><div class="skel" style="max-width:180px"></div></div>`;
                    sugestDiv.style.display = 'block';
                }
                fetch(`/api/produtos/sugestoes?q=${encodeURIComponent(query)}`)
                    .then(r => r.json())
                    .then(data => {
                        const itens = data.produtos || [];
                        if (!sugestDiv) return;
                        sugestDiv.innerHTML = '';
                        itens.forEach(item => {
                            const d = document.createElement('div');
                            d.className = 'autocomplete-suggestion';
                            d.innerHTML = `<div class=\"sugg-left\"><span class=\"sugg-icon\"><i class=\"fas fa-box\"></i></span><span class=\"sugg-title\"><strong>${item.nome}</strong></span></div><div class=\"sugg-meta\">${item.estoque !== undefined ? `<span class=\"badge-pill\">Estoque: ${item.estoque}</span>` : ''}</div>`;
                            d.addEventListener('click', () => {
                                nomeInput.value = item.nome; sugestDiv.style.display = 'none';
                                const precoEl = row.querySelector('input[name="item_preco[]"]');
                                if (precoEl && item.preco_venda) { precoEl.value = item.preco_venda; }
                                // N√£o armazenar estoque em compras (compras aumentam estoque, n√£o diminuem)
                                delete row.dataset.estoque;
                                limparValidacaoEstoque(row);
                                calcularDoCarrinho();
                            });
                            sugestDiv.appendChild(d);
                        });
                        // Op√ß√£o criar produto (s√≥ mostra, n√£o cria ainda - ser√° criado ao salvar)
                        if (query && (itens.length === 0 || itens.length < 5)) {
                            const createDiv = document.createElement('div');
                            createDiv.className = 'autocomplete-suggestion create-new';
                            createDiv.innerHTML = `<i class="fas fa-plus me-2"></i><strong>Criar produto: "${query}"</strong><br><small class="text-muted">Ser√° criado ao salvar o registro</small>`;
                            createDiv.addEventListener('click', function () {
                                nomeInput.value = query;
                                sugestDiv.style.display = 'none';
                                calcularDoCarrinho();
                            });
                            sugestDiv.appendChild(createDiv);
                        }
                        sugestDiv.style.display = 'block';
                    }).catch(() => { if (sugestDiv) { sugestDiv.style.display = 'none'; } });
            }
            function onNomeInput() {
                if (tipoSelect && tipoSelect.value === 'mercadoria') {
                    buscarProdutos((nomeInput?.value || '').trim());
                }
            }
            function toggleAutocomplete() {
                if (!tipoSelect || !nomeInput) return;
                if (tipoSelect.value === 'mercadoria') {
                    nomeInput.setAttribute('placeholder', 'Digite o nome do produto');
                    if (nomeInput.dataset.autocompleteBound !== 'true') {
                        nomeInput.addEventListener('input', onNomeInput);
                        nomeInput.dataset.autocompleteBound = 'true';
                    }
                } else {
                    nomeInput.setAttribute('placeholder', 'Descreva o servi√ßo');
                    if (sugestDiv) { sugestDiv.style.display = 'none'; sugestDiv.innerHTML = ''; }
                    nomeInput.removeEventListener('input', onNomeInput);
                    nomeInput.dataset.autocompleteBound = 'false';
                }
            }
            if (tipoSelect) {
                tipoSelect.addEventListener('change', toggleAutocomplete);
                toggleAutocomplete();
            }
            document.addEventListener('click', function (e) {
                if (sugestDiv && !e.target.closest('.autocomplete-container')) {
                    sugestDiv.style.display = 'none';
                }
            });

            // Configurar bot√£o de limpar campo nome
            const btnClear = row.querySelector('.btn-clear-nome');
            if (btnClear && nomeInput) {
                btnClear.addEventListener('click', function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    nomeInput.value = '';
                    if (sugestDiv) {
                        sugestDiv.style.display = 'none';
                        sugestDiv.innerHTML = '';
                    }
                    calcularDoCarrinho();
                });
            }
        }
        function toggleRemoveButtons() {
            const rows = itensBody.querySelectorAll('.item-row-compra');
            rows.forEach(r => { const b = r.querySelector('.btn-remover-item-compra'); b.style.display = rows.length > 1 ? '' : 'none'; });
            if (itensContagem) itensContagem.textContent = String(rows.length);
        }
        // Configurar bot√£o adicionar item - usar delega√ß√£o de eventos
        console.log('üîç Procurando bot√£o Adicionar Item (Compras)...');
        console.log('btnAdd:', btnAdd);

        // Usar delega√ß√£o de eventos no documento para garantir que funcione
        document.addEventListener('click', function (e) {
            if (e.target && (e.target.id === 'btn-adicionar-item-compra' || e.target.closest('#btn-adicionar-item-compra'))) {
                e.preventDefault();
                e.stopPropagation();
                console.log('‚ûï Bot√£o Adicionar Item (Compras) clicado!');

                if (!itensBody) {
                    console.error('‚ùå itensBody n√£o encontrado!');
                    return;
                }
                const tr = document.createElement('tr');
                tr.className = 'item-row-compra';
                tr.innerHTML = `
                <td>
                    <select class="form-select form-select-sm" name="item_tipo[]">
                        <option value="mercadoria" selected>Produto</option>
                        <option value="servico">Servi√ßo</option>
                    </select>
                </td>
                <td>
                    <div class="d-flex align-items-start gap-2">
                        <div class="autocomplete-container flex-grow-1">
                            <input type="text" class="form-control form-control-sm item-nome" name="item_nome[]" placeholder="Digite o nome do produto" required>
                            <div class="autocomplete-suggestions item-suggestions" style="display:none;"></div>
                        </div>
                        <button type="button" class="btn btn-outline-secondary btn-sm input-clear-btn btn-clear-nome" title="Limpar campo" data-bs-toggle="tooltip">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <small class="text-muted d-block mt-1">Observa√ß√µes adicionais (opcional)</small>
                    <input type="text" class="form-control form-control-sm mt-1" name="item_obs[]" placeholder="">
                </td>
                <td class="text-end">
                    <input type="number" step="0.01" min="0" class="form-control form-control-sm text-end" name="item_preco[]" value="0.00" inputmode="decimal" required>
                </td>
                <td class="text-center">
                    <input type="number" min="1" class="form-control form-control-sm text-center" name="item_qtd[]" value="1" required>
                </td>
                <td class="text-end">
                    <input type="number" step="0.01" min="0" class="form-control form-control-sm text-end" name="item_desconto[]" value="0.00" inputmode="decimal">
                </td>
                <td class="text-end">
                    <input type="text" class="form-control form-control-sm text-end" name="item_total[]" value="0.00" readonly style="background-color: #f8f9fa; padding-right: 2rem;">
                    <button type="button" class="carrinho-remove-btn btn-remover-item-compra" title="Remover item do carrinho" data-bs-toggle="tooltip">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>`;
                itensBody.appendChild(tr);
                bindRow(tr);

                // Inicializar tooltips do Bootstrap
                if (window.bootstrap && bootstrap.Tooltip) {
                    const tooltips = tr.querySelectorAll('[data-bs-toggle="tooltip"]');
                    tooltips.forEach(function (el) {
                        try {
                            new bootstrap.Tooltip(el);
                        } catch (e) {
                            console.warn('Erro ao inicializar tooltip:', e);
                        }
                    });
                }

                // Atualizar bot√µes de remover e c√°lculos
                toggleRemoveButtons();
                calcularDoCarrinho();

                console.log('‚úÖ Item adicionado ao carrinho (Compras). Total de itens:', itensBody.querySelectorAll('.item-row-compra').length);
                // clear btn init
                const clearBtn = tr.querySelector('.btn-clear-nome');
                const nomeInput = tr.querySelector('.item-nome');
                const sug = tr.querySelector('.item-suggestions');
                if (clearBtn && nomeInput) {
                    clearBtn.addEventListener('click', () => { nomeInput.value = ''; if (sug) { sug.style.display = 'none'; sug.innerHTML = ''; } calcularDoCarrinho(); });
                }
            }
        });

        // Tamb√©m adicionar listener direto se o bot√£o existir
        if (btnAdd && itensBody) {
            console.log('‚úÖ Bot√£o Adicionar Item (Compras) encontrado, adicionando listener direto...');
            btnAdd.addEventListener('click', function (e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('‚ûï Bot√£o clicado (listener direto - Compras)...');
                // Reutilizar o mesmo c√≥digo da delega√ß√£o acima
                const tr = document.createElement('tr');
                tr.className = 'item-row-compra';
                tr.innerHTML = `
                <td>
                    <select class="form-select form-select-sm" name="item_tipo[]">
                        <option value="mercadoria" selected>Produto</option>
                        <option value="servico">Servi√ßo</option>
                    </select>
                </td>
                <td>
                    <div class="d-flex align-items-start gap-2">
                        <div class="autocomplete-container flex-grow-1">
                            <input type="text" class="form-control form-control-sm item-nome" name="item_nome[]" placeholder="Digite o nome do produto" required>
                            <div class="autocomplete-suggestions item-suggestions" style="display:none;"></div>
                        </div>
                        <button type="button" class="btn btn-outline-secondary btn-sm input-clear-btn btn-clear-nome" title="Limpar campo" data-bs-toggle="tooltip">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <small class="text-muted d-block mt-1">Observa√ß√µes adicionais (opcional)</small>
                    <input type="text" class="form-control form-control-sm mt-1" name="item_obs[]" placeholder="">
                </td>
                <td class="text-end">
                    <input type="number" step="0.01" min="0" class="form-control form-control-sm text-end" name="item_preco[]" value="0.00" inputmode="decimal" required>
                </td>
                <td class="text-center">
                    <input type="number" min="1" class="form-control form-control-sm text-center" name="item_qtd[]" value="1" required>
                </td>
                <td class="text-end">
                    <input type="number" step="0.01" min="0" class="form-control form-control-sm text-end" name="item_desconto[]" value="0.00" inputmode="decimal">
                </td>
                <td class="text-end">
                    <input type="text" class="form-control form-control-sm text-end" name="item_total[]" value="0.00" readonly style="background-color: #f8f9fa; padding-right: 2rem;">
                    <button type="button" class="carrinho-remove-btn btn-remover-item-compra" title="Remover item do carrinho" data-bs-toggle="tooltip">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>`;
                itensBody.appendChild(tr);
                bindRow(tr);
                if (window.bootstrap && bootstrap.Tooltip) {
                    const tooltips = tr.querySelectorAll('[data-bs-toggle="tooltip"]');
                    tooltips.forEach(function (el) {
                        try { new bootstrap.Tooltip(el); } catch (e) { console.warn('Erro ao inicializar tooltip:', e); }
                    });
                }
                toggleRemoveButtons();
                calcularDoCarrinho();
                const clearBtn = tr.querySelector('.btn-clear-nome');
                const nomeInput = tr.querySelector('.item-nome');
                const sug = tr.querySelector('.item-suggestions');
                if (clearBtn && nomeInput) {
                    clearBtn.addEventListener('click', () => { nomeInput.value = ''; if (sug) { sug.style.display = 'none'; sug.innerHTML = ''; } calcularDoCarrinho(); });
                }
            });
        }

        // Bind inicial da primeira linha
        const firstRow = itensBody.querySelector('.item-row-compra');
        if (firstRow) {
            bindRow(firstRow);
            toggleRemoveButtons();
        }
        numeroParcelasInput.addEventListener('input', function () {
            const totalOperacaoInput = document.getElementById('total_operacao');
            const total = totalOperacaoInput && totalOperacaoInput.value
                ? parseValorMonetario(totalOperacaoInput.value)
                : 0;
            calcularValorParcela(total);
            toggleConfigParcelas();
            gerarTabelaParcelas();
        });

        // Mostrar/ocultar campos de parcelas baseado no tipo de pagamento
        tipoPagamentoSelect.addEventListener('change', function () {
            const isParcelado = this.value === 'parcelado';
            numeroParcelasInput.disabled = !isParcelado;
            if (!isParcelado) {
                numeroParcelasInput.value = '1';
            }
            const totalOperacaoInput = document.getElementById('total_operacao');
            const total = totalOperacaoInput && totalOperacaoInput.value
                ? parseValorMonetario(totalOperacaoInput.value)
                : 0;
            calcularValorParcela(total);
            toggleConfigParcelas();
            gerarTabelaParcelas();
        });

        // Event listeners para configura√ß√£o de parcelas
        primeiraParcelaInput.addEventListener('input', gerarTabelaParcelas);
        primeiraParcelaInput.addEventListener('change', gerarTabelaParcelas);
        intervaloParcelasSelect.addEventListener('change', function () {
            const campoPersonalizado = document.getElementById('campo_intervalo_personalizado');
            const isPersonalizado = this.value === 'personalizado';

            if (campoPersonalizado) {
                campoPersonalizado.style.display = isPersonalizado ? 'block' : 'none';
            }

            gerarTabelaParcelas();
        });

        // Event listener para intervalo personalizado
        const intervaloDiasInput = document.getElementById('intervalo_dias');
        if (intervaloDiasInput) {
            intervaloDiasInput.addEventListener('input', function () {
                // Validar valor entre 1 e 365
                const valor = parseInt(this.value);
                if (valor < 1) {
                    this.value = 1;
                } else if (valor > 365) {
                    this.value = 365;
                }

                // Recalcular parcelas
                gerarTabelaParcelas();
            });
        }

        // Inicializar
        if (window.bootstrap && bootstrap.Tooltip) {
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.forEach(el => new bootstrap.Tooltip(el));
        }
        calcularDoCarrinho();
        toggleConfigParcelas();
        // Garantir que o valor da parcela seja calculado na inicializa√ß√£o
        const totalOperacaoInput = document.getElementById('total_operacao');
        if (totalOperacaoInput && totalOperacaoInput.value) {
            const total = parseValorMonetario(totalOperacaoInput.value);
            calcularValorParcela(total);
        }
        // Garantir que a tabela seja gerada se j√° houver dados
        if (tipoPagamentoSelect && tipoPagamentoSelect.value === 'parcelado') {
            const numeroParcelas = parseInt(numeroParcelasInput.value) || 1;
            if (numeroParcelas > 1 && primeiraParcelaInput && primeiraParcelaInput.value) {
                gerarTabelaParcelas();
            }
        }
    });
</script>
<script>
    // Script de seguran√ßa para resolver problema de tela travada
    document.addEventListener('DOMContentLoaded', function () {
        // Remover qualquer overlay/modal travado ao pressionar ESC
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                // Remover overlays de loading
                document.querySelectorAll('.modal-backdrop, .loading-overlay, .spinner-overlay').forEach(el => {
                    console.log('Removendo overlay:', el.className);
                    el.remove();
                });
                // Fechar modais do Bootstrap
                const modals = document.querySelectorAll('.modal.show');
                modals.forEach(modal => {
                    const bsModal = bootstrap.Modal.getInstance(modal);
                    if (bsModal) bsModal.hide();
                });
                // Restaurar scroll do body
                document.body.style.overflow = '';
                document.body.classList.remove('modal-open');
            }
        });

        // Timeout de seguran√ßa para remover loading ap√≥s 30 segundos
        setTimeout(function () {
            document.querySelectorAll('.loading-overlay, .spinner-overlay, .modal-backdrop').forEach(el => {
                if (el.style.display !== 'none' && window.getComputedStyle(el).display !== 'none') {
                    console.warn('Overlay removido por timeout de seguran√ßa:', el.className);
                    el.remove();
                    document.body.style.overflow = '';
                    document.body.classList.remove('modal-open');
                }
            });
        }, 30000);

        // Bot√£o de emerg√™ncia (duplo clique em qualquer lugar)
        let clickCount = 0;
        let clickTimer = null;
        document.addEventListener('click', function (e) {
            clickCount++;
            if (clickCount === 1) {
                clickTimer = setTimeout(function () {
                    clickCount = 0;
                }, 500);
            } else if (clickCount === 3) {
                // Triplo clique remove todos os overlays
                clearTimeout(clickTimer);
                clickCount = 0;
                document.querySelectorAll('.modal-backdrop, .loading-overlay, .spinner-overlay').forEach(el => el.remove());
                document.body.style.overflow = '';
                document.body.classList.remove('modal-open');
                console.log('Overlays removidos por triplo clique de emerg√™ncia');
            }
        });
    });
</script>
{% endblock %}