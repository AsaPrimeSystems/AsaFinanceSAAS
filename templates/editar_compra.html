{% extends "base.html" %}

{% block title %}Editar Compra - Sistema de Gestão Financeira{% endblock %}

{% block page_title %}Editar Compra{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0 d-flex align-items-center justify-content-between flex-wrap">
                    <span>
                        Editar Compra
                        <span class="badge bg-warning text-dark ms-2">ID: {{ compra.id }}</span>
                    </span>
                    {% if lancamentos_vinculados_ids and lancamentos_vinculados_ids|length > 0 %}
                    <span class="badge bg-primary">
                        <i class="fas fa-link me-1"></i>Lançamentos Vinculados:
                        {% for lanc_id in lancamentos_vinculados_ids %}
                        {{ lanc_id }}{% if not loop.last %}, {% endif %}
                        {% endfor %}
                    </span>
                    {% endif %}
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('editar_compra', compra_id=compra.id) }}">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="fornecedor_id" class="form-label">Fornecedor *</label>
                                <div class="autocomplete-container">
                                    <input type="text" class="form-control" id="fornecedor_search"
                                        name="fornecedor_search" placeholder="Digite o nome do fornecedor..."
                                        autocomplete="off" required
                                        value="{{ compra.fornecedor.nome if compra.fornecedor else '' }}">
                                    <input type="hidden" id="fornecedor_id" name="fornecedor_id" required
                                        value="{{ compra.fornecedor_id }}">
                                    <div class="autocomplete-suggestions" id="fornecedor_suggestions"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="data_prevista" class="form-label">Data Prevista *</label>
                                <input type="text" class="form-control" id="data_prevista" name="data_prevista"
                                    value="{{ compra.data_prevista.strftime('%d/%m/%Y') }}" placeholder="__/__/____"
                                    pattern="\d{2}/\d{2}/\d{4}" title="Formato: DD/MM/AAAA" required>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="data_realizada" class="form-label">Data de Realização (opcional)</label>
                                <input type="text" class="form-control" id="data_realizada" name="data_realizada"
                                    value="{{ compra.data_realizada.strftime('%d/%m/%Y') if compra.data_realizada else '' }}"
                                    placeholder="__/__/____" pattern="\d{2}/\d{2}/\d{4}" title="Formato: DD/MM/AAAA">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="nota_fiscal" class="form-label">Nota Fiscal (Opcional)</label>
                                <input type="text" class="form-control" id="nota_fiscal" name="nota_fiscal"
                                    placeholder="Número da NF" value="{{ compra.nota_fiscal or '' }}">
                                <small class="form-text text-muted">Número da nota fiscal relacionada</small>
                            </div>
                        </div>
                    </div>

                    <div class="card carrinho-card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0">Carrinho</h6>
                        </div>
                        <div class="card-body">
                            <table class="carrinho-table" id="tabela-itens-compra">
                                <thead>
                                    <tr>
                                        <th>Tipo</th>
                                        <th>Produto ou serviço</th>
                                        <th>Preço unitário</th>
                                        <th>Quantidade</th>
                                        <th>Desconto</th>
                                        <th>Total</th>
                                    </tr>
                                </thead>
                                <tbody id="itens-body-compra">
                                    <!-- Preenchido via JavaScript com dados existentes -->
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="3"></td>
                                        <td class="text-end"><strong>Itens:</strong></td>
                                        <td class="text-center"><strong id="itens-contagem-compra">0</strong></td>
                                        <td class="text-end">
                                            <input type="text" class="form-control form-control-sm text-end"
                                                id="carrinho_total_compra" value="0,00" readonly
                                                style="background-color: #f8f9fa; font-weight: 600;">
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                            <div style="padding: 1rem;">
                                <button type="button" id="btn-adicionar-item-compra" class="btn-adicionar-item"
                                    title="Adicionar novo produto/serviço ao carrinho" data-bs-toggle="tooltip">
                                    <i class="fas fa-plus me-1"></i> Adicionar item
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Campo para mostrar valor total da operação -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Total da Operação</label>
                                <input type="text" class="form-control" id="total_operacao" readonly
                                    style="background-color: #f8f9fa; font-weight: bold;">
                                <small class="form-text text-muted">Quantidade × Valor - Desconto (se aplicável)</small>
                            </div>
                        </div>
                    </div>

                    <!-- Campos para pagamento -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="tipo_pagamento" class="form-label">Tipo de Pagamento *</label>
                                <select class="form-select" id="tipo_pagamento" name="tipo_pagamento" required>
                                    <option value="a_vista" {% if compra.tipo_pagamento=='a_vista' %}selected{% endif
                                        %}>À Vista</option>
                                    <option value="parcelado" {% if compra.tipo_pagamento=='parcelado' %}selected{%
                                        endif %}>Parcelado</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="numero_parcelas" class="form-label">Número de Parcelas *</label>
                                <input type="number" min="1" max="24" class="form-control" id="numero_parcelas"
                                    name="numero_parcelas" value="{{ compra.numero_parcelas or 1 }}" required>
                            </div>
                        </div>
                    </div>

                    <!-- Configuração de vencimentos das parcelas -->
                    <div id="config_parcelas" style="display: none;">
                        <div class="card border-primary">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>Configuração de Vencimentos das
                                    Parcelas</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="primeira_parcela" class="form-label">Data da Primeira
                                                Parcela</label>
                                            <input type="text" class="form-control" id="primeira_parcela"
                                                name="primeira_parcela" placeholder="__/__/____"
                                                pattern="\d{2}/\d{2}/\d{4}" title="Formato: DD/MM/AAAA">
                                            <small class="form-text text-muted">Data de vencimento da primeira
                                                parcela</small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="intervalo_parcelas" class="form-label">Periodicidade das
                                                Parcelas</label>
                                            <select class="form-select" id="intervalo_parcelas"
                                                name="intervalo_parcelas">
                                                <option value="mensal" selected>Mensal (30 dias)</option>
                                                <option value="quinzenal">Quinzenal (15 dias)</option>
                                                <option value="semestral">Semestral (180 dias)</option>
                                                <option value="anual">Anual (365 dias)</option>
                                                <option value="personalizado">Personalizado</option>
                                            </select>
                                            <small class="form-text text-muted">Baseado em 365 dias no ano</small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Campo para intervalo personalizado -->
                                <div id="campo_intervalo_personalizado" style="display: none;" class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="intervalo_dias" class="form-label">Intervalo em Dias</label>
                                            <input type="number" class="form-control" id="intervalo_dias"
                                                name="intervalo_dias" min="1" max="365" value="30" placeholder="Ex: 30">
                                            <small class="form-text text-muted">Digite o número de dias entre as
                                                parcelas (1 a 365)</small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Tabela de parcelas com vencimentos -->
                                <div id="tabela_parcelas" class="mt-3">
                                    <h6 class="mb-2">Detalhamento das Parcelas:</h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm table-bordered">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Parcela</th>
                                                    <th>Vencimento</th>
                                                    <th>Valor</th>
                                                </tr>
                                            </thead>
                                            <tbody id="parcelas_body">
                                                <!-- Preenchido via JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Campo para mostrar valor da parcela -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Valor da Parcela</label>
                                <input type="text" class="form-control" id="valor_parcela" readonly
                                    style="background-color: #f8f9fa; color: #6c757d;">
                                <small class="form-text text-muted">Valor dividido pelo número de parcelas</small>
                            </div>
                        </div>
                    </div>

                    <!-- Campo para seleção de conta caixa -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="conta_caixa_id" class="form-label">Conta Caixa (opcional)</label>
                                <select class="form-select" id="conta_caixa_id" name="conta_caixa_id">
                                    <option value="">Selecione uma conta caixa (opcional)</option>
                                    {% for conta in contas_caixa %}
                                    <option value="{{ conta.id }}" {% if compra.lancamento_financeiro and
                                        compra.lancamento_financeiro.conta_caixa_id==conta.id %}selected{% endif %}>{{
                                        conta.nome }} - {{ conta.tipo|title }}</option>
                                    {% endfor %}
                                </select>
                                <small class="form-text text-muted">Selecione a conta caixa onde o lançamento será
                                    registrado. Se não selecionar, o lançamento será criado sem conta
                                    específica.</small>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="observacoes" class="form-label">Observações</label>
                        <textarea class="form-control" id="observacoes" name="observacoes"
                            rows="3">{{ compra.observacoes or '' }}</textarea>
                    </div>

                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('compras') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Voltar
                        </a>
                        <button type="submit" class="btn btn-primary" id="btn-salvar-compra">
                            <i class="fas fa-save"></i> Salvar Alterações
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    .autocomplete-container {
        position: relative;
    }

    .autocomplete-suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ced4da;
        border-top: none;
        border-radius: 0 0 0.375rem 0.375rem;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
    }

    .autocomplete-suggestion {
        padding: 8px 12px;
        cursor: pointer;
        border-bottom: 1px solid #f8f9fa;
    }

    .autocomplete-suggestion:hover {
        background-color: #f8f9fa;
    }

    .autocomplete-suggestion:last-child {
        border-bottom: none;
    }

    .autocomplete-suggestion.selected {
        background-color: #007bff;
        color: white;
    }

    .autocomplete-suggestion.create-new {
        background-color: #e3f2fd;
        border-left: 3px solid #2196f3;
        font-style: italic;
    }

    .autocomplete-suggestion.create-new:hover {
        background-color: #bbdefb;
    }

    .autocomplete-suggestion.create-new.selected {
        background-color: #2196f3;
        color: white;
    }

    .modal-backdrop {
        z-index: 1040;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        console.log('Página carregada - iniciando JavaScript');

        // Autocomplete para fornecedores
        const fornecedorSearchInput = document.getElementById('fornecedor_search');
        const fornecedorIdInput = document.getElementById('fornecedor_id');
        const fornecedorSuggestions = document.getElementById('fornecedor_suggestions');

        let searchTimeout;
        let selectedIndex = -1;

        // Função para buscar fornecedores
        function buscarFornecedores(query) {
            if (query.length < 2) {
                fornecedorSuggestions.style.display = 'none';
                return;
            }

            fetch(`/api/fornecedores/buscar?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    mostrarSugestoes(data.fornecedores || [], query);
                })
                .catch(error => {
                    console.error('Erro ao buscar fornecedores:', error);
                    // Mesmo com erro, mostrar opção de criar se há texto
                    mostrarSugestoes([], query);
                });
        }

        // Função para mostrar sugestões
        function mostrarSugestoes(fornecedores, query) {
            fornecedorSuggestions.innerHTML = '';

            // Adicionar fornecedores encontrados
            fornecedores.forEach((fornecedor, index) => {
                const div = document.createElement('div');
                div.className = 'autocomplete-suggestion';
                div.innerHTML = `
                <strong>${fornecedor.nome}</strong>
                ${fornecedor.email ? `<br><small class="text-muted">${fornecedor.email}</small>` : ''}
                ${fornecedor.telefone ? `<br><small class="text-muted">${fornecedor.telefone}</small>` : ''}
            `;

                div.addEventListener('click', () => {
                    selecionarFornecedor(fornecedor);
                });

                fornecedorSuggestions.appendChild(div);
            });

            // Se não encontrou fornecedores ou encontrou poucos, mostrar opção de criar
            if (fornecedores.length === 0 || fornecedores.length < 5) {
                const createDiv = document.createElement('div');
                createDiv.className = 'autocomplete-suggestion create-new';
                createDiv.innerHTML = `
                <i class="fas fa-plus me-2"></i>
                <strong>Criar novo fornecedor: "${query}"</strong>
                <br><small class="text-muted">Clique para criar um novo fornecedor</small>
            `;

                createDiv.addEventListener('click', () => {
                    criarNovoFornecedor(query);
                });

                fornecedorSuggestions.appendChild(createDiv);
            }

            fornecedorSuggestions.style.display = 'block';
            selectedIndex = -1;
        }

        // Função para selecionar fornecedor
        function selecionarFornecedor(fornecedor) {
            fornecedorSearchInput.value = fornecedor.nome;
            fornecedorIdInput.value = fornecedor.id;
            fornecedorSuggestions.style.display = 'none';
            fornecedorSearchInput.classList.remove('is-invalid');
        }

        // Event listeners para autocomplete
        fornecedorSearchInput.addEventListener('input', function () {
            const query = this.value.trim();

            // Limpar seleção se o usuário apagar o texto
            if (query === '') {
                fornecedorIdInput.value = '';
                fornecedorSuggestions.style.display = 'none';
                return;
            }

            // Debounce da busca
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                buscarFornecedores(query);
            }, 300);
        });

        // Event listener para teclado
        fornecedorSearchInput.addEventListener('keydown', function (e) {
            const suggestions = fornecedorSuggestions.querySelectorAll('.autocomplete-suggestion');

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedIndex = Math.min(selectedIndex + 1, suggestions.length - 1);
                atualizarSelecao(suggestions);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedIndex = Math.max(selectedIndex - 1, -1);
                atualizarSelecao(suggestions);
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (selectedIndex >= 0 && suggestions[selectedIndex]) {
                    suggestions[selectedIndex].click();
                }
            } else if (e.key === 'Escape') {
                fornecedorSuggestions.style.display = 'none';
                selectedIndex = -1;
            }
        });

        // Função para atualizar seleção visual
        function atualizarSelecao(suggestions) {
            suggestions.forEach((suggestion, index) => {
                suggestion.classList.toggle('selected', index === selectedIndex);
            });
        }

        // Função para criar novo fornecedor
        function criarNovoFornecedor(nome) {
            // Mostrar loading na sugestão
            const createDiv = fornecedorSuggestions.querySelector('.create-new');
            if (createDiv) {
                createDiv.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Criando fornecedor...';
                createDiv.style.pointerEvents = 'none';
            }

            fetch('/api/fornecedores/criar', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    nome: nome,
                    email: '',
                    telefone: '',
                    cpf_cnpj: '',
                    endereco: ''
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        selecionarFornecedor(data.fornecedor);
                        // Mostrar feedback visual de sucesso
                        fornecedorSearchInput.style.borderColor = '#28a745';
                        setTimeout(() => {
                            fornecedorSearchInput.style.borderColor = '';
                        }, 2000);
                    } else {
                        alert('Erro ao criar fornecedor: ' + data.error);
                        fornecedorSuggestions.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Erro ao criar fornecedor:', error);
                    alert('Erro ao criar fornecedor. Tente novamente.');
                    fornecedorSuggestions.style.display = 'none';
                });
        }

        // Ocultar sugestões ao clicar fora
        document.addEventListener('click', function (e) {
            if (!e.target.closest('.autocomplete-container')) {
                fornecedorSuggestions.style.display = 'none';
            }
        });

        // Dados da compra existente para preencher o carrinho
        var compraData = {
            produto: '{{ compra.produto|e }}',
            valor: {{ compra.valor }},
            quantidade: {{ compra.quantidade or 1 }},
        preco_custo: {{ compra.preco_custo }},
        tipo_compra: '{{ compra.tipo_compra }}'
    };

    // Carrinho
    const itensBody = document.getElementById('itens-body-compra');
    const btnAdd = document.getElementById('btn-adicionar-item-compra');
    const totalCarrinho = document.getElementById('carrinho_total_compra');
    const itensContagem = document.getElementById('itens-contagem-compra');
    const tipoPagamentoSelect = document.getElementById('tipo_pagamento');
    const numeroParcelasInput = document.getElementById('numero_parcelas');
    const valorParcelaInput = document.getElementById('valor_parcela');
    const configParcelasDiv = document.getElementById('config_parcelas');
    const primeiraParcelaInput = document.getElementById('primeira_parcela');
    const intervaloParcelasSelect = document.getElementById('intervalo_parcelas');
    const parcelasBody = document.getElementById('parcelas_body');

    function calcularDoCarrinho() {
        let soma = 0;
        if (itensBody) {
            itensBody.querySelectorAll('.item-row-compra').forEach(row => {
                const p = parseFloat(row.querySelector('input[name="item_preco[]"]')?.value || '0');
                const q = parseFloat(row.querySelector('input[name="item_qtd[]"]')?.value || '0');
                const d = parseFloat(row.querySelector('input[name="item_desconto[]"]')?.value || '0');
                const t = Math.max(p * q - d, 0);
                const totalEl = row.querySelector('input[name="item_total[]"]');
                if (totalEl) totalEl.value = t.toFixed(2);
                soma += t;
            });
        }
        if (totalCarrinho) totalCarrinho.value = soma.toFixed(2).replace('.', ',');
        atualizarTotalOperacao(soma);
        calcularValorParcela(soma);
        gerarTabelaParcelas();
    }

    // Função auxiliar para fazer parse de valor monetário formatado
    function parseValorMonetario(valorFormatado) {
        if (!valorFormatado) return 0;
        let valor = valorFormatado.replace(/R\$\s?/g, '').trim();
        if (valor.includes(',')) {
            valor = valor.replace(/\./g, '').replace(',', '.');
        } else {
            const partes = valor.split('.');
            if (partes.length > 2) {
                valor = valor.replace(/\./g, '');
            }
        }
        return parseFloat(valor) || 0;
    }

    // Função para atualizar total da operação
    function atualizarTotalOperacao(total) {
        const totalOperacao = total || 0;
        const totalOperacaoInput = document.getElementById('total_operacao');
        if (totalOperacaoInput) {
            totalOperacaoInput.value = `R$ ${totalOperacao.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.')}`;
        }
    }

    // Função para calcular valor da parcela
    function calcularValorParcela(total) {
        if (!valorParcelaInput || !numeroParcelasInput) return;
        let valor = total;
        if (valor === undefined || valor === null) {
            const totalOperacaoInput = document.getElementById('total_operacao');
            if (totalOperacaoInput && totalOperacaoInput.value) {
                valor = parseValorMonetario(totalOperacaoInput.value);
            } else {
                valor = 0;
            }
        }
        const numeroParcelas = parseInt(numeroParcelasInput.value) || 1;
        let valorParcela = 0;
        if (numeroParcelas > 0 && valor > 0) {
            valorParcela = valor / numeroParcelas;
        } else if (valor > 0) {
            valorParcela = valor;
        }
        valorParcelaInput.value = `R$ ${valorParcela.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.')}`;
    }

    // Função para gerar tabela de parcelas
    function gerarTabelaParcelas() {
        if (!parcelasBody) return;
        const numeroParcelas = parseInt(numeroParcelasInput.value) || 1;
        const primeiraParcela = primeiraParcelaInput.value;
        const intervalo = intervaloParcelasSelect.value;
        if (!primeiraParcela || numeroParcelas <= 1) {
            parcelasBody.innerHTML = '';
            return;
        }
        const totalOperacaoInput = document.getElementById('total_operacao');
        const totalOperacao = totalOperacaoInput && totalOperacaoInput.value
            ? parseValorMonetario(totalOperacaoInput.value)
            : 0;
        const valorParcela = numeroParcelas > 0 ? (totalOperacao / numeroParcelas) : totalOperacao;
        let html = '';
        function formatarValorMonetario(valor) {
            return `R$ ${valor.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.')}`;
        }
        for (let i = 1; i <= numeroParcelas; i++) {
            const dataVencimento = calcularDataVencimento(primeiraParcela, i, intervalo);
            html += `<tr><td>${i}ª</td><td>${formatarData(dataVencimento)}</td><td>${formatarValorMonetario(valorParcela)}</td></tr>`;
        }
        parcelasBody.innerHTML = html;
    }

    // Função para calcular data de vencimento
    function calcularDataVencimento(dataBase, numeroParcela, intervalo) {
        let data;
        if (typeof dataBase === 'string') {
            const partes = dataBase.split('/');
            if (partes.length === 3) {
                data = new Date(partes[2], partes[1] - 1, partes[0]);
            } else {
                data = new Date(dataBase);
            }
        } else {
            data = new Date(dataBase);
        }
        if (numeroParcela === 1) {
            return data;
        }
        switch (intervalo) {
            case 'quinzenal':
                data.setDate(data.getDate() + (15 * (numeroParcela - 1)));
                break;
            case 'mensal':
                const diasPorMes = 365 / 12;
                data.setDate(data.getDate() + (diasPorMes * (numeroParcela - 1)));
                break;
            case 'semestral':
                data.setDate(data.getDate() + (182 * (numeroParcela - 1)));
                break;
            case 'anual':
                data.setDate(data.getDate() + (365 * (numeroParcela - 1)));
                break;
            case 'personalizado':
                const intervaloDias = parseInt(document.getElementById('intervalo_dias').value) || 30;
                data.setDate(data.getDate() + (intervaloDias * (numeroParcela - 1)));
                break;
            default:
                const diasPorMesDefault = 365 / 12;
                data.setDate(data.getDate() + (diasPorMesDefault * (numeroParcela - 1)));
                break;
        }
        return data;
    }

    // Função para formatar data
    function formatarData(data) {
        return data.toLocaleDateString('pt-BR');
    }

    // Função para mostrar/ocultar configuração de parcelas
    function toggleConfigParcelas() {
        const isParcelado = tipoPagamentoSelect.value === 'parcelado';
        const numeroParcelas = parseInt(numeroParcelasInput.value) || 1;
        if (isParcelado && numeroParcelas > 1) {
            configParcelasDiv.style.display = 'block';
            if (!primeiraParcelaInput.value) {
                const hoje = new Date();
                const dia = String(hoje.getDate()).padStart(2, '0');
                const mes = String(hoje.getMonth() + 1).padStart(2, '0');
                const ano = hoje.getFullYear();
                primeiraParcelaInput.value = `${dia}/${mes}/${ano}`;
            }
            gerarTabelaParcelas();
        } else {
            configParcelasDiv.style.display = 'none';
        }
    }

    // Função para validar estoque
    function validarEstoque(row) {
        const qtdEl = row.querySelector('input[name="item_qtd[]"]');
        const estoque = parseFloat(row.dataset.estoque);
        const quantidade = parseFloat(qtdEl.value) || 0;
        const qtdCell = qtdEl.closest('td');
        let errorMsg = qtdCell.querySelector('.estoque-error-message');
        if (!isNaN(estoque) && quantidade > estoque) {
            qtdEl.classList.add('estoque-invalido');
            if (!errorMsg) {
                errorMsg = document.createElement('small');
                errorMsg.className = 'estoque-error-message';
                qtdCell.appendChild(errorMsg);
            }
            errorMsg.textContent = 'Estoque disponível: ' + estoque;
        } else {
            limparValidacaoEstoque(row);
        }
    }

    // Função para limpar validação de estoque
    function limparValidacaoEstoque(row) {
        const qtdEl = row.querySelector('input[name="item_qtd[]"]');
        const qtdCell = qtdEl ? qtdEl.closest('td') : null;
        if (qtdEl) qtdEl.classList.remove('estoque-invalido');
        if (qtdCell) {
            const errorMsg = qtdCell.querySelector('.estoque-error-message');
            if (errorMsg) errorMsg.remove();
        }
    }

    function bindRow(row) {
        row.querySelectorAll('input').forEach(inp => {
            inp.addEventListener('input', function () {
                calcularDoCarrinho();
                if (inp.name === 'item_qtd[]') {
                    if (row.dataset.estoque) {
                        validarEstoque(row);
                    }
                }
            });
            if (inp.name === 'item_preco[]' || inp.name === 'item_qtd[]' || inp.name === 'item_desconto[]') {
                inp.addEventListener('change', calcularDoCarrinho);
                inp.addEventListener('blur', calcularDoCarrinho);
            }
        });

        const qtdInput = row.querySelector('input[name="item_qtd[]"]');
        if (qtdInput) {
            qtdInput.addEventListener('change', function () {
                if (row.dataset.estoque) {
                    validarEstoque(row);
                }
            });
        }
        const btn = row.querySelector('.btn-remover-item-compra');
        if (btn) btn.addEventListener('click', () => { row.remove(); toggleRemoveButtons(); calcularDoCarrinho(); });

        const tipoSelect = row.querySelector('select[name="item_tipo[]"]');
        const nomeInput = row.querySelector('.item-nome') || row.querySelector('input[name="item_nome[]"]');
        let sugestDiv = row.querySelector('.item-suggestions');
        if (!sugestDiv && nomeInput && nomeInput.parentElement && nomeInput.parentElement.classList.contains('autocomplete-container')) {
            sugestDiv = document.createElement('div');
            sugestDiv.className = 'autocomplete-suggestions item-suggestions';
            sugestDiv.style.display = 'none';
            nomeInput.parentElement.appendChild(sugestDiv);
        }
        function buscarProdutos(query) {
            if (!query || query.length < 2) { if (sugestDiv) { sugestDiv.style.display = 'none'; sugestDiv.innerHTML = ''; } return; }
            if (sugestDiv) {
                sugestDiv.innerHTML = `<div class="autocomplete-loading"><div class="sugg-icon"><i class="fas fa-box"></i></div><div class="skel" style="max-width:180px"></div></div>`;
                sugestDiv.style.display = 'block';
            }
            fetch(`/api/produtos/sugestoes?q=${encodeURIComponent(query)}`)
                .then(r => r.json())
                .then(data => {
                    const itens = data.produtos || [];
                    if (!sugestDiv) return;
                    sugestDiv.innerHTML = '';
                    itens.forEach(item => {
                        const d = document.createElement('div');
                        d.className = 'autocomplete-suggestion';
                        d.innerHTML = `<div class=\"sugg-left\"><span class=\"sugg-icon\"><i class=\"fas fa-box\"></i></span><span class=\"sugg-title\"><strong>${item.nome}</strong></span></div><div class=\"sugg-meta\">${item.estoque !== undefined ? `<span class=\"badge-pill\">Estoque: ${item.estoque}</span>` : ''}</div>`;
                        d.addEventListener('click', () => {
                            nomeInput.value = item.nome; sugestDiv.style.display = 'none';
                            const precoEl = row.querySelector('input[name="item_preco[]"]');
                            if (precoEl && item.preco_venda) { precoEl.value = item.preco_venda; }
                            if (item.estoque !== undefined) {
                                row.dataset.estoque = item.estoque;
                                validarEstoque(row);
                            } else {
                                delete row.dataset.estoque;
                                limparValidacaoEstoque(row);
                            }
                            calcularDoCarrinho();
                        });
                        sugestDiv.appendChild(d);
                    });
                    if (query && (itens.length === 0 || itens.length < 5)) {
                        const createDiv = document.createElement('div');
                        createDiv.className = 'autocomplete-suggestion create-new';
                        createDiv.innerHTML = `<i class="fas fa-plus me-2"></i><strong>Criar produto: "${query}"</strong><br><small class="text-muted">Será criado ao salvar o registro</small>`;
                        createDiv.addEventListener('click', function () {
                            nomeInput.value = query;
                            sugestDiv.style.display = 'none';
                            calcularDoCarrinho();
                        });
                        sugestDiv.appendChild(createDiv);
                    }
                    sugestDiv.style.display = 'block';
                }).catch(() => { if (sugestDiv) { sugestDiv.style.display = 'none'; } });
        }
        function onNomeInput() {
            if (tipoSelect && tipoSelect.value === 'mercadoria') {
                buscarProdutos((nomeInput?.value || '').trim());
            }
        }
        function toggleAutocomplete() {
            if (!tipoSelect || !nomeInput) return;
            if (tipoSelect.value === 'mercadoria') {
                nomeInput.setAttribute('placeholder', 'Digite o nome do produto');
                if (nomeInput.dataset.autocompleteBound !== 'true') {
                    nomeInput.addEventListener('input', onNomeInput);
                    nomeInput.dataset.autocompleteBound = 'true';
                }
            } else {
                nomeInput.setAttribute('placeholder', 'Descreva o serviço');
                if (sugestDiv) { sugestDiv.style.display = 'none'; sugestDiv.innerHTML = ''; }
                nomeInput.removeEventListener('input', onNomeInput);
                nomeInput.dataset.autocompleteBound = 'false';
            }
        }
        if (tipoSelect) {
            tipoSelect.addEventListener('change', toggleAutocomplete);
            toggleAutocomplete();
        }
        document.addEventListener('click', function (e) {
            if (sugestDiv && !e.target.closest('.autocomplete-container')) {
                sugestDiv.style.display = 'none';
            }
        });

        const btnClear = row.querySelector('.btn-clear-nome');
        if (btnClear && nomeInput) {
            btnClear.addEventListener('click', function (e) {
                e.preventDefault();
                e.stopPropagation();
                nomeInput.value = '';
                if (sugestDiv) {
                    sugestDiv.style.display = 'none';
                    sugestDiv.innerHTML = '';
                }
                calcularDoCarrinho();
            });
        }
    }

    function toggleRemoveButtons() {
        const rows = itensBody.querySelectorAll('.item-row-compra');
        rows.forEach(r => {
            const b = r.querySelector('.btn-remover-item-compra');
            if (b) b.style.display = rows.length > 1 ? '' : 'none';
        });
        if (itensContagem) itensContagem.textContent = String(rows.length);
    }

    // Função para carregar itens do JSON do lançamento
    function carregarItensDoJSON(itens) {
        itens.forEach(function (item, index) {
            var tipoItem = item.tipo || 'mercadoria';

            var tr = document.createElement('tr');
            tr.className = 'item-row-compra';
            tr.innerHTML = `
                <td>
                    <select class="form-select form-select-sm" name="item_tipo[]">
                        <option value="mercadoria" ${tipoItem === 'mercadoria' ? 'selected' : ''}>Produto</option>
                        <option value="servico" ${tipoItem === 'servico' ? 'selected' : ''}>Serviço</option>
                    </select>
                </td>
                <td>
                    <div class="d-flex align-items-start gap-2">
                        <div class="autocomplete-container flex-grow-1">
                            <input type="text" class="form-control form-control-sm item-nome" name="item_nome[]" value="${item.nome || ''}" placeholder="Digite o nome do produto" required>
                            <div class="autocomplete-suggestions item-suggestions" style="display:none;"></div>
                        </div>
                        <button type="button" class="btn btn-outline-secondary btn-sm input-clear-btn btn-clear-nome" title="Limpar campo" data-bs-toggle="tooltip">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <small class="text-muted d-block mt-1">Observações adicionais (opcional)</small>
                    <input type="text" class="form-control form-control-sm mt-1" name="item_obs[]" placeholder="">
                </td>
                <td class="text-end">
                    <input type="number" step="0.01" min="0" class="form-control form-control-sm text-end" name="item_preco[]" value="${(item.preco || 0).toFixed(2)}" inputmode="decimal" required>
                </td>
                <td class="text-center">
                    <input type="number" min="1" class="form-control form-control-sm text-center" name="item_qtd[]" value="${item.qtd || 1}" required>
                </td>
                <td class="text-end">
                    <input type="number" step="0.01" min="0" class="form-control form-control-sm text-end" name="item_desconto[]" value="${(item.desconto || 0).toFixed(2)}" inputmode="decimal">
                </td>
                <td class="text-end">
                    <input type="text" class="form-control form-control-sm text-end" name="item_total[]" value="0.00" readonly style="background-color: #f8f9fa; padding-right: 2rem;">
                    <button type="button" class="carrinho-remove-btn btn-remover-item-compra" title="Remover item do carrinho" data-bs-toggle="tooltip" style="${itens.length === 1 ? 'display:none;' : ''}">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            itensBody.appendChild(tr);
            bindRow(tr);  // Adicionar event listeners
        });

        // Recalcular valores após carregar
        setTimeout(calcularDoCarrinho, 100);
    }

    // Função para carregar dados existentes da compra no carrinho
    function carregarDadosExistentes() {
        if (!itensBody || !compraData.produto) return;

        // Limpar itens existentes
        itensBody.innerHTML = '';

        // PRIORIDADE: Se tem itens_carrinho do lançamento, usar esses (dados mais precisos)
        try {
            var itensCarrinhoJSON = '{{ itens_carrinho_json|safe }}';
            var itensCarrinho = JSON.parse(itensCarrinhoJSON);
            if (itensCarrinho && itensCarrinho.length > 0) {
                // Carregar do JSON do lançamento
                carregarItensDoJSON(itensCarrinho);
                return;
            }
        } catch (e) {
            console.error('Erro ao fazer parse do itens_carrinho:', e);
        }

        // FALLBACK: Dividir produto por vírgula se houver múltiplos itens
        var produtos = compraData.produto.split(',').map(function (p) { return p.trim(); });
        var valorUnitario = compraData.preco_custo || (compraData.valor / (compraData.quantidade || 1));

        produtos.forEach(function (produtoNome, index) {
            var tipoItem = compraData.tipo_compra || 'mercadoria';

            var tr = document.createElement('tr');
            tr.className = 'item-row-compra';
            tr.innerHTML = `
                <td>
                    <select class="form-select form-select-sm" name="item_tipo[]">
                        <option value="mercadoria" ${tipoItem === 'mercadoria' ? 'selected' : ''}>Produto</option>
                        <option value="servico" ${tipoItem === 'servico' ? 'selected' : ''}>Serviço</option>
                    </select>
                </td>
                <td>
                    <div class="d-flex align-items-start gap-2">
                        <div class="autocomplete-container flex-grow-1">
                            <input type="text" class="form-control form-control-sm item-nome" name="item_nome[]" value="${produtoNome}" placeholder="Digite o nome do produto" required>
                            <div class="autocomplete-suggestions item-suggestions" style="display:none;"></div>
                        </div>
                        <button type="button" class="btn btn-outline-secondary btn-sm input-clear-btn btn-clear-nome" title="Limpar campo" data-bs-toggle="tooltip">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <small class="text-muted d-block mt-1">Observações adicionais (opcional)</small>
                    <input type="text" class="form-control form-control-sm mt-1" name="item_obs[]" placeholder="">
                </td>
                <td class="text-end">
                    <input type="number" step="0.01" min="0" class="form-control form-control-sm text-end" name="item_preco[]" value="${valorUnitario.toFixed(2)}" inputmode="decimal" required>
                </td>
                <td class="text-center">
                    <input type="number" min="1" class="form-control form-control-sm text-center" name="item_qtd[]" value="${compraData.quantidade || 1}" required>
                </td>
                <td class="text-end">
                    <input type="number" step="0.01" min="0" class="form-control form-control-sm text-end" name="item_desconto[]" value="0.00" inputmode="decimal">
                </td>
                <td class="text-end">
                    <input type="text" class="form-control form-control-sm text-end" name="item_total[]" value="0.00" readonly style="background-color: #f8f9fa; padding-right: 2rem;">
                    <button type="button" class="carrinho-remove-btn btn-remover-item-compra" title="Remover item do carrinho" data-bs-toggle="tooltip" style="${produtos.length > 1 ? '' : 'display:none;'}">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>`;
            itensBody.appendChild(tr);
            bindRow(tr);
        });

        // Se não há produtos, criar uma linha vazia
        if (produtos.length === 0) {
            adicionarItemCompra();
        }

        toggleRemoveButtons();
        calcularDoCarrinho();
    }

    // Função para adicionar novo item
    function adicionarItemCompra() {
        if (!itensBody) return;
        const tr = document.createElement('tr');
        tr.className = 'item-row-compra';
        tr.innerHTML = `
            <td>
                <select class="form-select form-select-sm" name="item_tipo[]">
                    <option value="mercadoria" selected>Produto</option>
                    <option value="servico">Serviço</option>
                </select>
            </td>
            <td>
                <div class="d-flex align-items-start gap-2">
                    <div class="autocomplete-container flex-grow-1">
                        <input type="text" class="form-control form-control-sm item-nome" name="item_nome[]" placeholder="Digite o nome do produto" required>
                        <div class="autocomplete-suggestions item-suggestions" style="display:none;"></div>
                    </div>
                    <button type="button" class="btn btn-outline-secondary btn-sm input-clear-btn btn-clear-nome" title="Limpar campo" data-bs-toggle="tooltip">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <small class="text-muted d-block mt-1">Observações adicionais (opcional)</small>
                <input type="text" class="form-control form-control-sm mt-1" name="item_obs[]" placeholder="">
            </td>
            <td class="text-end">
                <input type="number" step="0.01" min="0" class="form-control form-control-sm text-end" name="item_preco[]" value="0.00" inputmode="decimal" required>
            </td>
            <td class="text-center">
                <input type="number" min="1" class="form-control form-control-sm text-center" name="item_qtd[]" value="1" required>
            </td>
            <td class="text-end">
                <input type="number" step="0.01" min="0" class="form-control form-control-sm text-end" name="item_desconto[]" value="0.00" inputmode="decimal">
            </td>
            <td class="text-end">
                <input type="text" class="form-control form-control-sm text-end" name="item_total[]" value="0.00" readonly style="background-color: #f8f9fa; padding-right: 2rem;">
                <button type="button" class="carrinho-remove-btn btn-remover-item-compra" title="Remover item do carrinho" data-bs-toggle="tooltip">
                    <i class="fas fa-trash"></i>
                </button>
            </td>`;
        itensBody.appendChild(tr);
        bindRow(tr);

        if (window.bootstrap && bootstrap.Tooltip) {
            const tooltips = tr.querySelectorAll('[data-bs-toggle="tooltip"]');
            tooltips.forEach(function (el) {
                try {
                    new bootstrap.Tooltip(el);
                } catch (e) {
                    console.warn('Erro ao inicializar tooltip:', e);
                }
            });
        }

        toggleRemoveButtons();
        calcularDoCarrinho();
    }

    // Event listener para o botão adicionar item
    if (btnAdd) {
        btnAdd.addEventListener('click', function (e) {
            e.preventDefault();
            e.stopPropagation();
            adicionarItemCompra();
        });
    }

    // Bind inicial da primeira linha
    const firstRow = itensBody ? itensBody.querySelector('.item-row-compra') : null;
    if (firstRow) {
        bindRow(firstRow);
        toggleRemoveButtons();
    }

    if (numeroParcelasInput) {
        numeroParcelasInput.addEventListener('input', function () {
            const totalOperacaoInput = document.getElementById('total_operacao');
            const total = totalOperacaoInput && totalOperacaoInput.value
                ? parseValorMonetario(totalOperacaoInput.value)
                : 0;
            calcularValorParcela(total);
            toggleConfigParcelas();
            gerarTabelaParcelas();
        });
    }

    // Mostrar/ocultar campos de parcelas baseado no tipo de pagamento
    if (tipoPagamentoSelect) {
        tipoPagamentoSelect.addEventListener('change', function () {
            const isParcelado = this.value === 'parcelado';
            if (numeroParcelasInput) {
                numeroParcelasInput.disabled = !isParcelado;
                if (!isParcelado) {
                    numeroParcelasInput.value = '1';
                }
            }
            const totalOperacaoInput = document.getElementById('total_operacao');
            const total = totalOperacaoInput && totalOperacaoInput.value
                ? parseValorMonetario(totalOperacaoInput.value)
                : 0;
            calcularValorParcela(total);
            toggleConfigParcelas();
            gerarTabelaParcelas();
        });
    }

    // Event listeners para configuração de parcelas
    if (primeiraParcelaInput) {
        primeiraParcelaInput.addEventListener('input', gerarTabelaParcelas);
        primeiraParcelaInput.addEventListener('change', gerarTabelaParcelas);
    }

    if (intervaloParcelasSelect) {
        intervaloParcelasSelect.addEventListener('change', function () {
            const campoPersonalizado = document.getElementById('campo_intervalo_personalizado');
            const isPersonalizado = this.value === 'personalizado';
            if (campoPersonalizado) {
                campoPersonalizado.style.display = isPersonalizado ? 'block' : 'none';
            }
            gerarTabelaParcelas();
        });
    }

    // Event listener para intervalo personalizado
    const intervaloDiasInput = document.getElementById('intervalo_dias');
    if (intervaloDiasInput) {
        intervaloDiasInput.addEventListener('input', function () {
            const valor = parseInt(this.value);
            if (valor < 1) {
                this.value = 1;
            } else if (valor > 365) {
                this.value = 365;
            }
            gerarTabelaParcelas();
        });
    }

    // Adicionar listener para o botão de salvar
    var btnSalvar = document.getElementById('btn-salvar-compra');
    var form = document.querySelector('form');
    if (btnSalvar) {
        btnSalvar.addEventListener('click', function (e) {
            e.preventDefault();
            if (form && form.checkValidity()) {
                btnSalvar.disabled = true;
                btnSalvar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';
                form.submit();
            } else {
                form.reportValidity();
                btnSalvar.disabled = false;
                btnSalvar.innerHTML = '<i class="fas fa-save"></i> Salvar Alterações';
            }
        });
    }

    // Adicionar listener para o formulário
    if (form) {
        form.addEventListener('submit', function (e) {
            var camposObrigatorios = form.querySelectorAll('[required]');
            var valido = true;
            camposObrigatorios.forEach(function (campo) {
                if (!campo.value || campo.value.trim() === '') {
                    valido = false;
                    campo.classList.add('is-invalid');
                } else {
                    campo.classList.remove('is-invalid');
                }
            });
            if (!valido) {
                e.preventDefault();
                if (btnSalvar) {
                    btnSalvar.disabled = false;
                    btnSalvar.innerHTML = '<i class="fas fa-save"></i> Salvar Alterações';
                }
                alert('Por favor, preencha todos os campos obrigatórios.');
                return false;
            }
        });
    }

    // Inicializar
    carregarDadosExistentes();
    calcularDoCarrinho();
    toggleConfigParcelas();

    // Garantir que o valor da parcela seja calculado na inicialização
    const totalOperacaoInput = document.getElementById('total_operacao');
    if (totalOperacaoInput && totalOperacaoInput.value) {
        const total = parseValorMonetario(totalOperacaoInput.value);
        calcularValorParcela(total);
    }

    // Garantir que a tabela seja gerada se já houver dados
    if (tipoPagamentoSelect && tipoPagamentoSelect.value === 'parcelado') {
        const numeroParcelas = parseInt(numeroParcelasInput.value) || 1;
        if (numeroParcelas > 1 && primeiraParcelaInput && primeiraParcelaInput.value) {
            gerarTabelaParcelas();
        }
    }

    // Inicializar estado do campo de parcelas baseado no tipo de pagamento
    if (tipoPagamentoSelect && numeroParcelasInput) {
        const isParcelado = tipoPagamentoSelect.value === 'parcelado';
        numeroParcelasInput.disabled = !isParcelado;
        if (!isParcelado) {
            numeroParcelasInput.value = '1';
        }
    }

    // Inicializar tooltips globais
    if (window.bootstrap && bootstrap.Tooltip) {
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.forEach(el => new bootstrap.Tooltip(el));
    }

    console.log('✅ JavaScript inicializado com sucesso');
});
</script>
{% endblock %}