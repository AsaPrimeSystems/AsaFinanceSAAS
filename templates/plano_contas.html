{% extends "base.html" %}

{% block title %}Plano de Contas - Sistema de Gest√£o Financeira{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4><i class="fas fa-list"></i> Plano de Contas</h4>
                    <a href="{{ url_for('nova_conta') }}" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Nova Conta
                    </a>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <h5><i class="fas fa-arrow-up"></i> Contas de Receita</h5>
                                </div>
                                <div class="card-body">
                                    {% if contas_receita %}
                                        <div class="table-responsive">
                                            <table class="table table-striped pc-table">
                                                <colgroup>
                                                    <col style="width: 40%">
                                                    <col style="width: 40%">
                                                    <col style="width: 20%">
                                                </colgroup>
                                                <thead>
                                                    <tr>
                                                        <th class="text-uppercase small text-muted">Nome</th>
                                                        <th class="text-uppercase small text-muted">Descri√ß√£o</th>
                                                        <th class="text-uppercase small text-muted text-center">A√ß√µes</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for conta in contas_receita %}
                                                    <tr>
                                                        <td>
                                                            <span class="badge rounded-pill bg-light text-dark border px-3 py-2">{{ conta.nome }}</span>
                                                        </td>
                                                        <td class="text-truncate" title="{{ conta.descricao or '-' }}">{{ conta.descricao or '-' }}</td>
                                                        <td class="text-center">
                                                            <div class="btn-group" role="group">
                                                                <a href="{{ url_for('editar_conta', conta_id=conta.id) }}" 
                                                                   class="btn btn-sm btn-primary" 
                                                                   title="Editar">
                                                                    <i class="fas fa-edit"></i>
                                                                </a>
                                                                <button type="button"
                                                                        class="btn btn-sm btn-danger"
                                                                        title="Deletar"
                                                                        data-bs-toggle="modal"
                                                                        data-bs-target="#modalConfirmacaoExclusao"
                                                                        data-conta-id="{{ conta.id }}"
                                                                        data-conta-nome="{{ conta.nome }}"
                                                                        >
                                                                    <i class="fas fa-trash"></i>
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    {% else %}
                                        <p class="text-muted">Nenhuma conta de receita cadastrada.</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-danger text-white">
                                    <h5><i class="fas fa-arrow-down"></i> Contas de Despesa</h5>
                                </div>
                                <div class="card-body">
                                    {% if contas_despesa %}
                                        <div class="table-responsive">
                                            <table class="table table-striped pc-table">
                                                <colgroup>
                                                    <col style="width: 40%">
                                                    <col style="width: 40%">
                                                    <col style="width: 20%">
                                                </colgroup>
                                                <thead>
                                                    <tr>
                                                        <th class="text-uppercase small text-muted">Nome</th>
                                                        <th class="text-uppercase small text-muted">Descri√ß√£o</th>
                                                        <th class="text-uppercase small text-muted text-center">A√ß√µes</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for conta in contas_despesa %}
                                                    <tr>
                                                        <td>
                                                            <span class="badge rounded-pill bg-light text-dark border px-3 py-2">{{ conta.nome }}</span>
                                                        </td>
                                                        <td class="text-truncate" title="{{ conta.descricao or '-' }}">{{ conta.descricao or '-' }}</td>
                                                        <td class="text-center">
                                                            <div class="btn-group" role="group">
                                                                <a href="{{ url_for('editar_conta', conta_id=conta.id) }}" 
                                                                   class="btn btn-sm btn-primary" 
                                                                   title="Editar">
                                                                    <i class="fas fa-edit"></i>
                                                                </a>
                                                                <button type="button"
                                                                        class="btn btn-sm btn-danger"
                                                                        title="Deletar"
                                                                        data-bs-toggle="modal"
                                                                        data-bs-target="#modalConfirmacaoExclusao"
                                                                        data-conta-id="{{ conta.id }}"
                                                                        data-conta-nome="{{ conta.nome }}"
                                                                        >
                                                                    <i class="fas fa-trash"></i>
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    {% else %}
                                        <p class="text-muted">Nenhuma conta de despesa cadastrada.</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirma√ß√£o de Exclus√£o -->
<div class="modal fade" id="modalConfirmacaoExclusao" tabindex="-1" aria-labelledby="modalConfirmacaoExclusaoLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form id="formExcluirConta" method="POST">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalConfirmacaoExclusaoLabel">
                        <i class="fas fa-exclamation-triangle me-2 text-warning"></i>Confirmar Exclus√£o
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <p id="mensagemConfirmacao">Tem certeza que deseja excluir esta conta? Esta a√ß√£o n√£o pode ser desfeita.</p>
                </div>
                <div class="modal-footer">
                   <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                   <button type="submit" class="btn btn-danger" data-no-intercept="true">
                        <i class="fas fa-trash me-1"></i>Excluir
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
/* Ajustes visuais para alinhamento consistente */
.pc-table { table-layout: fixed; }
.pc-table td, .pc-table th { vertical-align: middle; }
.pc-table .text-truncate { max-width: 100%; }
</style>
<script>
console.log('üîç Script plano_contas.html carregado');

document.addEventListener('DOMContentLoaded', function() {
    console.log('üîç DOMContentLoaded - Iniciando configura√ß√£o do modal');
    
    const modalElement = document.getElementById('modalConfirmacaoExclusao');
    const formExcluir = document.getElementById('formExcluirConta');
    const mensagem = document.getElementById('mensagemConfirmacao');

    console.log('üîç Elementos encontrados:', {
        modalElement: !!modalElement,
        formExcluir: !!formExcluir,
        mensagem: !!mensagem
    });

    if (!modalElement || !formExcluir) {
        console.error('‚ùå Elementos do modal n√£o encontrados!');
        return;
    }

    // Garantir que o modal seja inicializado corretamente pelo Bootstrap
    let modalInstance = bootstrap.Modal.getInstance(modalElement);
    if (!modalInstance) {
        console.log('üîß Criando nova inst√¢ncia do modal Bootstrap');
        modalInstance = new bootstrap.Modal(modalElement, {
            backdrop: true,
            keyboard: true,
            focus: true
        });
    } else {
        console.log('‚úÖ Inst√¢ncia do modal j√° existe');
    }

    // Log quando o modal for aberto
    modalElement.addEventListener('show.bs.modal', function (event) {
        console.log('üìã Evento show.bs.modal disparado');
        console.log('üìã Event relatedTarget:', event.relatedTarget);
        
        const botao = event.relatedTarget;
        const contaId = botao?.getAttribute('data-conta-id');
        const contaNome = botao?.getAttribute('data-conta-nome') || '';

        console.log('üìã Dados do bot√£o:', { contaId, contaNome });

        if (contaId) {
            formExcluir.action = `/plano-contas/${contaId}/deletar`;
            console.log('‚úÖ Action do form definido:', formExcluir.action);
        }

        if (mensagem) {
            mensagem.textContent = `Tem certeza que deseja excluir a conta "${contaNome}"? Esta a√ß√£o n√£o pode ser desfeita.`;
            console.log('‚úÖ Mensagem atualizada');
        }

        // Verificar z-index antes de mostrar
        console.log('üîç Z-index antes de mostrar:', {
            modal: window.getComputedStyle(modalElement).zIndex,
            header: document.querySelector('.modern-header') ? window.getComputedStyle(document.querySelector('.modern-header')).zIndex : 'n√£o encontrado'
        });
    });

    // CORRE√á√ÉO CR√çTICA: Quando o modal estiver totalmente vis√≠vel
    modalElement.addEventListener('shown.bs.modal', function () {
        console.log('‚úÖ Modal totalmente vis√≠vel (shown.bs.modal)');
        console.log('üîç Aplicando corre√ß√µes...');
        
        // 1. Verificar e remover backdrops duplicados
        const backdrops = document.querySelectorAll('.modal-backdrop');
        console.log('üîç Backdrops encontrados:', backdrops.length);
        if (backdrops.length > 1) {
            console.warn('‚ö†Ô∏è M√∫ltiplos backdrops detectados, removendo extras');
            for (let i = 1; i < backdrops.length; i++) {
                console.log('üóëÔ∏è Removendo backdrop duplicado:', i);
                backdrops[i].remove();
            }
        }
        
        // 2. Verificar z-index de todos os elementos
        const backdrop = document.querySelector('.modal-backdrop');
        const modalDialog = modalElement.querySelector('.modal-dialog');
        const modalContent = modalElement.querySelector('.modal-content');
        const header = document.querySelector('.modern-header');
        
        console.log('üîç Z-index atual dos elementos:', {
            modal: window.getComputedStyle(modalElement).zIndex,
            backdrop: backdrop ? window.getComputedStyle(backdrop).zIndex : 'n√£o encontrado',
            dialog: modalDialog ? window.getComputedStyle(modalDialog).zIndex : 'n√£o encontrado',
            content: modalContent ? window.getComputedStyle(modalContent).zIndex : 'n√£o encontrado',
            header: header ? window.getComputedStyle(header).zIndex : 'n√£o encontrado'
        });
        
        // 3. Garantir z-index correto do modal (valores aumentados)
        modalElement.style.zIndex = '1060';
        console.log('‚úÖ Modal z-index definido para 1060');
        
        if (modalDialog) {
            modalDialog.style.zIndex = '1061';
            console.log('‚úÖ Modal-dialog z-index definido para 1061');
        }
        
        if (modalContent) {
            modalContent.style.zIndex = '1062';
            modalContent.style.pointerEvents = 'auto';
            console.log('‚úÖ Modal-content z-index definido para 1062, pointer-events: auto');
        }
        
        // 4. CR√çTICO: SOLU√á√ÉO DEFINITIVA - backdrop n√£o deve bloquear cliques
        if (backdrop) {
            backdrop.style.zIndex = '1050';
            backdrop.style.pointerEvents = 'none'; // N√ÉO bloquear cliques
            console.log('‚úÖ Backdrop z-index definido para 1050');
            console.log('‚úÖ Backdrop pointer-events definido para NONE - n√£o bloqueia mais cliques');
            
            // Adicionar listener no document para detectar cliques no backdrop
            // (j√° que o backdrop n√£o recebe mais cliques diretamente)
            const backdropClickHandler = function(e) {
                // Verificar se o clique foi no backdrop (n√£o no modal)
                if (e.target === backdrop || backdrop.contains(e.target)) {
                    // Verificar se o clique N√ÉO foi no modal
                    if (!modalElement.contains(e.target)) {
                        console.log('üñ±Ô∏è Clique no backdrop detectado - fechando modal');
                        const bsModal = bootstrap.Modal.getInstance(modalElement);
                        if (bsModal) {
                            bsModal.hide();
                        }
                        // Remover listener quando o modal fechar
                        document.removeEventListener('click', backdropClickHandler, true);
                    }
                }
            };
            
            // Adicionar listener no document (capture phase) para pegar cliques no backdrop
            document.addEventListener('click', backdropClickHandler, true);
            
            // Remover listener quando o modal fechar
            modalElement.addEventListener('hidden.bs.modal', function() {
                document.removeEventListener('click', backdropClickHandler, true);
            }, { once: true });
        }
        
        // 4.5 CR√çTICO: Garantir que o modal esteja REALMENTE acima do backdrop
        // Aumentar z-index do modal para garantir que fique acima
        const modalComputedZIndex = parseInt(window.getComputedStyle(modalElement).zIndex);
        const backdropComputedZIndex = backdrop ? parseInt(window.getComputedStyle(backdrop).zIndex) : 0;
        
        console.log('üîç Compara√ß√£o de z-index:', {
            modal: modalComputedZIndex,
            backdrop: backdropComputedZIndex,
            diferenca: modalComputedZIndex - backdropComputedZIndex
        });
        
        // For√ßar z-index muito maior para garantir que o modal fique acima
        modalElement.style.zIndex = '1060';
        if (modalDialog) modalDialog.style.zIndex = '1061';
        if (modalContent) modalContent.style.zIndex = '1062';
        console.log('‚úÖ Z-index do modal aumentado para garantir que fique acima do backdrop');
        
        // 5. Verificar pointer-events de todos os elementos do modal
        const allModalElements = modalElement.querySelectorAll('*');
        console.log('üîç Total de elementos no modal:', allModalElements.length);
        
        let elementsWithPointerEventsNone = 0;
        allModalElements.forEach(el => {
            const computedStyle = window.getComputedStyle(el);
            if (computedStyle.pointerEvents === 'none') {
                elementsWithPointerEventsNone++;
                console.warn('‚ö†Ô∏è Elemento com pointer-events: none encontrado:', el.tagName, el.className);
            }
            el.style.pointerEvents = 'auto';
        });
        
        if (elementsWithPointerEventsNone > 0) {
            console.warn(`‚ö†Ô∏è ${elementsWithPointerEventsNone} elementos tinham pointer-events: none, corrigidos`);
        }
        
        // 6. Garantir que bot√µes sejam clic√°veis
        const buttons = modalElement.querySelectorAll('button, .btn, input, select, textarea, a, .btn-close');
        console.log('üîç Bot√µes encontrados no modal:', buttons.length);
        
        buttons.forEach((el, index) => {
            const before = {
                pointerEvents: window.getComputedStyle(el).pointerEvents,
                cursor: window.getComputedStyle(el).cursor,
                zIndex: window.getComputedStyle(el).zIndex
            };
            
            el.style.pointerEvents = 'auto';
            el.style.cursor = 'pointer';
            el.style.zIndex = '1058';
            el.style.position = 'relative';
            
            const after = {
                pointerEvents: el.style.pointerEvents,
                cursor: el.style.cursor,
                zIndex: el.style.zIndex
            };
            
            console.log(`‚úÖ Bot√£o ${index + 1} (${el.tagName}):`, {
                antes: before,
                depois: after,
                texto: el.textContent?.trim().substring(0, 30) || el.value || 'sem texto'
            });
        });
        
        // 7. Verificar se h√° elementos sobrepondo o modal
        const modalRect = modalElement.getBoundingClientRect();
        console.log('üîç Posi√ß√£o do modal:', {
            top: modalRect.top,
            left: modalRect.left,
            width: modalRect.width,
            height: modalRect.height
        });
        
        // Verificar elementos que podem estar sobrepondo
        const allElements = document.elementsFromPoint(
            modalRect.left + modalRect.width / 2,
            modalRect.top + modalRect.height / 2
        );
        
        console.log('üîç Elementos no centro do modal (do topo para baixo):');
        allElements.forEach((el, index) => {
            const style = window.getComputedStyle(el);
            console.log(`  ${index + 1}. ${el.tagName}${el.className ? '.' + el.className.split(' ').join('.') : ''}`, {
                zIndex: style.zIndex,
                pointerEvents: style.pointerEvents,
                position: style.position
            });
        });
        
        console.log('‚úÖ Todas as corre√ß√µes aplicadas ao modal');
    });

    // Log quando o modal for fechado
    modalElement.addEventListener('hidden.bs.modal', function () {
        console.log('üîí Modal fechado (hidden.bs.modal)');
        // Limpar estilos inline quando fechar
        modalElement.style.zIndex = '';
        const modalDialog = modalElement.querySelector('.modal-dialog');
        if (modalDialog) modalDialog.style.zIndex = '';
        const modalContent = modalElement.querySelector('.modal-content');
        if (modalContent) modalContent.style.zIndex = '';
    });

    // Adicionar listener de clique para debug e garantir que cliques funcionem
    modalElement.addEventListener('click', function(e) {
        console.log('üñ±Ô∏è Clique detectado no modal:', {
            target: e.target.tagName + (e.target.className ? '.' + e.target.className.split(' ').join('.') : ''),
            currentTarget: e.currentTarget.tagName,
            pointerEvents: window.getComputedStyle(e.target).pointerEvents,
            zIndex: window.getComputedStyle(e.target).zIndex,
            isButton: e.target.tagName === 'BUTTON' || e.target.closest('button'),
            buttonText: e.target.textContent?.trim() || e.target.closest('button')?.textContent?.trim()
        });
        
        // Se o clique foi em um bot√£o, garantir que o evento n√£o seja bloqueado
        if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
            const button = e.target.tagName === 'BUTTON' ? e.target : e.target.closest('button');
            console.log('‚úÖ Clique em bot√£o detectado:', button.textContent?.trim());
            // N√£o fazer preventDefault - deixar o bot√£o funcionar normalmente
        }
    }, true); // Usar capture phase para pegar todos os cliques
    
    // Adicionar listener tamb√©m no document para capturar cliques que podem estar sendo bloqueados
    document.addEventListener('click', function(e) {
        // Se o clique foi em um bot√£o dentro do modal
        if (modalElement.classList.contains('show')) {
            const clickedButton = e.target.closest('.modal button');
            if (clickedButton) {
                console.log('üñ±Ô∏è Clique em bot√£o do modal detectado via document listener:', clickedButton.textContent?.trim());
                // O evento j√° est√° no bot√£o correto, n√£o precisa fazer nada
                console.log('‚úÖ Clique j√° est√° no bot√£o correto');
            }
        }
    }, true);

    console.log('‚úÖ Configura√ß√£o do modal conclu√≠da');
});
</script>
{% endblock %} 